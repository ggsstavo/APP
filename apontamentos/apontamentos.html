<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Estrutura | Apontamentos</title>

  <!-- Fonte + Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <!-- favicon (preserve suas paths) -->
  <link rel="icon" type="image/png" href="../favicon/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="../favicon/favicon.svg" />
  <link rel="shortcut icon" href="../favicon/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="../favicon/apple-touch-icon.png" />
  <link rel="manifest" href="../favicon/site.webmanifest" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <img id="companyLogo" src="../favicon/detroit-brasil.png" style="display:none" />



  <style>
    /* ---- THEME (match luxo) ---- */
    :root{
      --bg: #0b0c0f;
      --card: rgba(255,255,255,0.04);
      --glass: rgba(255,255,255,0.03);
      --accent: #9fccb1;
      --accent-strong: #3b82f6;
      --secondary: #39666b;
      --text: #e1efe6;
      --muted: rgba(225,239,230,0.62);
      --soft-border: rgba(255,255,255,0.04);
      --btn-grad: linear-gradient(135deg,#4f46e5,#7c3aed);
      --radius: 12px;
      --sidebar-w:260px;
    }

    /* reset / base */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Inter',system-ui,Arial;
      background-color:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.35;
    }

    /* ===== SIDEBAR ===== */
    .sidebar {
      --bg-sidebar: #0b150f;
      --card-sidebar: rgba(255, 255, 255, 0.06);
      --glass-sidebar: rgba(255, 255, 255, 0.04);
      --accent-sidebar: #9fccb1;
      --secondary-sidebar: #39666b;
      --text-sidebar: #e1efe6;
      --muted-sidebar: rgba(225, 239, 230, 0.6);
      --neumo-shadow-sidebar: 10px 10px 20px rgba(0, 0, 0, 0.6), -6px -6px 16px rgba(255, 255, 255, 0.02);
      --radius-sidebar: 14px;
    }

    /* Sidebar styles (copiado - mantive exatamente) */
    .sidebar {
      width: 260px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
      color: var(--text-sidebar);
      padding: 20px 0;
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      z-index: 60;
      backdrop-filter: blur(8px) saturate(120%);
      border-right: 1px solid rgba(255, 255, 255, 0.03);
      overflow-y: auto;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      position: relative;
      padding: 0 20px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
      margin-bottom: 20px;
    }

    .brand {
      display: flex;
      gap: 14px;
      align-items: center;
    }

    .logo {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--accent-sidebar), var(--secondary-sidebar));
      box-shadow: var(--neumo-shadow-sidebar);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      color: white;
      font-size: 18px;
    }

    .brand-text h1 {
      font-size: 16px;
      margin: 0;
      color: var(--text-sidebar);
      font-weight: 600;
    }

    .brand-text p {
      margin: 0;
      font-size: 12px;
      opacity: 0.75;
      color: var(--muted-sidebar);
    }

    .hamburger {
      display: none;
      background: var(--glass-sidebar);
      border: 1px solid rgba(255, 255, 255, 0.02);
      border-radius: 10px;
      color: var(--muted-sidebar);
      font-size: 18px;
      width: 44px;
      height: 44px;
      position: absolute;
      left: 15px;
      cursor: pointer;
      align-items: center;
      justify-content: center;
    }

    nav ul {
      list-style: none;
      padding: 0 12px;
    }

    nav ul li {
      margin: 8px 0;
    }

    nav ul li a {
      text-decoration: none;
      color: var(--muted-sidebar);
      display: flex;
      align-items: center;
      padding: 10px 14px;
      border-radius: 10px;
      transition: all 0.2s;
      font-weight: 500;
      font-size: 14px;
    }

    nav ul li a i {
      margin-right: 12px;
      width: 20px;
      text-align: center;
    }

    nav ul li a:hover,
    nav ul li a.active {
      color: var(--text-sidebar);
      background: rgba(255, 255, 255, 0.03);
    }

    /* Botão de Observa+ com estilo especial */
    nav ul li:nth-child(1) a {
      background: linear-gradient(135deg, var(--accent-sidebar), var(--secondary-sidebar));
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: 0 12px 40px rgba(70, 229, 123, 0.12), inset 0 -6px 18px rgba(255, 255, 255, 0.02);
      margin-top: 15px;
    }

    nav ul li:nth-child(1) a:hover {
      filter: brightness(1.08);
      box-shadow: 0 2px 80px rgba(70, 229, 150, 0.18), -4px -4px 10px rgba(58, 237, 133, 0.04);
    }
    
    /* Ícone branco para o botão gradiente em desktop também */
    nav ul li:nth-child(1) a i {
      color: white;
    }

    /* ----- MAIN AREA ----- */
    .main {
      margin-left: var(--sidebar-w);
      max-width: var(--max-width);
      padding: 28px 20px;
      box-sizing: border-box;
    }

    header.topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding:12px 16px; border-radius:12px; border:1px solid var(--soft-border);
      box-shadow: 0 6px 22px rgba(0,0,0,0.6);
      margin-bottom:16px;
    }
    .topbar h2{ margin:0; font-size:18px; letter-spacing:-0.01em; background: linear-gradient(90deg,#2a6df4,#7345a1); background-clip:text; color:transparent; }
    .topbar .actions{ display:flex; gap:10px; align-items:center }

    .btn-neumo{
      display:inline-flex; align-items:center; gap:10px; padding:10px 14px; border-radius:12px;
      background: var(--btn-grad); color: #fff; font-weight:700; border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 12px 40px rgba(79,70,229,0.12), inset 0 -6px 18px rgba(255,255,255,0.02);
      cursor:pointer; transition: transform .18s, box-shadow .18s;
    }
    .btn-neumo.ghost{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); color: var(--text); box-shadow: 0 6px 18px rgba(0,0,0,0.6); }
    .btn-neumo:disabled{ opacity:0.55; cursor:not-allowed; transform:none; box-shadow:none; }

    /* filters area */
    .filters {
      display:flex; gap:16px; flex-wrap:wrap; align-items:center; margin-bottom:14px;
    }
    label{ color:var(--muted); font-weight:700; font-size:13px; display:block; margin-bottom:6px; }
    select, input[type="date"]{
      padding:10px 12px; border-radius:10px; background: rgba(255,255,255,0.02);
      color:var(--text); border:1px solid var(--soft-border); outline:none; font-size:14px; height:42px;
    }

    /* report grid */
    #reportContainer {
      display:grid;
      grid-template-columns: repeat( auto-fit, minmax(320px, 1fr) );
      gap:18px;
      align-items:start;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px; padding:0; border:1px solid var(--soft-border); box-shadow: 0 10px 30px rgba(0,0,0,0.6);
      overflow:hidden;
      display:flex; flex-direction:column;
    }
    .card-header{
      background: linear-gradient(90deg, rgba(79,70,229,0.12), rgba(124,58,237,0.08));
      padding:14px 16px;
    }
    .card-header h4{ margin:0; font-size:16px; color:var(--text); }
    .card-header small{ color:var(--muted); display:block; margin-top:6px; font-size:13px; }

    .card-body{ padding:14px 16px; display:flex; flex-direction:column; gap:12px; color:var(--muted); }
    .members-list{ display:flex; flex-direction:column; gap:8px; margin-top:6px; }
    .member-item{ background: rgba(255,255,255,0.02); padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.02); }


    /* responsive */
    @media (max-width:1000px){
      .main{ 
        margin-left: 0;
        margin-top: 80px; /* altura da navbar fechada aumentada */
        padding: 18px; 
        transition: margin-top 0.4s ease; 
      }
      .controls{ grid-template-columns: 1fr; }
      
      .sidebar { 
        width: 100%;
        height: auto;
        min-height: 80px; /* altura maior para melhor visibilidade */
        max-height: 80px;
        position: fixed;
        top: 0;
        left: 0;
        flex-direction: column;
        align-items: stretch;
        padding: 0;
        overflow: hidden;
        transition: max-height 0.4s ease;
        border-right: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08); /* borda mais visível */
        z-index: 1000;
        backdrop-filter: blur(12px) saturate(140%); /* blur mais forte */
      }
      
      .sidebar.active {
        max-height: 520px;
        overflow-y: auto;
      }
      
      .sidebar-header {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        padding: 18px 20px; /* padding maior */
        margin: 0;
        border: none;
        width: 100%;
        min-height: 80px;
        box-sizing: border-box;
      }
      
      .brand {
        flex-direction: row;
        gap: 14px; /* gap maior */
        align-items: center;
      }
      
      .brand-text {
        display: block;
      }
      
      .brand-text h1 {
        font-size: 16px; /* fonte maior */
        font-weight: 700;
        color: var(--text-sidebar);
      }
      
      .brand-text p {
        display: none;
      }
      
      .logo {
        width: 48px; /* logo maior */
        height: 48px;
        font-size: 20px;
        box-shadow: 0 8px 25px rgba(159, 204, 177, 0.15), inset 0 2px 8px rgba(255,255,255,0.05); /* sombra mais visível */
      }
      
      .hamburger {
        display: flex;
        position: static;
        margin: 0;
        order: 2;
        width: 48px; /* botão maior */
        height: 48px;
        font-size: 20px;
        background: rgba(255, 255, 255, 0.06); /* fundo mais visível */
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        color: var(--text-sidebar);
        transition: all 0.3s var(--hover-ease);
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      }
      
      .hamburger:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.4);
      }
      
      .hamburger:active {
        transform: translateY(0);
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      }
      
      #sidebarNav {
        width: 100%;
        padding: 8px 20px 20px;
        box-shadow: none;
        display: block !important;
        opacity: 0;
        transition: opacity 0.3s ease 0.1s;
      }
      
      .sidebar.active #sidebarNav {
        opacity: 1;
      }
      
      nav ul {
        display: flex;
        flex-direction: column;
        gap: 14px; /* gap ainda maior para melhor espaçamento */
        padding: 0;
        margin: 0;
      }
      
      nav ul li {
        margin: 0;
      }
      
      nav ul li a {
        padding: 14px 16px; /* padding maior */
        font-size: 15px; /* fonte ligeiramente maior */
        font-weight: 600; /* peso da fonte maior */
        border-radius: 12px;
        transition: all 0.25s var(--hover-ease);
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.03);
        color: var(--text-sidebar);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      }
      
      nav ul li a i {
        margin-right: 14px; /* margem maior do ícone */
        width: 22px; /* ícones maiores */
        font-size: 16px;
        color: var(--accent-sidebar);
      }
      
      nav ul li a:hover,
      nav ul li a.active {
        position: relative;
  color: #ffffff !important;                    /* texto branco */
  background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
  border-color: rgba(255,255,255,0.14);
  box-shadow: 0 8px 20px rgba(0,0,0,0.35);
  transform: translateX(6px) scale(1.01);
  transition: transform .22s var(--hover-ease), box-shadow .22s var(--hover-ease), background .2s ease;
  width: 95%;
  z-index: 6;
      }

      /* borda lateral colorida — guia visual forte, arredondada */
nav ul li a.active::before{
  content: "";
  position: absolute;
  left: -10px;                /* ajusta a posição para “saltar” levemente */
  top: 8px;
  bottom: 8px;
  width: 6px;
  border-radius: 6px;
  background: linear-gradient(180deg, var(--accent-sidebar), var(--secondary-sidebar));
  box-shadow: 0 6px 18px rgba(60,150,120,0.12), inset 0 -4px 12px rgba(255,255,255,0.03);
}

/* ícone: preenche com cor para reforçar sinal ativo */
nav ul li a.active i {
  color: var(--accent-sidebar) !important;
  filter: drop-shadow(0 4px 14px rgba(0,0,0,0.35));
  transform: translateX(2px);
  transition: transform .18s var(--hover-ease), color .18s;
}

/* acessibilidade: foco visível (keyboard/touch) */
nav ul li a:focus {
  outline: none;
  box-shadow: 0 10px 30px rgba(0,0,0,0.45), 0 0 0 3px rgba(155,204,177,0.06);
  transform: translateX(6px);
}
      
      /* Estilo especial para o botão Observa+ em mobile */
      nav ul li:nth-child(1) a {
        background: linear-gradient(135deg, var(--accent-sidebar), var(--secondary-sidebar));
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: 0 6px 20px rgba(70, 229, 123, 0.2), inset 0 1px 0 rgba(255,255,255,0.1);
        font-weight: 700;
      }
      
      nav ul li:nth-child(1) a i {
        color: white; /* ícone branco para contraste com fundo verde */
      }

      nav ul li:nth-child(1) a:hover {
        filter: brightness(1.1);
        transform: translateX(6px) translateY(-2px);
        box-shadow: 0 8px 25px rgba(70, 229, 150, 0.3);
      }
      
      nav ul li a span {
        display: inline;
        letter-spacing: 0.3px; /* espaçamento das letras */
      }
    }
    /* responsive & centralization of cards on small screens */
    @media (max-width:1000px){
      #reportContainer { grid-template-columns: 1fr; gap:14px; }
      /* center cards as requested (only cards, not internal content) */
      .card { max-width: 880px; margin: 0 auto; }
    }

    /* ===== ACTIVE somente em DESKTOP (telas maiores que 1000px) ===== */
@media (min-width:1001px) {
  /* item ativo na sidebar (desktop) */
  nav ul li a.active {
    position: relative;
    color: var(--text-sidebar) !important;
    background: linear-gradient(180deg, rgba(255,255,255,0.025), rgba(255,255,255,0.01));
    border-radius: 0 10px 10px 0;
    box-shadow: 0 10px 30px rgba(0,0,0,0.45);
    padding-left: 18px;
    transition: background .20s var(--hover-ease), box-shadow .22s var(--hover-ease), transform .18s;
    z-index: 5;
  }

  nav ul li a.active::before {
    content: "";
    position: absolute;
    left: 0;
    top: 8px;
    bottom: 8px;
    width: 8px;
    border-radius: 0 6px 6px 0;
    background: linear-gradient(180deg, var(--accent-sidebar), var(--secondary-sidebar));
    box-shadow: 0 6px 18px rgba(60,150,120,0.12), inset 0 -4px 12px rgba(255,255,255,0.03);
  }

  nav ul li a.active i {
    color: var(--accent-sidebar) !important;
    transform: translateX(2px);
    filter: drop-shadow(0 6px 14px rgba(0,0,0,0.35));
    transition: transform .18s var(--hover-ease), color .18s;
  }

  /* hover leve só no desktop (não afeta mobile) */
  nav ul li a:hover:not(.active) {
    background: rgba(255,255,255,0.02);
    transform: translateX(4px);
    box-shadow: none;
  }

  nav ul li a:focus {
    outline: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 0 4px rgba(155,204,177,0.06);
  }

  /* Botão de Observa+ com estilo especial */
    nav ul li:nth-child(1) a {
      background: linear-gradient(135deg, var(--accent-sidebar), var(--secondary-sidebar)) !important;
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: 0 12px 40px rgba(70, 229, 123, 0.12), inset 0 -6px 18px rgba(255, 255, 255, 0.02);
      margin-top: 15px;
    }

    nav ul li:nth-child(1) a:hover {
      filter: brightness(1.08);
      box-shadow: 0 2px 80px rgba(70, 229, 150, 0.18), -4px -4px 10px rgba(58, 237, 133, 0.04);
    }
    
    /* Ícone branco para o botão gradiente em desktop também */
    nav ul li:nth-child(1) a i {
      color: white;
    }
}
    
    @media (max-width:560px){
      header.topbar{ flex-direction:column; align-items:flex-start; gap:10px }
      .preview .preview-head{ flex-direction:column; align-items:flex-start; gap:8px }
      
      .sidebar-header {
        padding: 16px 18px;
      }
      
      .brand-text h1 {
        font-size: 15px;
      }
      
      .logo {
        width: 44px;
        height: 44px;
        font-size: 18px;
      }
      
      .hamburger {
        width: 44px;
        height: 44px;
        font-size: 18px;
      }
      
      nav ul li a {
        padding: 12px 14px;
        font-size: 14px;
      }
      
      nav ul li a i {
        width: 20px;
        font-size: 15px;
      }
    }

    @media (max-width: 480px) {
      .sidebar.active {
        max-height: 100vh;
      }
      
      .main {
        margin-top: 76px;
      }
      
      .sidebar {
        min-height: 76px;
        max-height: 76px;
      }
      
      .sidebar-header {
        min-height: 76px;
        padding: 14px 16px;
      }
    }

    @media (max-width:420px){
      .main{ padding:12px; }
      .filters{ gap:10px; }
      select, input[type="date"]{ height:40px; padding:9px; font-size:13px; }
      .card{ max-width: 360px; }
    }

    /* small helper */
    .muted-note{ color:var(--muted); font-size:13px; margin-top:8px; }

    /* 1) Forçar aparência escura no select e nas options */
select, .select-like {
  color: var(--text) !important;
  -webkit-appearance: none !important;
  -moz-appearance: none !important;
  appearance: none !important;
}

/* garante que o texto do option também fique escuro ao abrir a lista */
select option {
  background-color: var(--bg) !important; /* cor do fundo do dropdown */
  color: var(--text) !important;
}

/* estado hover/checked nas options (alguns browsers respeitam) */
select option:hover,
select option:checked {
background: var(--accent) !important;
      color: #0b150f !important;
}

/* placeholder option (texto mais claro) */
select option[disabled] {
  color: var(--input-placeholder) !important;
}

/* seta custom (SVG data-uri) — mantém aparência consistente */
select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24'%3E%3Cpath fill='%23e1efe6' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E") !important;
  background-repeat: no-repeat !important;
  background-position: right 12px center !important;
  background-size: 16px 16px !important;
}

/* Edge/IE: remove seta nativa */
select::-ms-expand { display: none; }

/* Firefox: evitar problema do placeholder desaparecer quando focado */
select:-moz-focusring { color: transparent; text-shadow: 0 0 0 var(--text); }

/* ===== SCROLLBAR STYLING ===== */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.02);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(159, 204, 177, 0.3);
      border-radius: 4px;
      transition: background 0.3s ease;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(159, 204, 177, 0.5);
    }

@keyframes slideIn {
  from { transform: translateX(400px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOut {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(400px); opacity: 0; }
}

.card-signature {
  margin-top: 10px;
  align-self: flex-end;
  font-size: 11px;
  color: rgba(225,239,230,0.55);
  letter-spacing: 0.2px;
  user-select: none;
  pointer-events: none;
}
  </style>
</head>
<body>
  <!-- SIDEBAR (exatamente sua versão antiga) -->
  <div class="sidebar" aria-label="Navegação">
    <div class="sidebar-header">
      <div class="brand">
        <div class="logo"><img src="../favicon/favicon.svg" alt="" style="width: 75%;"></div>
        <div class="brand-text">
          <h1>Estrutura</h1>
          <p>Apontamentos</p>
        </div>
      </div>
      <button id="toggleMenu" class="hamburger" aria-label="Abrir menu">
        <i class="fas fa-bars"></i>
      </button>
    </div>
    <nav id="sidebarNav">
      <ul id="menuList">
        <li>
          <a href="../dashboard.html">
            <i class="fas fa-file-signature"></i><span>Apropriações</span>
          </a>
        </li>
        <li>
          <a href="../equipes/equipe.html">
            <i class="fas fa-users-cog"></i><span>Equipes</span>
          </a>
        </li>
        <li>
          <a href="./apontamentos.html" class="active">
            <i class="fas fa-clipboard-list"></i><span>Apontamentos</span>
          </a>
        </li>
        <li>
          <a href="../diario/diario.html">
            <i class="fas fa-book"></i><span>Diário de obra</span>
          </a>
        </li>
        <li>
          <a href="../efetivo/efetivo.html">
            <i class="fas fa-user-friends"></i><span>Efetivo</span>
          </a>
        </li>
        <li>
          <a href="../anotar/anotar.html">
            <i class="fas fa-sticky-note" aria-hidden="true"></i><span>Anotações</span>
          </a>
        </li>
        <li>
          <a href="#">
            <i class="fas fa-calendar-check"></i><span>Abono DSR</span>
          </a>
        </li>
        <li>
          <a href="https://detroitbrasil.qforms.com.br/QuestionarioWeb/ResponderQuestionarioLink?chave=ADC929D335B064357179BDBAE1686855"
            target="_blank" rel="noopener noreferrer">
            <i class="fa-solid fa-shield-halved"></i><span>Observa+</span>
          </a>
        </li>
        <li>
          <a href="../configurações/configuração.html">
            <i class="fas fa-cog"></i><span>Configurações</span>
          </a>
        </li>
      </ul>
    </nav>
  </div>

  <!-- MAIN -->
  <main class="main" role="main">
    <header class="topbar">
      <div>
        <h2>Apontamentos</h2>
        <div class="muted-note">Visualize e filtre por data e equipe — os dados exibidos por dia são limitados para otimização</div>
      </div>
      <div>
        <button id="refreshBtn" class="btn-neumo"><i class="fas fa-sync"></i> Atualizar</button>
      </div>
    </header>

    <section class="filters">
      <div>
        <label for="dateFilter">Data</label>
        <input id="dateFilter" type="date" />
      </div>

      <div>
        <label for="teamFilter">Selecionar equipe</label>
        <select id="teamFilter">
          <option value="">-- Todas as equipes --</option>
        </select>
      </div>

      <div style="align-self:flex-end;">
        <small style="color:var(--muted)">Os registros mostrados são os do dia selecionado (cache local por data).</small>
      </div>
    </section>

    <div id="reportContainer" aria-live="polite">
      <!-- cards inseridos por JS -->
    </div>
  </main>

  <!-- Firebase compat libs (placed at end for faster paint) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <script>
    /***** FIREBASE CONFIG & INIT *****/
    const firebaseConfig = {
      apiKey: "AIzaSyDtnzixicBYAQkuoeB5tgCGpDLt1lByMZo",
      authDomain: "apropriacao-estrutura.firebaseapp.com",
      projectId: "apropriacao-estrutura",
      storageBucket: "apropriacao-estrutura.appspot.com",
      messagingSenderId: "155266586257",
      appId: "1:155266586257:web:6d70edc967cdbfc56e5130"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    /***** STATE / CACHE *****/
    let currentUserUid = null;
    let cachedDateKey = null;         // "YYYY-MM-DD"
    let cachedRecords = [];           // records fetched for cachedDateKey
    let debounceTimer = null;
    let lastFetchTimestamp = null;

    const dateEl = document.getElementById('dateFilter');
    const teamEl = document.getElementById('teamFilter');
    const refreshBtn = document.getElementById('refreshBtn');
    const reportContainer = document.getElementById('reportContainer');

    // util: format timestamp (defensivo: aceita Timestamp ou Date)
    function formatDateTime(tsOrDate) {
      let d;
      if (!tsOrDate) return '-';
      if (tsOrDate.toDate && typeof tsOrDate.toDate === 'function') d = tsOrDate.toDate();
      else if (tsOrDate instanceof Date) d = tsOrDate;
      else if (tsOrDate.seconds) d = new Date(tsOrDate.seconds * 1000);
      else return String(tsOrDate);
      return d.toLocaleString('pt-BR', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
    }

    // Substitua a função showToast por esta:
function showToast(text) {
  // Remove toast anterior se existir
  const old = document.getElementById('toast-notification');
  if (old) old.remove();
  
  const toast = document.createElement('div');
  toast.id = 'toast-notification';
  toast.textContent = text;
  toast.style.cssText = `
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: linear-gradient(135deg, var(--accent), var(--secondary));
    color: white;
    padding: 14px 20px;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    z-index: 9999;
    font-weight: 600;
    font-size: 14px;
    animation: slideIn 0.3s ease;
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

    /***** CARREGA EQUIPES (apenas 1 leitura por sessão) *****/
    async function loadTeamsFilter(ownerUid) {
      try {
        const snap = await db.collection('teams')
                          .where('ownerUid','==', ownerUid)
                          .orderBy('name','asc')
                          .get();
        // limpa
        teamEl.innerHTML = '<option value="">-- Todas as equipes --</option>';
        snap.forEach(doc => {
          const d = doc.data();
          const opt = document.createElement('option');
          opt.value = doc.id;                 // guardamos o id (preferível)
          opt.dataset.teamName = d.name || '';
          opt.textContent = d.name || doc.id;
          teamEl.appendChild(opt);
        });
      } catch (err) {
        console.warn('Erro ao carregar equipes', err);
      }
    }

    /***** BUSCA REGISTROS PARA UMA DATA (uma única leitura) *****/
    async function fetchRecordsForDate(dateKey, incrementalUpdate = false) {
  if (!currentUserUid) return [];
  try {
    const [y,m,d] = dateKey.split('-').map(n=>parseInt(n));
    const start = new Date(y,m-1,d,0,0,0);
    const end = new Date(y,m-1,d,23,59,59,999);

    let q = db.collection('records')
              .where('createdBy','==', currentUserUid)
              .where('date','>=', firebase.firestore.Timestamp.fromDate(start))
              .where('date','<=', firebase.firestore.Timestamp.fromDate(end));

    // SE for atualização incremental E temos timestamp anterior
    if (incrementalUpdate && lastFetchTimestamp) {
      // Busca apenas registros criados/modificados após o último fetch
      q = q.where('date', '>', lastFetchTimestamp);
    }

    q = q.orderBy('date','desc').limit(500);
    
    const snap = await q.get();
    
    // Atualiza o timestamp da última busca
    lastFetchTimestamp = firebase.firestore.Timestamp.now();
    
    const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    return docs;
  } catch (err) {
    console.warn('Erro fetchRecordsForDate', err);
    return [];
  }
}

// Modifique a função applyFilters:
async function applyFilters({ force = false, incremental = false } = {}) {
  const dateVal = dateEl.value || null;
  if (!dateVal) {
    reportContainer.innerHTML = `<p style="color:var(--muted)">Selecione uma data.</p>`;
    return;
  }

  // Se for atualização incremental
  if (incremental && cachedDateKey === dateVal && Array.isArray(cachedRecords)) {
    const newRecords = await fetchRecordsForDate(dateVal, true);
    
    if (newRecords.length > 0) {
      // Mescla novos registros com cache existente (evita duplicatas)
      const existingIds = new Set(cachedRecords.map(r => r.id));
      const uniqueNewRecords = newRecords.filter(r => !existingIds.has(r.id));
      
      cachedRecords = [...uniqueNewRecords, ...cachedRecords];
      showToast(`${uniqueNewRecords.length} novo(s) apontamento(s) encontrado(s)`);
    } else {
      showToast('Nenhum novo apontamento');
    }
    
    filterAndRenderFromCache();
    return;
  }

  // Busca completa (comportamento original)
  if (!force && cachedDateKey === dateVal && Array.isArray(cachedRecords)) {
    filterAndRenderFromCache();
    return;
  }

  cachedRecords = await fetchRecordsForDate(dateVal, false);
  cachedDateKey = dateVal;
  filterAndRenderFromCache();
}

// Atualize o event listener do botão refresh:
// Substitua o listener do refreshBtn por:
refreshBtn.addEventListener('click', () => {
  // Apenas re-renderiza do cache (ZERO Firebase)
  if (cachedRecords.length > 0) {
    filterAndRenderFromCache();
    showToast('Visualização atualizada (cache local)');
  } else {
    // Se não há cache, busca do servidor
    applyFilters({ force: true });
  }
});

    /***** RENDERIZAÇÃO DE CARDS (agrupa por timestamp de envio) *****/
    function renderCards(records) {
      reportContainer.innerHTML = '';
      if (!records || records.length === 0) {
        reportContainer.innerHTML = `<p style="color:var(--muted)">Nenhum apontamento para esses filtros.</p>`;
        return;
      }

      // agrupa por hora/minuto do campo date (formato legível)
      const groups = {};
      records.forEach(r => {
        const key = formatDateTime(r.date);
        (groups[key] = groups[key] || []).push(r);
      });

      Object.entries(groups).forEach(([sentAt, group]) => {
        const any = group[0] || {};
        const card = document.createElement('article');
        card.className = 'card';

        const hdr = document.createElement('div');
        hdr.className = 'card-header';
        hdr.innerHTML = `<h4>${escapeHtml(any.teamName || any.team || '-') } — ${escapeHtml(any.galpao || '-')}</h4><small>Enviado em ${escapeHtml(sentAt)}</small>`;
        card.appendChild(hdr);

        const body = document.createElement('div');
        body.className = 'card-body';

        // sumário
        const summaryHtml = `
          <div>
            <div style="color:var(--muted); font-size:13px;"><strong style="color:var(--text)">${group.length}</strong> colaborador(es)</div>
            <div style="color:var(--muted); font-size:13px;">Enviado por: <strong style="color:var(--text)">${escapeHtml(any.userName || any.createdBy || '-')}</strong></div>
          </div>
        `;
        body.insertAdjacentHTML('beforeend', summaryHtml);

        // membros
        const membersHtml = group.map(r => `
          <div class="member-item">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div style="font-weight:700;color:var(--text)"><i class="fas fa-user" style="margin-right:8px"></i>${escapeHtml(r.name || '-')}</div>
              <div style="color:var(--muted)">(${escapeHtml(r.memberMatricula || '-')})</div>
            </div>

            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px;color:var(--muted);font-size:13px">
              <div><i class="fas fa-clock" style="margin-right:6px"></i><strong style="color:var(--text)">Turno:</strong> ${escapeHtml(r.shift || '–')}</div>
              <div><i class="fas fa-layer-group" style="margin-right:6px"></i><strong style="color:var(--text)">Bloco:</strong> ${escapeHtml(r.blockShift || '–')}</div>
              <div><i class="fas fa-ship" style="margin-right:6px"></i><strong style="color:var(--text)">Embarcação:</strong> ${escapeHtml(r.vesselShift || '–')}</div>
              <div><i class="fas fa-map-marker-alt" style="margin-right:6px"></i><strong style="color:var(--text)">Local:</strong> ${escapeHtml(r.local || '–')}</div>
            </div>

            <div style="margin-top:8px;color:var(--muted);font-size:13px"><i class="fas fa-sticky-note" style="margin-right:6px"></i><strong style="color:var(--text)">Obs:</strong> ${escapeHtml(r.observations || r.obs || '–')}</div>
          </div>
        `).join('');

        body.insertAdjacentHTML('beforeend', `<div class="members-list">${membersHtml}</div>`);
        const signature = document.createElement('div');
signature.className = 'card-signature';
signature.textContent = 'Desenvolvido por Gustavo Carvalho | Setor Estrutura';

body.appendChild(signature);

        card.appendChild(body);
        reportContainer.appendChild(card);
      });
    }

    // escape simples
    function escapeHtml(s){ return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c])); }

    /***** LOGICA PRINCIPAL: aplica cache por data e filtro de equipe no cliente *****/
    async function applyFilters({ force = false } = {}) {
      const dateVal = dateEl.value || null;
      if (!dateVal) {
        reportContainer.innerHTML = `<p style="color:var(--muted)">Selecione uma data.</p>`;
        return;
      }

      // se já temos cache para esta data e não for force, reutiliza
      if (!force && cachedDateKey === dateVal && Array.isArray(cachedRecords)) {
        filterAndRenderFromCache();
        return;
      }

      // busca do servidor (uma única leitura para a data)
      cachedRecords = await fetchRecordsForDate(dateVal);
      cachedDateKey = dateVal;
      filterAndRenderFromCache();
    }

    function filterAndRenderFromCache() {
      const teamId = teamEl.value || '';
      const teamName = (teamEl.selectedOptions[0] && teamEl.selectedOptions[0].dataset.teamName) || '';
      let filtered = cachedRecords.slice(); // copia

      if (teamId) {
        filtered = filtered.filter(r => {
          // aceita vários formatos de como o registro pode armazenar a equipe
          return (String(r.teamId || r.team || r.teamName || '').toLowerCase() === String(teamId || teamName).toLowerCase())
              || (String(r.teamName || '').toLowerCase() === String(teamName || '').toLowerCase())
              || (String(r.teamId || '').toLowerCase() === String(teamId || '').toLowerCase());
        });
      }

      renderCards(filtered);
    }

    // debounce wrapper para evitar excessivas leituras/updates ao digitar/alterar
    function debounceApply(delay = 220) {
      if (debounceTimer) clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => applyFilters(), delay);
    }

    /***** EVENTOS & AUTH *****/
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = './index.html';
        return;
      }
      currentUserUid = user.uid;

      // inicializa date com hoje (se vazio)
      const today = new Date();
      const iso = today.toISOString().slice(0,10);
      if (!dateEl.value) dateEl.value = iso;

      // carrega equipes e primeiros dados
      await loadTeamsFilter(currentUserUid);
      await applyFilters({ force: false });

      // listeners
      dateEl.addEventListener('change', () => debounceApply(150));
      teamEl.addEventListener('change', () => debounceApply(100));
      refreshBtn.addEventListener('click', () => applyFilters({ force:true }));
    });

    // Controle da sidebar em dispositivos móveis
    document.addEventListener('DOMContentLoaded', function() {
      const toggleMenuBtn = document.getElementById('toggleMenu');
      const sidebar = document.querySelector('.sidebar');
      
      if (toggleMenuBtn && sidebar) {
        toggleMenuBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          sidebar.classList.toggle('active');
          
          // Alterar ícone do hamburger quando o menu estiver aberto
          const icon = toggleMenuBtn.querySelector('i');
          if (sidebar.classList.contains('active')) {
            icon.classList.remove('fa-bars');
            icon.classList.add('fa-times');
          } else {
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
          }
        });
        
        // Fechar o menu ao clicar fora dele
        document.addEventListener('click', function(event) {
          if (!sidebar.contains(event.target) && !toggleMenuBtn.contains(event.target)) {
            sidebar.classList.remove('active');
            const icon = toggleMenuBtn.querySelector('i');
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
          }
        });
        
        // Prevenir que cliques dentro do menu fechem ele
        sidebar.addEventListener('click', function(e) {
          e.stopPropagation();
        });
      }
    });

    /* ===== Botão Compartilhar Apropriação + funções ===== */

(function () {
  // procura área de ações na topbar e adiciona o botão
  const actions = document.querySelector('.topbar');
  if (!actions) return;

  const shareBtn = document.createElement('button');
  shareBtn.id = 'shareBtn';
  shareBtn.className = 'btn-neumo ghost';
  shareBtn.style.marginLeft = '8px';
  shareBtn.innerHTML = '<i class="fas fa-share"></i> Compartilhar';
  actions.appendChild(shareBtn);

  // formata ISO 'YYYY-MM-DD' para dd/mm/yyyy sem shift de timezone
function dateIsoToReadable(iso) {
  if (!iso) return '-';
  try {
    const parts = String(iso).split('-').map(n => parseInt(n, 10));
    if (parts.length < 3 || isNaN(parts[0])) return String(iso);
    const [y, m, d] = parts;
    const dt = new Date(y, (m||1) - 1, d); // usa horário local: evita shift UTC
    return dt.toLocaleDateString('pt-BR');
  } catch (e) {
    return String(iso);
  }
}


  // monta array de registros filtrados pela equipe selecionada e data atual do filtro
   function getFilteredAppropriationRecords() {
    // usa as variáveis do escopo do arquivo (dateEl, teamEl, cachedRecords)
    const dateVal = (dateEl && dateEl.value) || null;
    const teamId = (teamEl && teamEl.value) || null;
    const teamName = (teamEl && teamEl.selectedOptions && teamEl.selectedOptions[0] && teamEl.selectedOptions[0].dataset.teamName) || '';

    if (!dateVal) {
      console.debug('[share] date not selected');
      return { ok: false, reason: 'missing_date' };
    }
    if (!teamId) {
      console.debug('[share] team not selected');
      return { ok: false, reason: 'missing_team' };
    }

    const source = Array.isArray(cachedRecords) ? cachedRecords.slice() : [];
    const teamIdStr = String(teamId).toLowerCase();
    const teamNameStr = String(teamName).toLowerCase();

    const filtered = source.filter(r => {
      // considera vários nomes de campos possíveis (teamId, team, teamName, team_id)
      const candidates = [
        r.teamId, r.team, r.teamName, r.team_id,
        // outros campos que você possa ter salvo
        r.teamIdStr, r.team_name
      ].filter(Boolean).map(v => String(v).toLowerCase());

      // compara
      if (candidates.includes(teamIdStr)) return true;
      if (candidates.includes(teamNameStr)) return true;
      // também aceita quando teamName do registro coincide com o option dataset
      if (String(r.teamName || '').toLowerCase() === teamNameStr) return true;
      return false;
    });

    console.debug('[share] getFilteredAppropriationRecords', {
      dateVal, teamId, teamName, cacheLen: source.length, found: filtered.length
    });

    return { ok: true, records: filtered, dateVal, teamId, teamName };
  }

  // --- Substitua o listener do shareBtn pelo listener abaixo ---
  shareBtn.addEventListener('click', async function () {
    try {
      const dateValNow = (dateEl && dateEl.value) || null;
      if (!dateValNow) {
        showToast('Selecione data e equipe antes de compartilhar.');
        return;
      }

      // garante que o cache para essa data foi carregado (evita filtro em cache vazio)
      if (cachedDateKey !== dateValNow) {
        // força busca no servidor para a data atual
        await applyFilters({ force: true });
      }

      const info = getFilteredAppropriationRecords();
      if (!info.ok) {
        // mostra mensagem mais específica conforme razão
        if (info.reason === 'missing_date' || info.reason === 'missing_team') {
          showToast('Selecione data e equipe antes de compartilhar.');
        } else {
          showToast('Selecione data e equipe válidas antes de compartilhar.');
        }
        return;
      }

      if (!info.records || info.records.length === 0) {
        showToast('Nenhum registro encontrado para a equipe/data selecionada.');
        return;
      }

      // gera pdf e compartilha
      const { doc, exportedAt } = await buildAppropriationPdf(info.records, info.teamName, info.dateVal);
      await sharePdfBlob(doc, exportedAt, info.teamName, info.dateVal);
    } catch (err) {
      console.error('[share] erro ao gerar o PDF de apropriação', err);
      showToast('Erro ao gerar o PDF de apropriação.');
    }
  });

  // função principal: gera o doc (jsPDF) com o modelo "Apropriação"
  async function buildAppropriationPdf(records, teamName, dateVal) {
    // obtém jsPDF constructor (compat com UMD / global)
    const JsPDF = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF;
    if (!JsPDF) throw new Error('jsPDF não encontrado. Certifique-se de incluir o script do jsPDF.');

    const doc = new JsPDF({ unit: 'pt', format: 'a4' });
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 40;
    const maxWidth = pageWidth - margin * 2;
    const lineHeight = 14;

    // Cabeçalho
    const exportedAt = new Date();
    const exportedAtStr = exportedAt.toLocaleString('pt-BR');
    const logoY = 36;
    const logoYOffset = 14;
    const titleY = 88;
    const separatorY = 104;
    let y = separatorY + 28;
    await prepareIcons(18);

    // header: logo (tenta reaproveitar sua função se existir)
        // header: logo (usa getProjectLogoDataUrl com fallback textual)
    try {
      const logoDataUrl = (typeof getProjectLogoDataUrl === 'function') ? await getProjectLogoDataUrl().catch(()=>null) : null;
      if (logoDataUrl) {
        // Carrega a imagem em um objeto Image para obter dimensões reais e preservar proporção
        try {
          const img = new Image();
          // alguns browsers requerem atribuir crossOrigin se imagem externa — mas o getProjectLogoDataUrl idealmente retorna dataURL
          img.src = logoDataUrl;
          await new Promise((res) => {
            if (img.complete) return res();
            img.onload = () => res();
            img.onerror = () => res();
          });

          const origW = img.naturalWidth || img.width || 200;
          const origH = img.naturalHeight || img.height || 72;
          const ratio = origW / origH;

          // Ajuste máximo desejado: aumentei o limite de largura para 140 (pode ajustar)
          const maxLogoW = 120;   // <-- aumente se quiser logo ainda mais larga
          const maxLogoH = 48;    // altura máxima para evitar muito alto

          let logoW = origW;
          let logoH = origH;

          // escalar proporcionalmente para caber nos limites
          if (logoW > maxLogoW) {
            logoW = maxLogoW;
            logoH = Math.round(logoW / ratio);
          }
          if (logoH > maxLogoH) {
            logoH = maxLogoH;
            logoW = Math.round(logoH * ratio);
          }

          // centraliza verticalmente no headerY aproximado
         const logoX = margin;
const logoYAdjusted = (logoY - (logoH / 2)) + logoYOffset;
doc.addImage(logoDataUrl, 'PNG', logoX, logoYAdjusted, logoW, logoH);


          // adiciona imagem ao PDF
          try {
            doc.addImage(logoDataUrl, 'PNG', logoX, logoYAdjusted, logoW, logoH);
          } catch (errImg) {
            console.warn('addImage falhou, fallback texto', errImg);
            doc.setFontSize(11); doc.setTextColor(100); doc.text('Estrutura', margin, logoY + 18);
          }
        } catch (eImg) {
          console.warn('logo load/scale error', eImg);
          doc.setFontSize(11); doc.setTextColor(100); doc.text('Estrutura', margin, logoY + 18);
        }
      } else {
        doc.setFontSize(11); doc.setTextColor(100); doc.text('Estrutura', margin, logoY + 18);
      }
    } catch (e) {
      console.warn('logo failed', e);
      doc.setFontSize(11);
      doc.setTextColor(100);
      doc.text('Estrutura', margin, logoY + 18);
    }


    // título central (Apropriação)
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(18);
    const title = `Estrutura | Apropriação`;
    doc.setTextColor(20);
    const titleWidth = doc.getTextWidth(title);
    doc.text(title, (pageWidth - titleWidth) / 2, titleY);

    // meta top-right
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    doc.setTextColor(100);
    const exportedLabel = `Exportado: ${exportedAtStr}`;
    doc.text(exportedLabel, pageWidth - margin - doc.getTextWidth(exportedLabel), logoY + 18);

    // separador
    doc.setDrawColor(190); doc.setLineWidth(0.9);
    doc.line(margin, separatorY, pageWidth - margin, separatorY);

    // informações da apropriação (equipe + data)
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(11);
    doc.setTextColor(60);
    const infoLine = `Equipe: ${teamName || '-'}    |    Data: ${dateIsoToReadable(dateVal)}`;
    doc.text(infoLine, margin, y); y += (lineHeight + 6);

    // se nenhum registro
    if (!records || records.length === 0) {
      const empty = 'Nenhum registro de apropriação encontrado para esta equipe/data.';
      const linesEmpty = doc.splitTextToSize(empty, maxWidth);
      doc.text(linesEmpty, margin, y);
      y += linesEmpty.length * lineHeight;
      if (typeof addFooter === 'function') addFooter(doc, exportedAtStr); // usa rodapé existente se houver. :contentReference[oaicite:2]{index=2}
      return { doc, exportedAt };
    }

    /* ===== Helpers: logo + footer ===== */

async function getProjectLogoDataUrl() {
  // 1) permite sobrescrever via JS: window.PROJECT_LOGO_DATAURL = 'data:image/...'
  if (window.PROJECT_LOGO_DATAURL) return window.PROJECT_LOGO_DATAURL;

  // 2) tenta pegar uma imagem no DOM: <img id="companyLogo"> ou .brand-logo img ou img.logo
  const selectors = ['#companyLogo', '.brand-logo img', 'img.logo', 'header img.logo'];
  const imgEl = selectors.map(s => document.querySelector(s)).find(x => !!x);

  if (!imgEl) return null;

  // Se a imagem ainda não carregou, aguarda carregamento
  if (!imgEl.complete) {
    await new Promise((res) => { imgEl.onload = res; imgEl.onerror = res; });
  }

  // Tenta converter para dataURL via canvas (pode falhar por CORS)
  try {
    const canvas = document.createElement('canvas');
    canvas.width = imgEl.naturalWidth || imgEl.width || 200;
    canvas.height = imgEl.naturalHeight || imgEl.height || 72;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(imgEl, 0, 0, canvas.width, canvas.height);
    // prefer PNG
    return canvas.toDataURL('../favicon/detroit-brasil.png');
  } catch (err) {
    console.warn('getProjectLogoDataUrl: conversão falhou (CORS ou outro):', err);
    return null;
  }
}

// desenha rodapé simples na página corrente (left text). Chamado durante o fluxo.
function addFooter(doc, exportedAtStr) {
  try {
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 40;
    const footerY = pageHeight - 28;

    // define itálico para o texto esquerdo
    try {
      doc.setFont('helvetica', 'italic'); // jsPDF: define fonte + estilo
    } catch (e) {
      // fallback se setFont falhar em sua versão do jsPDF
      try { doc.setFontStyle && doc.setFontStyle('italic'); } catch(e2){/*silent*/ }
    }
    doc.setFontSize(9);
    doc.setTextColor(100);
    const leftText = 'Desenvolvido por: Gustavo Carvalho | Estrutura';
    doc.text(leftText, margin, footerY);

    // volta para fonte normal (importante para não afetar outros textos)
    try {
      doc.setFont('helvetica', 'normal');
    } catch (e) {
      try { doc.setFontStyle && doc.setFontStyle('normal'); } catch(e2){/*silent*/ }
    }
  } catch (e) {
    console.warn('addFooter error', e);
  }
}


// adiciona números de página em todas as páginas e garante o texto esquerdo em cada página.
// Chamar APÓS terminar de desenhar todo o conteúdo (antes de salvar/exportar).
function finalizeFooter(doc, exportedAtStr) {
  try {
    const total = (typeof doc.getNumberOfPages === 'function') ? doc.getNumberOfPages() : doc.internal.getNumberOfPages();
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 40;
    const footerY = pageHeight - 28;

    for (let i = 1; i <= total; i++) {
      doc.setPage(i);

      // texto esquerdo em itálico
      try { doc.setFont('helvetica', 'italic'); } catch(e){ try{ doc.setFontStyle && doc.setFontStyle('italic'); }catch(_){} }
      doc.setFontSize(9);
      doc.setTextColor(100);
      const leftText = 'Desenvolvido por: Gustavo Carvalho | Estrutura';
      doc.text(leftText, margin, footerY);

      // número da página em itálico (direita)
      const pageText = `Página ${i} de ${total}`;
      const w = doc.getTextWidth(pageText);
      // mantém itálico para a página também
      doc.text(pageText, pageWidth - margin - w, footerY);

      // volta para normal após escrever
      try { doc.setFont('helvetica', 'normal'); } catch(e){ try{ doc.setFontStyle && doc.setFontStyle('normal'); }catch(_){} }
    }
    // volta para última página como padrão
    doc.setPage(total);
  } catch (e) {
    console.warn('finalizeFooter error', e);
  }
}


    // Para cada registro: nome, matrícula, turno, bloco, embarcação, local, observações
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(11);
    doc.setTextColor(40);

    for (let i = 0; i < records.length; i++) {
  const r = records[i];

  // título do colaborador (nome + matrícula)
  const personTitle = `${r.name || '-'}  (${r.memberMatricula || '-'})`;
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(12);
  // paginação preventiva
  if (y + lineHeight + 120 > doc.internal.pageSize.getHeight()) {
    if (typeof addFooter === 'function') addFooter(doc, exportedAtStr);
    doc.addPage();
    y = 72;
  }
  doc.text(personTitle, margin, y);
  y += lineHeight;

  // --- Detalhes e Galpão por colaborador ---
  // helper: obtém o primeiro valor não vazio entre várias chaves possíveis
  const firstNonEmpty = (obj, keys) => {
    for (const k of keys) {
      if (!obj) continue;
      const v = obj[k];
      if (v !== undefined && v !== null && String(v).trim() !== '') return String(v).trim();
    }
    return '';
  };

  const galpaoKeys = ['galpao','galpão','galpaoShift','galpaoName','galpao_area'];
  const detalhesKeys = ['detalhes','details','description','desc','observationsHeader','detalhe'];

  const galpaoText = (function firstNonEmpty(obj, keys) {
    for (const k of keys) {
      if (!obj) continue;
      const v = obj[k];
      if (v !== undefined && v !== null && String(v).trim() !== '') return String(v).trim();
    }
    return '';
  })(r, galpaoKeys) || '-';

  const detalhesText = (function firstNonEmpty(obj, keys) {
    for (const k of keys) {
      if (!obj) continue;
      const v = obj[k];
      if (v !== undefined && v !== null && String(v).trim() !== '') return String(v).trim();
    }
    return '';
  })(r, detalhesKeys) || '-';

  // usa exatamente as mesmas configurações visuais dos outros campos
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(10);
  doc.setTextColor(40);

    // configura ícone/texto
  const iconSize = 12; // tamanho em pts (aprox). Ajuste se quiser maior/menor.
  const iconGap = 6;
  const colGap = 12;
  const colWidth = (maxWidth - colGap) / 2;

  // mapas de qual ícone usar por coluna (esquerda/direita)
  // esquerda: Detalhes  -> use 'note'; direita: Galpão -> use 'block'
  // para Turno/Bloco/Embarcação/Local escolhemos clock, block, ship, map
  // Abaixo eu demonstro para as linhas de info (Detalhes/Galpão), e depois para Turno/Bloco/...
  
  // --- Detalhes / Galpão (com ícones) ---
  const leftIcon = ICONS_PNG.note;   // Detalhes
  const rightIcon = ICONS_PNG.block; // Galpão

  // ajusta largura útil do texto descontando o ícone
  const leftTextWidth = colWidth - (iconSize + iconGap);
  const rightTextWidth = colWidth - (iconSize + iconGap);

  const left = `Detalhes: ${detalhesText}`;
  const right = `Galpão: ${galpaoText}`;

  const leftLines = doc.splitTextToSize(left, leftTextWidth);
  const rightLines = doc.splitTextToSize(right, rightTextWidth);
  const maxLines = Math.max(leftLines.length, rightLines.length);

  for (let ln = 0; ln < maxLines; ln++) {
    if (y + lineHeight + 120 > doc.internal.pageSize.getHeight()) {
      if (typeof addFooter === 'function') addFooter(doc, exportedAtStr);
      doc.addPage();
      y = 72;
    }

    // coluna esquerda
    const colLeftX = margin;
    const iconLeftX = colLeftX;
    const textLeftX = colLeftX + iconSize + iconGap;
    const leftTxt = leftLines[ln] || '';
    if (leftIcon) {
      try { doc.addImage(leftIcon, 'PNG', iconLeftX, y - (iconSize - 3), iconSize, iconSize); } catch(e){ /*ignore*/ }
    }
    if (leftTxt) doc.text(leftTxt, textLeftX, y);

    // coluna direita
    const colRightX = margin + colWidth + colGap;
    const iconRightX = colRightX;
    const textRightX = colRightX + iconSize + iconGap;
    const rightTxt = rightLines[ln] || '';
    if (rightIcon) {
      try { doc.addImage(rightIcon, 'PNG', iconRightX, y - (iconSize - 3), iconSize, iconSize); } catch(e){ /*ignore*/ }
    }
    if (rightTxt) doc.text(rightTxt, textRightX, y);

    y += lineHeight;
  }


  // --- Campos existentes (Turno, Bloco, Embarcação, Local) ---
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(10);
  doc.setTextColor(40);

    // --- Turno / Bloco / Embarcação / Local (com ícones) ---
  const fieldIcons = {
    0: ICONS_PNG.clock,  // Turno (left col first row)
    1: ICONS_PNG.block,  // Bloco (right col first row)
    2: ICONS_PNG.ship,   // Embarcação (left col second row)
    3: ICONS_PNG.map     // Local (right col second row)
  };

  const fieldLines = [
    `Turno: ${r.shift || '–'}`,
    `Bloco: ${r.blockShift || '–'}`,
    `Embarcação: ${r.vesselShift || '–'}`,
    `Local: ${r.local || '–'}`
  ];

  for (let ci = 0; ci < fieldLines.length; ci += 2) {
    const leftF = fieldLines[ci];
    const rightF = fieldLines[ci+1] || '';
    const leftLinesF = doc.splitTextToSize(leftF, colWidth - (iconSize + iconGap));
    const rightLinesF = rightF ? doc.splitTextToSize(rightF, colWidth - (iconSize + iconGap)) : [];
    const maxF = Math.max(leftLinesF.length, rightLinesF.length);

    for (let ln = 0; ln < maxF; ln++) {
      if (y + lineHeight + 120 > doc.internal.pageSize.getHeight()) {
        if (typeof addFooter === 'function') addFooter(doc, exportedAtStr);
        doc.addPage();
        y = 72;
      }

      // left field
      const leftTxt = leftLinesF[ln] || '';
      const leftIcon = fieldIcons[ci] || null;
      if (leftIcon) try { doc.addImage(leftIcon, 'PNG', margin, y - (iconSize - 3), iconSize, iconSize); } catch(e){/*ignore*/ }
      if (leftTxt) doc.text(leftTxt, margin + iconSize + iconGap, y);

      // right field
      const rightTxt = rightLinesF[ln] || '';
      const rightIcon = fieldIcons[ci+1] || null;
      const rightBaseX = margin + colWidth + colGap;
      if (rightIcon) try { doc.addImage(rightIcon, 'PNG', rightBaseX, y - (iconSize - 3), iconSize, iconSize); } catch(e){/*ignore*/ }
      if (rightTxt) doc.text(rightTxt, rightBaseX + iconSize + iconGap, y);

      y += lineHeight;
    }
  }

      // observações (se houver)
      const obs = r.observations || r.obs || '';
      if (obs) {
        y += 6;
        const obsLines = doc.splitTextToSize(`Obs: ${obs}`, maxWidth);
        for (let ol = 0; ol < obsLines.length; ol++) {
          if (y + lineHeight + 120 > doc.internal.pageSize.getHeight()) {
            if (typeof addFooter === 'function') addFooter(doc, exportedAtStr);
            doc.addPage();
            y = 72;
          }
          doc.text(obsLines[ol], margin, y);
          y += lineHeight;
        }
      }

      // separador entre registros
      y += 8;
      doc.setDrawColor(210);
      doc.setLineWidth(0.4);
      doc.line(margin, y, pageWidth - margin, y);
      y += 14;
    }

    if (typeof addFooter === 'function') addFooter(doc, exportedAtStr);
// garante numeração e footer em todas as páginas
if (typeof finalizeFooter === 'function') finalizeFooter(doc, exportedAtStr);
return { doc, exportedAt };

  }

  // tenta compartilhar usando Web Share API com arquivo; fallback para URL ou download
  let _sharingInProgress = false;

function isMobileDevice() {
  // combinação de userAgent + capacidade de toque (mais robusto que só UA)
  const ua = navigator.userAgent || navigator.vendor || window.opera || '';
  const mobileUa = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile/i.test(ua);
  const hasTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints && navigator.maxTouchPoints > 0);
  return mobileUa || hasTouch;
}

async function sharePdfBlob(doc, exportedAt, teamName, dateVal) {
  if (_sharingInProgress) {
    console.warn('[share] tentativa concorrente evitada');
    showToast && showToast('Aguarde: compartilhamento em andamento.');
    return;
  }
  _sharingInProgress = true;
  const btn = document.getElementById('shareBtn');
  if (btn) { btn.disabled = true; btn.classList && btn.classList.add('disabled'); }

  const SAFETY_TIMEOUT_MS = 9000; // reabilita após X ms caso o share() nunca resolva
  let safetyTimer = setTimeout(() => {
    console.warn('[share] safety timeout — reabilitando botão');
    _sharingInProgress = false;
    if (btn) { btn.disabled = false; btn.classList.remove('disabled'); }
    showToast && showToast('Tempo excedido. Tente compartilhar novamente.');
  }, SAFETY_TIMEOUT_MS);

  try {
    // gerar blob do jsPDF
    const blob = (typeof doc.output === 'function') ? doc.output('blob') : null;
    const filename = `apropriacao_${(teamName || 'sem_equipe').replace(/\s+/g,'_')}_${exportedAt.toISOString().slice(0,10)}.pdf`;

    // Se for desktop ou navegador sem suporte a share, forçar download
    const mobile = isMobileDevice();
    const supportFilesShare = !!(navigator.canShare && blob && typeof File === 'function');
    const supportShare = !!navigator.share;

    // Caso desktop OR nenhum suporte a share => baixar
    if (!mobile || (!supportShare && !supportFilesShare)) {
      // fallback: salvar localmente
      if (!blob) {
        doc.save(filename);
      } else {
        // usa jsPDF save para melhor compatibilidade
        doc.save(filename);
      }
      showToast && showToast('PDF baixado no dispositivo.');
      return;
    }

    // A partir daqui: ambiente móvel (mobile === true) e tentamos abrir o menu nativo
    if (!blob) {
      // se não conseguimos criar blob, salvamos (apenas fallback)
      doc.save(filename);
      showToast && showToast('PDF gerado (download).');
      return;
    }

    const file = new File([blob], filename, { type: 'application/pdf' });

    // 1) tenta compartilhar arquivo (melhor experiência)
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      try {
        await navigator.share({
          files: [file],
          title: `Apropriação — ${teamName || ''}`,
          text: `Apropriação ${teamName || ''} — ${dateIsoToReadable ? dateIsoToReadable(dateVal) : dateVal}`
        });
        showToast && showToast('Compartilhamento concluído.');
        return;
      } catch (err) {
        console.warn('[share] share(files) cancel/err', err);
        if (err && err.name === 'InvalidStateError') {
          showToast && showToast('Aguardando finalização de compartilhamento anterior. Tente novamente.');
          return;
        }
        // se usuário cancelou ou outro erro, informar e tentar fallback abaixo
        if (err && (err.name === 'AbortError' || err.name === 'NotAllowedError')) {
          showToast && showToast('Compartilhamento cancelado.');
          return;
        }
        // segue para tentativa com url ou download
      }
    }

    // 2) tenta compartilhar uma URL blob (alguns WebViews/Safari aceitam)
    if (navigator.share) {
      const blobUrl = URL.createObjectURL(blob);
      try {
        await navigator.share({
          title: `Apropriação — ${teamName || ''}`,
          text: `Apropriação ${teamName || ''} — ${dateIsoToReadable ? dateIsoToReadable(dateVal) : dateVal}`,
          url: blobUrl
        });
        showToast && showToast('Compartilhamento concluído.');
        URL.revokeObjectURL(blobUrl);
        return;
      } catch (err2) {
        console.warn('[share] share(url) err', err2);
        URL.revokeObjectURL(blobUrl);
        if (err2 && err2.name === 'InvalidStateError') {
          showToast && showToast('Aguardando finalização de compartilhamento anterior. Tente novamente.');
          return;
        }
        // se falhar, prosseguir para fallback (download)
      }
    }

    // 3) fallback final: baixar (se nenhum método de share funcionou)
    doc.save(filename);
    showToast && showToast('Não foi possível abrir o compartilhamento nativo — PDF baixado.');
  } catch (err) {
    console.error('[share] Erro ao gerar/compartilhar PDF', err);
    showToast && showToast('Falha ao gerar/compartilhar PDF.');
  } finally {
    clearTimeout(safetyTimer);
    _sharingInProgress = false;
    if (btn) { btn.disabled = false; btn.classList.remove('disabled'); }
  }
}

  // listener do botão
  shareBtn.addEventListener('click', async function () {
    try {
      const info = getFilteredAppropriationRecords();
      if (!info.ok) {
        showToast('Selecione data e equipe antes de compartilhar.');
        return;
      }

      // se não há registros para essa equipe/data
      if (!info.records || info.records.length === 0) {
        showToast('Nenhum registro encontrado para a equipe/data selecionada.');
        return;
      }

      // gera pdf e compartilha
      const { doc, exportedAt } = await buildAppropriationPdf(info.records, info.teamName, info.dateVal);
      await sharePdfBlob(doc, exportedAt, info.teamName, info.dateVal);
    } catch (err) {
      console.error(err);
      showToast('Erro ao gerar o PDF de apropriação.');
    }
  });

})();

/* ===== ICONS: SVG -> PNG converter + preparação ===== */
const ICON_SVGS = {
  clock: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.--><path d="M464 256a208 208 0 1 1 -416 0 208 208 0 1 1 416 0zM0 256a256 256 0 1 0 512 0 256 256 0 1 0 -512 0zM232 120l0 136c0 8 4 15.5 10.7 20l96 64c11 7.4 25.9 4.4 33.3-6.7s4.4-25.9-6.7-33.3L280 243.2 280 120c0-13.3-10.7-24-24-24s-24 10.7-24 24z"/></svg>`,

  block: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.--><path d="M224.3-2.5c19.8-11.4 44.2-11.4 64 0L464.2 99c19.8 11.4 32 32.6 32 55.4l0 203c0 22.9-12.2 44-32 55.4L288.3 514.5c-19.8 11.4-44.2 11.4-64 0L48.5 413c-19.8-11.4-32-32.6-32-55.4l0-203c0-22.9 12.2-44 32-55.4L224.3-2.5zm207.8 360l0-166.1-143.8 83 0 166.1 143.8-83z"/></svg>`,

  ship: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.--><path d="M272 0c-26.5 0-48 21.5-48 48l0 16-16 0c-44.2 0-80 35.8-80 80l0 108.8-21.6 8.6c-14.8 5.9-22.5 22.4-17.4 37.5 10.4 31.3 26.8 59.3 47.7 83.1 20.1-9.2 41.7-13.9 63.3-14 33.1-.2 66.3 10.2 94.4 31.4l1.6 1.2 0-215-104 41.6 0-83.2c0-8.8 7.2-16 16-16l224 0c8.8 0 16 7.2 16 16l0 83.2-104-41.6 0 215 1.6-1.2c27.5-20.7 59.9-31.2 92.4-31.4 22.3-.1 44.6 4.5 65.3 14 20.9-23.7 37.3-51.8 47.7-83.1 5-15.2-2.6-31.6-17.4-37.5L512 252.8 512 144c0-44.2-35.8-80-80-80l-16 0 0-16c0-26.5-21.5-48-48-48L272 0zM403.4 476.1c21.3-16.1 49.9-16.1 71.2 0 19 14.4 41.9 28.2 67.2 33.3 26.5 5.4 54.3 .8 80.7-19.1 10.6-8 12.7-23 4.7-33.6s-23-12.7-33.6-4.7c-14.9 11.2-28.6 13.1-42.3 10.3-14.9-3-30.9-11.9-47.8-24.6-38.4-29-90.5-29-129 0-24 18.1-40.7 26.3-54.5 26.3s-30.5-8.2-54.5-26.3c-38.4-29-90.5-29-129 0-21.6 16.3-41.3 25.8-58.9 25.7-9.6-.1-19.9-3-31.2-11.5-10.6-8-25.6-5.9-33.6 4.7S7 482.3 17.6 490.3c19.1 14.4 39.4 21 59.8 21.1 33.9 .2 64.3-17.4 88.1-35.3 21.3-16.1 49.9-16.1 71.2 0 24.2 18.3 52.3 35.9 83.4 35.9s59.1-17.7 83.4-35.9z"/></svg>`,

  map: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.--><path d="M512 48c0-8.3-4.3-16-11.3-20.4s-15.9-4.8-23.3-1.1L352.5 88.1 180 29.4c-13.7-4.7-28.7-3.8-41.9 2.3L13.8 90.3C5.4 94.2 0 102.7 0 112L0 464c0 8.2 4.2 15.9 11.1 20.3s15.6 4.9 23.1 1.4l127.3-59.9 170.7 56.9c13.7 4.6 28.5 3.7 41.6-2.5l124.4-58.5c8.4-4 13.8-12.4 13.8-21.7l0-352zM144 82.1l0 299-96 45.2 0-299 96-45.2zm48 303.3l0-301.1 128 43.5 0 300.3-128-42.7zM368 134l96-47.4 0 298.2-96 45.2 0-296z"/></svg>`,

  note: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.--><path d="M64 48l112 0 0 88c0 39.8 32.2 72 72 72l88 0 0 240c0 8.8-7.2 16-16 16L64 464c-8.8 0-16-7.2-16-16L48 64c0-8.8 7.2-16 16-16zM224 67.9l92.1 92.1-68.1 0c-13.3 0-24-10.7-24-24l0-68.1zM64 0C28.7 0 0 28.7 0 64L0 448c0 35.3 28.7 64 64 64l256 0c35.3 0 64-28.7 64-64l0-261.5c0-17-6.7-33.3-18.7-45.3L242.7 18.7C230.7 6.7 214.5 0 197.5 0L64 0zm56 256c-13.3 0-24 10.7-24 24s10.7 24 24 24l144 0c13.3 0 24-10.7 24-24s-10.7-24-24-24l-144 0zm0 96c-13.3 0-24 10.7-24 24s10.7 24 24 24l144 0c13.3 0 24-10.7 24-24s-10.7-24-24-24l-144 0z"/></svg>`,

  galpao: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.--><path d="M0 142.1L0 480c0 17.7 14.3 32 32 32s32-14.3 32-32l0-240c0-17.7 14.3-32 32-32l384 0c17.7 0 32 14.3 32 32l0 240c0 17.7 14.3 32 32 32s32-14.3 32-32l0-337.9c0-27.5-17.6-52-43.8-60.7L303.2 5.1c-9.9-3.3-20.5-3.3-30.4 0L43.8 81.4C17.6 90.1 0 114.6 0 142.1zM464 256l-352 0 0 64 352 0 0-64zM112 416l352 0 0-64-352 0 0 64zm352 32l-352 0 0 64 352 0 0-64z"/></svg>`,

  obs: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.--><path d="M232 96l-80 0c-13.3 0-24-10.7-24-24s10.7-24 24-24l80 0c13.3 0 24 10.7 24 24s-10.7 24-24 24zm0 48c37.1 0 67.6-28 71.6-64L320 80c8.8 0 16 7.2 16 16l0 352c0 8.8-7.2 16-16 16L64 464c-8.8 0-16-7.2-16-16L48 96c0-8.8 7.2-16 16-16l16.4 0c4 36 34.5 64 71.6 64l80 0zM291.9 32C279 12.7 257 0 232 0L152 0c-25 0-47 12.7-59.9 32L64 32C28.7 32 0 60.7 0 96L0 448c0 35.3 28.7 64 64 64l256 0c35.3 0 64-28.7 64-64l0-352c0-35.3-28.7-64-64-64l-28.1 0z"/></svg>`
};

// TODO: Fazer com que os detalhes e galpão fiquem abaixo de embarcação e local e colocar icones nos colaboradores

const ICONS_PNG = {}; // será preenchido com dataURLs PNG

function svgToPngDataUrl(svgString, width = 64, height = 64) {
  return new Promise((resolve, reject) => {
    try {
      const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
      const url = URL.createObjectURL(svgBlob);
      const img = new Image();
      img.onload = () => {
        // desenha em canvas e extrai PNG
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        // branco de fundo opcional:
        // ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        try {
          const pngData = canvas.toDataURL('image/png');
          URL.revokeObjectURL(url);
          resolve(pngData);
        } catch (err) {
          URL.revokeObjectURL(url);
          reject(err);
        }
      };
      img.onerror = (e) => { URL.revokeObjectURL(url); reject(e); };
      img.src = url;
    } catch (err) {
      reject(err);
    }
  });
}

async function prepareIcons(desiredPx = 18) {
  // desiredPx = tamanho (em px) dos ícones no canvas antes de adicionar ao PDF (ajuste se necessário)
  const entries = Object.entries(ICON_SVGS);
  for (const [k, svg] of entries) {
    try {
      // converte redimensionando para desiredPx (mantém proporção do viewBox)
      ICONS_PNG[k] = await svgToPngDataUrl(svg, desiredPx, desiredPx);
    } catch (err) {
      console.warn('prepareIcons failed for', k, err);
      ICONS_PNG[k] = null;
    }
  }
}

  </script>
</body>
</html>
