<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Estrutura | Login</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>
  
  <!-- Firebase - Carregamento Condicional -->
  <script type="module">
    // Cache persistente sem expiração automática
    const CACHE_KEY = 'auth_session';
    const SESSION_KEY = 'firebase_initialized';

    // Funções de cache otimizadas
    function setAuthCache(uid, userData = null) {
      const cache = {
        uid,
        userData,
        timestamp: Date.now(),
        version: 1
      };
      localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
      sessionStorage.setItem('auth_validated', 'true');
    }
    
    function getAuthCache() {
      try {
        const cached = localStorage.getItem(CACHE_KEY);
        if (!cached) return null;
        
        const cache = JSON.parse(cached);
        if (!cache.uid || !cache.timestamp) {
          localStorage.removeItem(CACHE_KEY);
          sessionStorage.removeItem('auth_validated');
          return null;
        }
        return cache;
      } catch {
        localStorage.removeItem(CACHE_KEY);
        sessionStorage.removeItem('auth_validated');
        return null;
      }
    }
    
    function clearAuthCache() {
      localStorage.removeItem(CACHE_KEY);
      sessionStorage.removeItem('auth_validated');
      sessionStorage.removeItem(SESSION_KEY);
    }

    function clearAuthCacheOnError() {
      clearAuthCache();
      console.log('Cache limpo devido a erro de autenticação');
    }

    function isSessionValidated() {
      return sessionStorage.getItem('auth_validated') === 'true';
    }

    // Detecta se veio de um logout
    function detectLogout() {
      const urlParams = new URLSearchParams(window.location.search);
      const fromLogout = urlParams.get('logout') === 'true' || 
                         sessionStorage.getItem('logout_performed') === 'true';
      
      if (fromLogout) {
        console.log('🚪 Logout detectado - garantindo limpeza total');
        
        try {
          localStorage.removeItem('auth_session');
          sessionStorage.removeItem('auth_validated');
          sessionStorage.removeItem('firebase_initialized');
          sessionStorage.removeItem('logout_performed');
        } catch (error) {
          console.warn('Erro na limpeza pós-logout:', error);
        }
        
        if (urlParams.get('logout')) {
          window.history.replaceState({}, document.title, window.location.pathname);
        }
        
        // Mostra mensagem de logout bem-sucedido após carregar a API
        setTimeout(() => {
          if (window.firebaseAuth?.showNotification) {
            window.firebaseAuth.showNotification('Logout realizado com sucesso!', 'success');
          }
        }, 100);
        
        return true;
      }
      
      return false;
    }

    // Inicialização condicional do Firebase
    let firebaseApp = null;
    let auth = null;
    let firebaseModules = null;

    async function initFirebaseIfNeeded() {
      if (firebaseApp) return { app: firebaseApp, auth, modules: firebaseModules };
      
      const [
        { initializeApp },
        { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged }
      ] = await Promise.all([
        import("https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js"),
        import("https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js")
      ]);

      const firebaseConfig = {
        apiKey: "AIzaSyDtnzixicBYAQkuoeB5tgCGpDLt1lByMZo",
        authDomain: "apropriacao-estrutura.firebaseapp.com",
        projectId: "apropriacao-estrutura",
        storageBucket: "apropriacao-estrutura.appspot.com",
        messagingSenderId: "155266586257",
        appId: "1:155266586257:web:6d70edc967cdbfc56e5130"
      };

      firebaseApp = initializeApp(firebaseConfig);
      auth = getAuth(firebaseApp);
      firebaseModules = {
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        onAuthStateChanged
      };

      sessionStorage.setItem(SESSION_KEY, 'true');
      return { app: firebaseApp, auth, modules: firebaseModules };
    }

    // Verificação de autenticação modificada com detecção de logout
    window.addEventListener('DOMContentLoaded', async () => {
      // 1. PRIMEIRO: Detecta e processa logout
      const wasLogout = detectLogout();
      if (wasLogout) {
        console.log('Processando logout - não verificará autenticação');
        return; // Para aqui
      }
      
      // 2. Primeira verificação: cache válido + sessão validada (0 requests Firebase)
      const cachedAuth = getAuthCache();
      if (cachedAuth && isSessionValidated()) {
        console.log('Redirecionando para dashboard - usuário já autenticado');
        window.location.href = './dashboard.html';
        return;
      }

      // 3. Segunda verificação: cache válido mas sessão não validada
      if (cachedAuth && cachedAuth.uid) {
        sessionStorage.setItem('auth_validated', 'true');
        console.log('Cache válido encontrado - redirecionando');
        window.location.href = './dashboard.html';
        return;
      }

      // 4. Verificação de conectividade antes de tentar Firebase
      if (!navigator.onLine) {
        console.warn('Offline - aguardando login manual');
        return;
      }

      // 5. Só inicializa Firebase se não tiver cache válido E estiver online
      try {
        const { auth: firebaseAuth, modules } = await initFirebaseIfNeeded();
        
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Auth timeout')), 5000)
        );
        
        const authPromise = new Promise((resolve) => {
          const unsubscribe = modules.onAuthStateChanged(firebaseAuth, (user) => {
            unsubscribe();
            resolve(user);
          });
        });
        
        const user = await Promise.race([authPromise, timeoutPromise]);
        
        if (user) {
          setAuthCache(user.uid, {
            email: user.email,
            lastLogin: Date.now()
          });
          console.log('Usuário ainda logado no Firebase - redirecionando');
          window.location.href = './dashboard.html';
        } else {
          console.log('Nenhum usuário logado - aguardando login manual');
        }
      } catch (error) {
        console.warn('Firebase init failed or timed out:', error);
      }
    });

    // Traduz erros do Firebase
    const ERROR_MESSAGES = {
      'auth/email-already-in-use': 'Este e-mail já está cadastrado.',
      'auth/invalid-email': 'O e-mail inserido é inválido.',
      'auth/weak-password': 'A senha deve conter pelo menos 6 caracteres.',
      'auth/missing-password': 'Por favor, insira uma senha.',
      'auth/user-not-found': 'Email ou senha incorretos.',
      'auth/wrong-password': 'Email ou senha incorretos.',
      'auth/invalid-credential': 'Email ou senha incorretos.'
    };

    function traduzirErroFirebase(codigoErro) {
      return ERROR_MESSAGES[codigoErro] || 'Ocorreu um erro. Tente novamente.';
    }

    // Notificação otimizada
    let notificationElement = null;
    function showNotification(message, type = 'error') {
      if (!notificationElement) {
        notificationElement = document.createElement('div');
        notificationElement.style.cssText = `
          position: fixed; top: 20px; right: 20px; padding: 12px 18px;
          border-radius: 8px; color: white; font-weight: 600; z-index: 10000;
          opacity: 0; transform: translateY(-20px); transition: all 0.3s ease;
          max-width: 300px; pointer-events: none;
        `;
        document.body.appendChild(notificationElement);
      }
      
      notificationElement.textContent = message;
      notificationElement.style.backgroundColor = type === 'error' ? '#e53e3e' : '#38a169';
      notificationElement.style.opacity = '1';
      notificationElement.style.transform = 'translateY(0)';
      
      clearTimeout(notificationElement.hideTimer);
      notificationElement.hideTimer = setTimeout(() => {
        notificationElement.style.opacity = '0';
        notificationElement.style.transform = 'translateY(-20px)';
      }, 4000);
    }

    // Rate limiting
    let lastRequest = 0;
    const REQUEST_COOLDOWN = 2000;

    function canMakeRequest() {
      const now = Date.now();
      if (now - lastRequest < REQUEST_COOLDOWN) {
        return false;
      }
      lastRequest = now;
      return true;
    }

    // API otimizada
    window.firebaseAuth = {
      async authenticate(email, password, isRegister = false) {
        if (!canMakeRequest()) {
          showNotification('Aguarde alguns segundos antes de tentar novamente.', 'error');
          return { success: false };
        }

        try {
          if (!navigator.onLine) {
            showNotification('Sem conexão. Verifique sua internet.', 'error');
            return { success: false };
          }

          const { auth: firebaseAuth, modules } = await initFirebaseIfNeeded();
          
          const authMethod = isRegister 
            ? modules.createUserWithEmailAndPassword 
            : modules.signInWithEmailAndPassword;
          
          const authPromise = authMethod(firebaseAuth, email, password);
          const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error('Request timeout')), 10000)
          );
          
          const credential = await Promise.race([authPromise, timeoutPromise]);
          
          setAuthCache(credential.user.uid, {
            email: credential.user.email,
            lastLogin: Date.now(),
            authMethod: isRegister ? 'register' : 'login'
          });

          return { success: true, user: credential.user };
        } catch (error) {
          if (error.message === 'Request timeout') {
            return { success: false, error: 'Conexão lenta. Tente novamente.' };
          }
          return { success: false, error: traduzirErroFirebase(error.code) };
        }
      },
      
      showNotification,
      clearAuthCache,
      clearAuthCacheOnError,
      getAuthCache,
      isOnline: () => navigator.onLine
    };
  </script>

  <link rel="icon" type="image/svg+xml" href="./favicon/favicon.svg" />
  <link rel="shortcut icon" href="./favicon/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="./favicon/apple-touch-icon.png" />
  <link rel="manifest" href="./favicon/site.webmanifest" />

  <style>
    :root{
      --bg: #0b150f;
      --card: rgba(255,255,255,0.06);
      --glass: rgba(255,255,255,0.04);
      --accent: #9fccb1;
      --secondary: #39666b;
      --text: #e1efe6;
      --muted: rgba(225,239,230,0.6);
      --neumo-shadow: 10px 10px 20px rgba(0,0,0,0.6), -6px -6px 16px rgba(255,255,255,0.02);
      --radius: 14px;
      --max-width:1200px;
      --gap:18px;
      --btn-grad: linear-gradient(135deg,#4f46e5,#7c3aed);
      --btn-glow-grad: linear-gradient(135deg, rgba(79,70,229,0.28), rgba(124,58,237,0.28));
      --cta-contrast: #ffffff;
      --glow-hero: rgba(200,210,220,0.06);
      --glow-panel: rgba(170,180,190,0.045);
      --hover-ease: cubic-bezier(.15,.9,.25,1);
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family:"Inter",system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background-color: #0b0c0f;
      color: var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:28px;display:flex;align-items:center;justify-content:center;
      position:relative;z-index:0;
    }

    body::before{
      content: "";
      position:fixed;inset:0;pointer-events:none;z-index:0;
      background:
        radial-gradient(900px 340px at 8% 12%, rgba(255,255,255,0.035), transparent 30%),
        radial-gradient(700px 260px at 85% 78%, rgba(255,255,255,0.02), transparent 35%),
        linear-gradient(135deg, rgba(255,255,255,0.018), rgba(200,200,200,0.008));
      filter: blur(18px) saturate(102%);
      opacity: 0.9;mix-blend-mode:soft-light;
    }

    .wrap{
      width:100%;max-width:1100px;display:grid;grid-template-columns:1fr 480px;gap:36px;align-items:center;z-index:1;
    }

    .brand{
      padding:18px;border-radius:var(--radius);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.03);backdrop-filter: blur(6px);box-shadow: 0 12px 40px rgba(0,0,0,0.6);
      display:flex;flex-direction:row;gap:16px;align-items:center;min-height:120px;max-width:520px;
    }

    .logo-mark{
      width:72px;height:72px;border-radius:12px;
      background:linear-gradient(135deg,var(--accent),var(--secondary));
      display:flex;align-items:center;justify-content:center;font-weight:800;color:#07120f;font-size:22px;box-shadow:var(--neumo-shadow);
    }
    .logo-mark img{
      width:70%;
      height:70%;
      object-fit:contain;
      display:block;
      margin:auto;
    }

    .brand-text{display:flex;flex-direction:column;gap:4px}
    .brand-text h3{margin:0;font-size:18px}
    .brand-text p{margin:0;color:var(--muted);font-size:13px}
    .brand-desc{margin-top:6px;color:rgba(225,239,230,0.72);font-size:13px;max-width:36ch}

    .card{
      background:var(--card);border-radius:18px;padding:26px;backdrop-filter: blur(10px);border:1px solid rgba(255,255,255,0.04);box-shadow: 0 12px 40px rgba(0,0,0,0.6);
      width:100%;max-width:480px;position:relative;overflow:hidden;
    }

    .tabs{display:flex;gap:8px;margin-bottom:14px}
    .tab{flex:1;padding:10px 14px;border-radius:12px;text-align:center;font-weight:600;cursor:pointer;color:var(--muted);transition:all .28s var(--hover-ease)}
    .tab.active{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:var(--text);box-shadow: inset 0 -2px 0 rgba(255,255,255,0.02)}

    form{display:grid;gap:12px}
    label{font-size:13px;color:var(--muted)}

    input[type="text"],input[type="email"],input[type="password"],select{
      width:100%;padding:14px 46px 14px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));color:var(--text);
      outline:none;font-size:14px;transition:all .28s var(--hover-ease);box-shadow: inset 0 4px 12px rgba(0,0,0,0.4);
    }
    input:focus{transform:translateY(-2px);box-shadow:0 18px 40px rgba(0,0,0,0.6), 0 0 0 4px rgba(79,70,229,0.06)}

    .field{position:relative;display:flex;flex-direction:column;gap:6px}
    .icon-right{position:absolute;right:12px;top:64%;transform:translateY(-52%);cursor:pointer;color:var(--muted);font-size:16px;transition:all .22s var(--hover-ease);display:flex;align-items:center;justify-content:center;height:20px}
    .icon-right:hover{color:var(--text);transform:translateY(-52%) scale(1.06)}

    .muted{color:var(--muted);font-size:13px}

    .btn{margin-top:8px;padding:12px 16px;border-radius:12px;border:none;cursor:pointer;font-weight:700;letter-spacing:0.02em;box-shadow: var(--neumo-shadow);background:var(--btn-grad);color:var(--cta-contrast);font-size:15px;transition:all .25s var(--hover-ease)}
    .btn:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 28px 80px rgba(79,70,229,0.18)}
    .btn:disabled{opacity:0.6;cursor:not-allowed;transform:none}

    .secondary-btn{
      background:transparent;
      border:1px solid rgba(255,255,255,0.04);
      padding:10px 12px;
      border-radius:10px;
      color:var(--muted);
      font-weight:600;
      transition:all .22s var(--hover-ease);
      cursor: pointer;
    }
    .secondary-btn:hover{color:var(--text);border-color:rgba(255,255,255,0.06)}

    .success-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;border-radius:18px;backdrop-filter: blur(6px);opacity:0;pointer-events:none;background:linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.55))}
    .success-box{color:var(--text);text-align:center}
    .check{width:110px;height:110px;border-radius:55px;background:linear-gradient(135deg,var(--accent),var(--secondary));display:flex;align-items:center;justify-content:center;font-size:48px;color:#07120f;box-shadow:0 12px 40px rgba(0,0,0,0.5)}
    .success-text{margin-top:12px;font-weight:700}

    .row{display:flex;justify-content:space-between;align-items:center;gap:12px}

    @media (max-width:900px){
      :root{
    --neumo-shadow: 0 6px 14px rgba(0,0,0,0.45);
    --btn-glow-grad: linear-gradient(135deg, rgba(79,70,229,0.14), rgba(124,58,237,0.14));
    --hover-ease: cubic-bezier(.2,.9,.3,1);
  }

      .wrap{grid-template-columns:1fr;gap:20px;padding:0 12px}
      .brand{justify-content:center;text-align:left}
    }

    @media (max-width:420px){
      .logo-mark{width:56px;height:56px}
      .card{padding:18px}
      .logo-mark img{width:60%;height:60%}
    }

    input:-webkit-autofill,
    textarea:-webkit-autofill,
    select:-webkit-autofill {
      -webkit-box-shadow: 0 0 0px 1000px rgba(11,12,15,0.78) inset !important;
      box-shadow: 0 0 0px 1000px rgba(11,12,15,0.78) inset !important;
      -webkit-text-fill-color: var(--text) !important;
      transition: background-color 5000s ease-in-out 0s !important;
    }
    input:-webkit-autofill:focus,
    textarea:-webkit-autofill:focus,
    select:-webkit-autofill:focus{
      -webkit-box-shadow: 0 0 0px 1000px rgba(11,12,15,0.78) inset !important;
      box-shadow: 0 0 0px 1000px rgba(11,12,15,0.78) inset !important;
      -webkit-text-fill-color: var(--text) !important;
    }
    input:-moz-autofill,
    textarea:-moz-autofill,
    select:-moz-autofill {
      box-shadow: 0 0 0px 1000px rgba(11,12,15,0.78) inset !important;
      -moz-text-fill-color: var(--text) !important;
    }
  </style>
</head>
<body>
  <div class="wrap" id="wrap">

    <aside class="brand" aria-hidden="false">
      <div class="logo-mark">
        <img src="./favicon/favicon.svg" alt="Logo">
      </div>
      <div class="brand-text">
        <h3>Detroit</h3>
        <p class="brand-sub">Estrutura | Login</p>
        <p class="brand-desc">Plataforma de registro de mão de obra e envio de apropriações com foco em velocidade e conformidade.</p>
      </div>
    </aside>

    <main class="card" role="region" aria-label="Registro e Login">

      <div class="tabs" role="tablist">
        <div class="tab active" id="tab-register" role="tab" aria-selected="true">Registrar</div>
        <div class="tab" id="tab-login" role="tab" aria-selected="false">Entrar</div>
      </div>

      <form id="authForm" autocomplete="on" novalidate>

        <div class="field" id="field-name">
          <label for="name">Nome completo</label>
          <input id="name" name="name" type="text" placeholder="Nome e sobrenome" autocomplete="name" />
        </div>

        <div class="field">
          <label for="email">Email</label>
          <input id="email" name="email" type="email" placeholder="seunome@empresa.com" required autocomplete="email" />
          <i class="fa-solid fa-envelope icon-right" aria-hidden="true" title="Email"></i>
        </div>

        <div class="field">
          <label for="password">Senha</label>
          <input id="password" name="password" type="password" placeholder="Mínimo 8 caracteres" required aria-describedby="pwdHelp" autocomplete="current-password" />
          <i class="fa-solid fa-eye icon-right" id="togglePwd" title="Mostrar senha" aria-hidden="false"></i>
        </div>

        <div class="row" style="margin-top:4px">
          <div class="muted" id="pwdHelp">Senha oculta por padrão</div>
          <a href="#" class="muted" style="text-decoration:none">Esqueceu a senha?</a>
        </div>

        <button type="submit" class="btn" id="submitBtn"><span id="btnLabel">Registrar</span></button>
        <button type="button" class="secondary-btn" id="altAction">Já tem conta? Entrar</button>

      </form>

      <div class="success-overlay" id="successOverlay" aria-hidden="true">
        <div class="success-box">
          <div class="check" id="check">✓</div>
          <div class="success-text" id="successText">Registro concluído com sucesso!</div>
        </div>
      </div>

    </main>
  </div>

  <script>
    // Elements
    const tabRegister = document.getElementById('tab-register');
    const tabLogin = document.getElementById('tab-login');
    const fieldName = document.getElementById('field-name');
    const altAction = document.getElementById('altAction');
    const submitBtn = document.getElementById('submitBtn');
    const btnLabel = document.getElementById('btnLabel');
    const authForm = document.getElementById('authForm');
    const togglePwd = document.getElementById('togglePwd');
    const passwordInput = document.getElementById('password');
    const successOverlay = document.getElementById('successOverlay');
    const successText = document.getElementById('successText');

    let mode = 'register';
    let isSubmitting = false;

    function setMode(m){
      mode = m;
      const nameField = document.getElementById('name');
      
      if(mode === 'register'){
        tabRegister.classList.add('active'); 
        tabRegister.setAttribute('aria-selected','true');
        tabLogin.classList.remove('active'); 
        tabLogin.setAttribute('aria-selected','false');
        btnLabel.textContent = 'Registrar';
        altAction.textContent = 'Já tem conta? Entrar';
        fieldName.style.display = 'flex';
        if(nameField) nameField.setAttribute('autocomplete', 'name');
        passwordInput.setAttribute('autocomplete', 'new-password');
      } else {
        tabLogin.classList.add('active'); 
        tabLogin.setAttribute('aria-selected','true');
        tabRegister.classList.remove('active'); 
        tabRegister.setAttribute('aria-selected','false');
        btnLabel.textContent = 'Entrar';
        altAction.textContent = 'Criar nova conta';
        fieldName.style.display = 'none';
        passwordInput.setAttribute('autocomplete', 'current-password');
      }
    }

    // Toggle tabs
    tabRegister.addEventListener('click', ()=> setMode('register'));
    tabLogin.addEventListener('click', ()=> setMode('login'));
    altAction.addEventListener('click', ()=> setMode(mode === 'register' ? 'login' : 'register'));

    // Password toggle
    function setPwdIcon(hidden){
      togglePwd.classList.remove('fa-eye','fa-eye-slash');
      togglePwd.classList.add(hidden ? 'fa-eye' : 'fa-eye-slash');
    }
    setPwdIcon(true);

    togglePwd.addEventListener('click', ()=>{
      const isPwd = passwordInput.getAttribute('type') === 'password';
      passwordInput.setAttribute('type', isPwd ? 'text' : 'password');
      setPwdIcon(!isPwd);
      if(window.gsap) gsap.fromTo(passwordInput,{x:-4,opacity:0.96},{x:0,opacity:1,duration:0.25,ease:'power1.out'});
    });

    // Form submit otimizado
    authForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      
      if (isSubmitting) return;
      
      const email = document.getElementById('email').value.trim();
      const pwd = passwordInput.value;
      const name = document.getElementById('name').value.trim();

      // Validações ajustadas por modo
      if(!email || !pwd || (mode === 'register' && name.length < 2)){
        if(window.gsap) gsap.fromTo(submitBtn,{x:-6},{x:6,duration:0.08,yoyo:true,repeat:3,ease:'power1.inOut'});
        return;
      }

      isSubmitting = true;
      submitBtn.disabled = true;
      const originalText = btnLabel.textContent;
      btnLabel.textContent = 'Processando...';

      try {
        const result = await window.firebaseAuth.authenticate(email, pwd, mode === 'register');
        
        if (result.success) {
          window.firebaseAuth.showNotification(
            mode === 'register' ? "Conta criada com sucesso!" : "Login realizado!", 
            'success'
          );
          
          successText.textContent = mode === 'register' ? 'Registro concluído!' : 'Login bem-sucedido!';
          successOverlay.style.pointerEvents = 'auto';
          
          if(window.gsap){
            gsap.to(successOverlay,{opacity:1,duration:0.35,ease:'power2.out'});
            gsap.fromTo('#check',{scale:0,rotation:0},{scale:1.05,rotation:12,duration:0.45,ease:'back.out(1.4)'});
            gsap.to(successOverlay,{opacity:0,duration:0.6,delay:1.1,ease:'power2.in',onComplete:()=>{ 
              successOverlay.style.pointerEvents='none';
              window.location.href = './dashboard.html';
            }});
          } else {
            successOverlay.style.opacity = '1';
            setTimeout(()=>{ 
              successOverlay.style.opacity = '0'; 
              successOverlay.style.pointerEvents='none'; 
              window.location.href = './dashboard.html';
            }, 1400);
          }
        } else {
          window.firebaseAuth.showNotification(result.error, 'error');
          if(window.gsap) {
            gsap.fromTo(submitBtn,{x:-6},{x:6,duration:0.08,yoyo:true,repeat:3,ease:'power1.inOut'});
          }
        }
      } catch (error) {
        window.firebaseAuth.showNotification('Erro inesperado. Tente novamente.', 'error');
        if(window.gsap) {
          gsap.fromTo(submitBtn,{x:-6},{x:6,duration:0.08,yoyo:true,repeat:3,ease:'power1.inOut'});
        }
      } finally {
        isSubmitting = false;
        submitBtn.disabled = false;
        btnLabel.textContent = originalText;
      }
    });

    // Entrance animations
    window.addEventListener('load', ()=>{
      if(window.gsap){
        gsap.from('#wrap .brand',{opacity:0,y:18,duration:0.9,ease:'power3.out'});
        gsap.from('#wrap .card',{opacity:0,y:28,duration:1,ease:'power3.out',delay:0.12});
        gsap.from('#authForm .field',{opacity:0,y:10,duration:0.8,stagger:0.08,delay:0.22});
      }
    });

    // Accessibility
    document.addEventListener('keydown', (e)=>{ 
      if(e.key==='Escape'){ 
        passwordInput.setAttribute('type','password'); 
        setPwdIcon(true); 
      } 
    });

    // Inicializa no modo registro
    setMode('register');
  </script>
</body>
</html>