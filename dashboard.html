<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Site/Aplicativo para realizar as apropriações">
  <title>Estrutura | Apropriação</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <!-- Firebase -->
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="icon" type="image/png" href="./favicon/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="./favicon/favicon.svg" />
<link rel="shortcut icon" href="./favicon/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="./favicon/apple-touch-icon.png" />
<link rel="manifest" href="./favicon/site.webmanifest" />
<!-- <link rel="stylesheet" href="./theme.css"> -->
 <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    /* ===== LUXURY VARIABLES ===== */
    :root {
      --bg: #0b0c0f;
      --card: rgba(255,255,255,0.04);
      --glass: rgba(255,255,255,0.03);
      --accent: #9fccb1;
      --accent-strong: #3b82f6;
      --secondary: #39666b;
      --text: #e1efe6;
      --muted: rgba(225,239,230,0.68);
      --muted-2: rgba(225,239,230,0.48);
      --neumo-shadow: 0 8px 20px rgba(0,0,0,0.45);
      --radius: 14px;
      --max-width: 1200px;
      --gap: 18px;
      --btn-grad: linear-gradient(135deg,#4f46e5,#7c3aed);
      --btn-glow-grad: linear-gradient(135deg, rgba(79,70,229,0.28), rgba(124,58,237,0.28));
      --cta-contrast: #ffffff;
      --hover-ease: cubic-bezier(.15,.9,.25,1);
      --danger: #ef4444;
      --warning: #f59e0b;
      --success: #10b981;
      --sidebar-w: 260px;
      --soft-border: rgba(255,255,255,0.08);
      --input-bg: rgba(255,255,255,0.02);
      --input-border: rgba(255,255,255,0.08);
    }

    *{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:'Inter', system-ui, Arial, sans-serif;
  background-color:var(--bg);
  color:var(--text);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  line-height:1.35;
  overflow-x:hidden;
  position:relative;
  -webkit-tap-highlight-color: transparent;
}

    /* Background particles effect (subtle kept but aligned with solid background) */
    body::before{
  content:'';
  position:fixed; inset:0;
  background:
    radial-gradient(circle at 20% 50%, rgba(159,204,177,0.02) 0%, transparent 45%),
    radial-gradient(circle at 80% 20%, rgba(110,116,120,0.03) 0%, transparent 50%);
  z-index:-1;
  pointer-events:none;
  transform:translateZ(0);
}

    @media (min-width:769px){
  body::before{ animation: floatBg 20s ease-in-out infinite; }
}
@keyframes floatBg{
  0%,100%{ transform: translateY(0) rotate(0deg); }
  50%{ transform: translateY(-20px) rotate(2deg); }
}

    /* ===== SIDEBAR ===== */
    .sidebar {
      --bg-sidebar: #0b150f;
      --card-sidebar: rgba(255, 255, 255, 0.06);
      --glass-sidebar: rgba(255, 255, 255, 0.04);
      --accent-sidebar: #9fccb1;
      --secondary-sidebar: #39666b;
      --text-sidebar: #e1efe6;
      --muted-sidebar: rgba(225, 239, 230, 0.6);
      --neumo-shadow-sidebar: 10px 10px 20px rgba(0, 0, 0, 0.6), -6px -6px 16px rgba(255, 255, 255, 0.02);
      --radius-sidebar: 14px;
    }

    /* Sidebar styles (copiado - mantive exatamente) */
    .sidebar {
      width: 260px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
      color: var(--text-sidebar);
      padding: 20px 0;
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      z-index: 60;
      backdrop-filter: blur(6px) saturate(110%);
      border-right: 1px solid rgba(255, 255, 255, 0.03);
      overflow-y: auto;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      position: relative;
      padding: 0 20px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
      margin-bottom: 20px;
    }

    .brand {
      display: flex;
      gap: 14px;
      align-items: center;
    }

    .logo {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--accent-sidebar), var(--secondary-sidebar));
      box-shadow: var(--neumo-shadow-sidebar);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      color: white;
      font-size: 18px;
    }

    .brand-text h1 {
      font-size: 16px;
      margin: 0;
      color: var(--text-sidebar);
      font-weight: 600;
    }

    .brand-text p {
      margin: 0;
      font-size: 12px;
      opacity: 0.75;
      color: var(--muted-sidebar);
    }

    .hamburger {
      display: none;
      background: var(--glass-sidebar);
      border: 1px solid rgba(255, 255, 255, 0.02);
      border-radius: 10px;
      color: var(--muted-sidebar);
      font-size: 18px;
      width: 44px;
      height: 44px;
      position: absolute;
      left: 15px;
      cursor: pointer;
      align-items: center;
      justify-content: center;
    }

    nav ul {
      list-style: none;
      padding: 0 12px;
    }

    nav ul li {
      margin: 8px 0;
    }

    nav ul li a {
      text-decoration: none;
      color: var(--muted-sidebar);
      display: flex;
      align-items: center;
      padding: 10px 14px;
      border-radius: 10px;
      transition: all 0.2s;
      font-weight: 500;
      font-size: 14px;
    }

    nav ul li a i {
      margin-right: 12px;
      width: 20px;
      text-align: center;
    }

    nav ul li a:hover,
    nav ul li a.active {
      color: var(--text-sidebar);
      background: rgba(255, 255, 255, 0.03);
    }

    /* Botão de Observa+ com estilo especial */
    nav ul li:nth-child(5) a {
      background: linear-gradient(135deg, var(--accent-sidebar), var(--secondary-sidebar));
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: 0 12px 40px rgba(70, 229, 123, 0.12), inset 0 -6px 18px rgba(255, 255, 255, 0.02);
      margin-top: 15px;
    }

    nav ul li:nth-child(5) a:hover {
      filter: brightness(1.08);
      box-shadow: 0 2px 80px rgba(70, 229, 150, 0.18), -4px -4px 10px rgba(58, 237, 133, 0.04);
    }
    
    /* Ícone branco para o botão gradiente em desktop também */
    nav ul li:nth-child(5) a i {
      color: white;
    }

    /* ===== MAIN CONTAINER ===== */
    .container{
  margin-left: var(--sidebar-w);
  max-width: var(--max-width);
  padding: 28px 20px;
  box-sizing:border-box;
  opacity:0;
  animation: pageLoad 1.2s cubic-bezier(.15,.9,.25,1) 0.3s forwards;
  min-height:100vh;
}
@keyframes pageLoad{ from{opacity:0; transform:translateY(30px)} to{opacity:1; transform:translateY(0)} }


    /* ===== HEADER ===== */
    header.topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding: 16px 20px;
      border-radius: 14px;
      border: 1px solid var(--soft-border);
      box-shadow: 0 8px 32px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.1);
      margin-bottom: 24px;
      backdrop-filter: blur(16px);
    }

    header h2{
      margin-bottom: 1rem;
    }

    .topbar h2 {
      margin: 0;
      font-size: 24px;
      font-weight: 600;
      letter-spacing: -0.5px;
      background: linear-gradient(135deg, var(--text) 0%, var(--accent) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* ===== GLASS CARDS ===== */
    .panel, .form-section{
  background: rgba(255,255,255,0.04);
  backdrop-filter: blur(16px);
  border:1px solid rgba(255,255,255,0.08);
  padding:24px; border-radius:var(--radius);
  margin-bottom:24px; position:relative; overflow:hidden;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
  transition: transform 0.4s cubic-bezier(.15,.9,.25,1), box-shadow 0.4s cubic-bezier(.15,.9,.25,1);
  animation: cardSlideIn 0.6s cubic-bezier(.15,.9,.25,1) both;
  contain: layout style paint;
}
@keyframes cardSlideIn{ from{opacity:0; transform:translateY(40px) scale(.98)} to{opacity:1; transform:translateY(0) scale(1)} }

.panel::before, .form-section::before{
  content:''; position:absolute; top:0; left:0; right:0; height:1px;
  background: linear-gradient(90deg, transparent 0%, var(--accent) 50%, transparent 100%);
  opacity:0.3;
}
.panel:hover, .form-section:hover{
  transform: translateY(-2px);
  box-shadow: 0 12px 30px rgba(0,0,0,0.45);
  border-color: rgba(159,204,177,0.10);
}

    @media (hover: hover) and (pointer: fine) {
    .panel:hover,.form-section:hover{
        transform:translateY(-2px);
        box-shadow:
        0 12px 40px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
      border-color: rgba(159, 204, 177, 0.2);
    }
}

    .form-section h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      letter-spacing: -0.3px;
      position: relative;
    }

    .form-section h3 i {
      margin-right: 10px;
      font-size: 16px;
      color: var(--accent);
      background: rgba(159, 204, 177, 0.1);
      padding: 6px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(159, 204, 177, 0.2);
    }

    .outros {
      color: var(--muted);
      margin-top: 24px;
      font-size: 16px;
      font-weight: 500;
    }

    /* ===== FORM ELEMENTS ===== */
    .form-row {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      margin-bottom: 18px;
      align-items: center;
    }

    .form-row label {
      flex: 1 1 120px;
      color: var(--muted);
      font-weight: 400;
      font-size: 13px;
      letter-spacing: 0.2px;
    }

    .form-row input,
    .form-row select,
    .form-row textarea {
      flex: 2 1 200px;
      padding: 12px 14px;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 10px;
      font-size: 14px;
      color: var(--text);
      font-weight: 300;
      backdrop-filter: blur(4px);
      transition: all 0.3s var(--hover-ease);
      font-family: inherit;
    }

    .form-row input:focus,
    .form-row select:focus,
    .form-row textarea:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255, 255, 255, 0.06);
      box-shadow:
        0 0 0 3px rgba(159, 204, 177, 0.1),
        0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .form-row textarea {
      resize: vertical;
      min-height: 44px;
      font-family: inherit;
    }

    /* Radio Buttons Premium */
    .radio-group {
      display: flex;
      gap: 24px;
      align-items: center;
    }

    .radio-group label {
      position: relative;
      padding-left: 28px;
      cursor: pointer;
      font-size: 14px;
      user-select: none;
      color: var(--muted);
      font-weight: 400;
      transition: color 0.3s var(--hover-ease);
    }

    .radio-group input[type="radio"] {
      position: absolute;
      opacity: 0;
      cursor: pointer;
    }

    .radio-group label::before {
      content: "";
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(8px);
      transition: all 0.3s var(--hover-ease);
    }

    .radio-group input[type="radio"]:checked + label {
      color: var(--text);
    }

    .radio-group input[type="radio"]:checked + label::before {
      border-color: var(--accent);
      background: rgba(159, 204, 177, 0.1);
      box-shadow: inset 0 0 0 4px var(--accent);
    }

    /* ===== BUTTONS (PRIMARY USE GRADIENT, SUBMIT GREEN, DELETE RED) ===== */

    .btn {
      background: var(--btn-grad);
      color: var(--cta-contrast);
      padding: 10px 20px;
      border: 1px solid rgba(255,255,255,0.04);
      border-radius: 10px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      font-family: inherit;
      letter-spacing: 0.3px;
      backdrop-filter: blur(12px);
      transition: all 0.3s var(--hover-ease);
      position: relative;
      overflow: hidden;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 12px 40px rgba(79,70,229,0.12), inset 0 -6px 18px rgba(255,255,255,0.02);
      will-change:transform,box-shadow;
    }

    .btn:hover{ transform: translateY(-2px); box-shadow: 0 18px 50px rgba(79,70,229,0.14), inset 0 -6px 18px rgba(255,255,255,0.03); }
.btn:active{ transform: translateY(0); box-shadow: inset 0 6px 18px rgba(0,0,0,0.2); }
.btn i{ font-size:14px; transition: transform 0.3s cubic-bezier(.15,.9,.25,1); }
.btn:hover i{ transform: scale(1.1); }

    /* Submit Button Special: green with standard green box-shadow (kept as requested) */
    #submitRecordBtn{
  background: linear-gradient(135deg, var(--success), #059669);
  border:1px solid rgba(16,185,129,0.3); color:white; font-weight:600;
  box-shadow:0 8px 25px rgba(16,185,129,0.3);
}
#submitRecordBtn:hover{
  background: linear-gradient(135deg, #10b981, var(--success));
  box-shadow: 0 10px 30px rgba(16,185,129,0.36), 0 0 0 4px rgba(16,185,129,0.08);
  transform: translateY(-2px);
}

    /* Edit/Create Buttons - use gradient background but normal border (no border-image) */
    #editTeamBtn{ background:var(--btn-grad); color:var(--cta-contrast); border:1px solid rgba(255,255,255,0.06); }
#editTeamBtn:hover{ transform: translateY(-2px); box-shadow: 0 18px 50px rgba(79,70,229,0.14); }


    /* Delete Button: must stay red */
    .icon-btn {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      border: 1px solid rgba(239, 68, 68, 0.3);
      cursor: pointer;
      background: linear-gradient(135deg, var(--danger), #dc2626);
      color: white;
      backdrop-filter: blur(12px);
      transition: all 0.3s var(--hover-ease);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      box-shadow: 0 12px 40px rgba(220, 53, 69, 0.12), inset 0 -6px 18px rgba(255,255,255,0.02);
    }

    .icon-btn:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow:
        0 18px 50px rgba(220, 53, 69, 0.16),
        inset 0 -6px 18px rgba(255,255,255,0.03);
    }

    /* Manage Actions */
    .manage-actions {
      display: inline-flex;
      gap: 12px;
      align-items: center;
    }

    .btn-edit-wide {
      min-width: 140px;
      height: 44px;
    }

    /* ===== TABLE STYLING ===== */
    .table-wrapper{
  overflow:hidden; border-radius:var(--radius);
  background: rgba(255,255,255,0.02); backdrop-filter: blur(12px);
  border:1px solid rgba(255,255,255,0.05); margin-top:20px; max-height:400px; overflow-y:auto;
}
.table-wrapper::-webkit-scrollbar{ width:8px; height:8px; }
.table-wrapper::-webkit-scrollbar-track{ background: rgba(255,255,255,0.02); border-radius:4px; }
.table-wrapper::-webkit-scrollbar-thumb{ background: rgba(159,204,177,0.3); border-radius:4px; transition:background 0.3s; }
.table-wrapper::-webkit-scrollbar-thumb:hover{ background: rgba(159,204,177,0.5); }

table{ width:100%; border-collapse:collapse; color:var(--text); }
th{
  background: rgba(110,116,120,0.06); color:var(--text); font-weight:600; font-size:12px; letter-spacing:0.5px;
  text-transform:uppercase; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,0.08);
  position:sticky; top:0; backdrop-filter: blur(12px);
}
td{ padding:14px 16px; border-bottom:1px solid rgba(255,255,255,0.05); font-size:13px; font-weight:300; transition: background-color 0.2s ease; }
tr:hover td{ background: rgba(159,204,177,0.03); }

    /* ===== CHECKBOXES ===== */
    .absentLabel input[type="checkbox"] {
      appearance: none;
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.02);
      position: relative;
      transition: all 0.3s var(--hover-ease);
      backdrop-filter: blur(8px);
    }

    .absentLabel input[type="checkbox"]:checked {
      background: var(--accent);
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(159, 204, 177, 0.2);
    }

    .absentLabel input[type="checkbox"]:checked::after {
      content: "✓";
      position: absolute;
      top: -2px;
      left: 6px;
      color: white;
      font-size: 18px;
      font-weight: bold;
    }

    /* ===== ABONAR WRAPPER ===== */
    .abonar-wrap {
      display: none;
      flex-direction: row;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(8px);
    }

    .abonar-wrap.visible {
      display: flex !important;
    }

    .abonar-dsr {
      font-size: 12px;
      color: var(--muted);
      font-weight: 400;
      margin: 0;
    }

    /* ===== MODAL STYLING ===== */
    .notification-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: modalFadeIn 0.3s var(--hover-ease);
    }

    @keyframes modalFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .notification-content {
      background: linear-gradient(180deg, rgba(11,12,15,0.95), rgba(16,18,17,0.98));
      border: 1px solid rgba(110,116,120,0.10);
      padding: 28px 32px;
      max-width: 420px;
      width: 90%;
      text-align: center;
      border-radius: 14px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.7);
      animation: modalSlideIn 0.4s var(--hover-ease);
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .notification-content p {
      margin-bottom: 20px;
      color: var(--text);
      font-size: 15px;
      line-height: 1.5;
      font-weight: 400;
    }

    /* ===== STATUS INDICATORS ===== */
    #sync-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, var(--success), #059669);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      opacity: 0;
      transition: all 0.4s var(--hover-ease);
      z-index: 10000;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(16, 185, 129, 0.3);
      box-shadow: 0 4px 16px rgba(16, 185, 129, 0.2);
    }

    #sync-indicator.show {
      opacity: 1;
      transform: translateY(0);
    }

    .connection-status {
      position: fixed;
      top: 60px;
      right: 20px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      z-index: 9999;
      backdrop-filter: blur(12px);
      transition: all 0.3s ease;
    }

    .connection-status.online {
      background: linear-gradient(135deg, var(--success), #059669);
      color: white;
      display: none;
    }

    .connection-status.offline {
      background: linear-gradient(135deg, var(--danger), #dc2626);
      color: white;
      opacity: 1 !important;
    }

    .cache-status {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 10px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--muted);
      backdrop-filter: blur(8px);
      opacity: 0.7;
      z-index: 9999;
    }

    /* Create Team Area Animation */
    #createTeamArea {
      animation: slideDown 0.4s var(--hover-ease);
      overflow: hidden;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        max-height: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        max-height: 1000px;
        transform: translateY(0);
      }
    }

    @media (max-width: 768px) {
    .btn,
    .form-row input,
    .form-row select,
    .form-row textarea {
        will-change: auto;
    }
}

    /* responsive */
    @media (max-width:1000px){
      .container{ 
        margin-left: 0;
        margin-top: 80px; /* altura da navbar fechada aumentada */
        padding: 18px; 
        transition: margin-top 0.4s ease; 
      }
      .controls{ grid-template-columns: 1fr; }
      
      .sidebar { 
        width: 100%;
        height: auto;
        min-height: 80px; /* altura maior para melhor visibilidade */
        max-height: 80px;
        position: fixed;
        top: 0;
        left: 0;
        flex-direction: column;
        align-items: stretch;
        padding: 0;
        overflow: hidden;
        transition: max-height 0.4s ease;
        border-right: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08); /* borda mais visível */
        z-index: 1000;
        backdrop-filter: blur(12px) saturate(140%); /* blur mais forte */
      }
      
      .sidebar.active {
        max-height: 520px;
        overflow-y: auto;
      }
      
      .sidebar-header {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        padding: 18px 20px; /* padding maior */
        margin: 0;
        border: none;
        width: 100%;
        min-height: 80px;
        box-sizing: border-box;
      }
      
      .brand {
        flex-direction: row;
        gap: 14px; /* gap maior */
        align-items: center;
      }
      
      .brand-text {
        display: block;
      }
      
      .brand-text h1 {
        font-size: 16px; /* fonte maior */
        font-weight: 700;
        color: var(--text-sidebar);
      }
      
      .brand-text p {
        display: none;
      }
      
      .logo {
        width: 48px; /* logo maior */
        height: 48px;
        font-size: 20px;
        box-shadow: 0 8px 25px rgba(159, 204, 177, 0.15), inset 0 2px 8px rgba(255,255,255,0.05); /* sombra mais visível */
      }
      
      .hamburger {
        display: flex;
        position: static;
        margin: 0;
        order: 2;
        width: 48px; /* botão maior */
        height: 48px;
        font-size: 20px;
        background: rgba(255, 255, 255, 0.06); /* fundo mais visível */
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        color: var(--text-sidebar);
        transition: all 0.3s var(--hover-ease);
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      }
      
      .hamburger:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.4);
      }
      
      .hamburger:active {
        transform: translateY(0);
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      }
      
      #sidebarNav {
        width: 100%;
        padding: 8px 20px 20px;
        box-shadow: none;
        display: block !important;
        opacity: 0;
        transition: opacity 0.3s ease 0.1s;
      }
      
      .sidebar.active #sidebarNav {
        opacity: 1;
      }
      
      nav ul {
        display: flex;
        flex-direction: column;
        gap: 14px; /* gap ainda maior para melhor espaçamento */
        padding: 0;
        margin: 0;
      }
      
      nav ul li {
        margin: 0;
      }
      
      nav ul li a {
        padding: 14px 16px; /* padding maior */
        font-size: 15px; /* fonte ligeiramente maior */
        font-weight: 600; /* peso da fonte maior */
        border-radius: 12px;
        transition: all 0.25s var(--hover-ease);
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.03);
        color: var(--text-sidebar);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      }
      
      nav ul li a i {
        margin-right: 14px; /* margem maior do ícone */
        width: 22px; /* ícones maiores */
        font-size: 16px;
        color: var(--accent-sidebar);
      }
      
      nav ul li a:hover,
      nav ul li a.active {
        position: relative;
  color: #ffffff !important;                    /* texto branco */
  background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
  border-color: rgba(255,255,255,0.14);
  box-shadow: 0 8px 20px rgba(0,0,0,0.35);
  transform: translateX(6px) scale(1.01);
  transition: transform .22s var(--hover-ease), box-shadow .22s var(--hover-ease), background .2s ease;
  width: 95%;
  z-index: 6;
      }

      /* borda lateral colorida — guia visual forte, arredondada */
nav ul li a.active::before{
  content: "";
  position: absolute;
  left: -10px;                /* ajusta a posição para “saltar” levemente */
  top: 8px;
  bottom: 8px;
  width: 6px;
  border-radius: 6px;
  background: linear-gradient(180deg, var(--accent-sidebar), var(--secondary-sidebar));
  box-shadow: 0 6px 18px rgba(60,150,120,0.12), inset 0 -4px 12px rgba(255,255,255,0.03);
}

/* ícone: preenche com cor para reforçar sinal ativo */
nav ul li a.active i {
  color: var(--accent-sidebar) !important;
  filter: drop-shadow(0 4px 14px rgba(0,0,0,0.35));
  transform: translateX(2px);
  transition: transform .18s var(--hover-ease), color .18s;
}

/* acessibilidade: foco visível (keyboard/touch) */
nav ul li a:focus {
  outline: none;
  box-shadow: 0 10px 30px rgba(0,0,0,0.45), 0 0 0 3px rgba(155,204,177,0.06);
  transform: translateX(6px);
}
      
      /* Estilo especial para o botão Observa+ em mobile */
      nav ul li:nth-child(5) a {
        background: linear-gradient(135deg, var(--accent-sidebar), var(--secondary-sidebar));
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: 0 6px 20px rgba(70, 229, 123, 0.2), inset 0 1px 0 rgba(255,255,255,0.1);
        font-weight: 700;
      }
      
      nav ul li:nth-child(5) a i {
        color: white; /* ícone branco para contraste com fundo verde */
      }

      nav ul li:nth-child(5) a:hover {
        filter: brightness(1.1);
        transform: translateX(6px) translateY(-2px);
        box-shadow: 0 8px 25px rgba(70, 229, 150, 0.3);
      }
      
      nav ul li a span {
        display: inline;
        letter-spacing: 0.3px; /* espaçamento das letras */
      }
    }

    /* ===== ACTIVE somente em DESKTOP (telas maiores que 1000px) ===== */
@media (min-width:1001px) {
  /* item ativo na sidebar (desktop) */
  nav ul li a.active {
    position: relative;
    color: var(--text-sidebar) !important;
    background: linear-gradient(180deg, rgba(255,255,255,0.025), rgba(255,255,255,0.01));
    border-radius: 0 10px 10px 0;
    box-shadow: 0 10px 30px rgba(0,0,0,0.45);
    padding-left: 18px;
    transition: background .20s var(--hover-ease), box-shadow .22s var(--hover-ease), transform .18s;
    z-index: 5;
  }

  nav ul li a.active::before {
    content: "";
    position: absolute;
    left: 0;
    top: 8px;
    bottom: 8px;
    width: 8px;
    border-radius: 0 6px 6px 0;
    background: linear-gradient(180deg, var(--accent-sidebar), var(--secondary-sidebar));
    box-shadow: 0 6px 18px rgba(60,150,120,0.12), inset 0 -4px 12px rgba(255,255,255,0.03);
  }

  nav ul li a.active i {
    color: var(--accent-sidebar) !important;
    transform: translateX(2px);
    filter: drop-shadow(0 6px 14px rgba(0,0,0,0.35));
    transition: transform .18s var(--hover-ease), color .18s;
  }

  /* hover leve só no desktop (não afeta mobile) */
  nav ul li a:hover:not(.active) {
    background: rgba(255,255,255,0.02);
    transform: translateX(4px);
    box-shadow: none;
  }

  nav ul li a:focus {
    outline: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 0 4px rgba(155,204,177,0.06);
  }

  /* Botão de Observa+ com estilo especial */
    nav ul li:nth-child(5) a {
      background: linear-gradient(135deg, var(--accent-sidebar), var(--secondary-sidebar)) !important;
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: 0 12px 40px rgba(70, 229, 123, 0.12), inset 0 -6px 18px rgba(255, 255, 255, 0.02);
      margin-top: 15px;
    }

    nav ul li:nth-child(5) a:hover {
      filter: brightness(1.08);
      box-shadow: 0 2px 80px rgba(70, 229, 150, 0.18), -4px -4px 10px rgba(58, 237, 133, 0.04);
    }
    
    /* Ícone branco para o botão gradiente em desktop também */
    nav ul li:nth-child(5) a i {
      color: white;
    }
}
    
    @media (max-width:560px){
      header.topbar{ flex-direction:column; align-items:flex-start; gap:10px }
      .preview .preview-head{ flex-direction:column; align-items:flex-start; gap:8px }
      
      .sidebar-header {
        padding: 16px 18px;
      }
      
      .brand-text h1 {
        font-size: 15px;
      }
      
      .logo {
        width: 44px;
        height: 44px;
        font-size: 18px;
      }
      
      .hamburger {
        width: 44px;
        height: 44px;
        font-size: 18px;
      }
      
      nav ul li a {
        padding: 12px 14px;
        font-size: 14px;
      }
      
      nav ul li a i {
        width: 20px;
        font-size: 15px;
      }

      :root{
  --sidebar-blur-default: 8px;      /* desktop */
  --sidebar-blur-mobile: 4px;       /* mobile (leve) */
  --card-blur-default: 16px;
  --card-blur-mobile: 6px;
  --shadow-heavy: 0 12px 40px rgba(0,0,0,.4);
  --shadow-light: 0 4px 12px rgba(0,0,0,.25);
  --anim-duration-default: 0.4s;
  --anim-duration-mobile: 0.18s;
  --glass-dark-base: rgba(255,255,255,0.02);   /* vidro sutil */
  --glass-dark-top: rgba(255,255,255,0.01);
  --dark-overlay: rgba(0,0,0,0.60);
}

body::before{ display:none; animation:none !important; will-change:auto; }

/* variáveis específicas (escuro, sem verde) */
:root{
  --glass-dark-base: rgba(255,255,255,0.02);   /* vidro sutil */
  --glass-dark-top: rgba(255,255,255,0.01);
  --dark-overlay: rgba(0,0,0,0.60);            /* camada escura por cima do glass */
  --sidebar-text-high: rgba(225,239,230,0.98);
  --sidebar-muted-high: rgba(225,239,230,0.72);
  --sidebar-border-strong: rgba(255,255,255,0.06);
  --sidebar-backdrop-mobile: blur(6px) saturate(120%) brightness(.56) contrast(1.03);
  --sidebar-backdrop-closed: blur(4px) saturate(110%) brightness(.64);
}

/* mobile / tablet: glass escuro + overlay para contraste */
@media (max-width:1000px) {
 body::before{ display:none; animation:none !important; will-change:auto; }

  .sidebar {
    position: fixed; /* mantém comport. */
    /* camada base: vidro muito sutil + overlay escuro para contraste forte */
    background:
      linear-gradient(180deg, var(--glass-dark-top), var(--glass-dark-base));
    -webkit-backdrop-filter: var(--sidebar-backdrop-mobile);
    backdrop-filter: var(--sidebar-backdrop-mobile);
    border-bottom: 1px solid var(--sidebar-border-strong);
    color: var(--sidebar-text-high);
    box-shadow: none;             /* evita repaints caros */
    transition: max-height 0.28s ease, transform 0.28s ease, box-shadow 0.28s ease;
    overflow: hidden;
    z-index: 1000;
  }

  /* pseudo-camada escura que garante contraste mesmo sem white/green */
  .sidebar::after{
    content: "";
    position: absolute;
    inset: 0;
    pointer-events: none;
    background: linear-gradient(180deg, var(--dark-overlay), rgba(0,0,0,0.36));
    z-index: 1;
    border-radius: inherit;
    mix-blend-mode: normal;
  }

  /* conteúdo acima da camada escura */
  .sidebar > * { position: relative; z-index: 2; }

  /* versão "fechada" (economia) - blur reduzido */
  .sidebar:not(.active) {
    -webkit-backdrop-filter: var(--sidebar-backdrop-closed);
    backdrop-filter: var(--sidebar-backdrop-closed);
    max-height: 80px; /* padrão fechado */
  }

  /* quando abrir: revela suavemente sem repaint pesado */
  .sidebar.active {
    max-height: 520px;
    transform: translateY(0);
    overflow-y: auto;
  }

  /* nav / links: cores mais legíveis */
  nav ul li a {
    color: var(--sidebar-muted-high);
    background: transparent;
    border: 1px solid rgba(255,255,255,0.02);
  }

  nav ul li a:hover,
  nav ul li a.active {
    color: var(--sidebar-text-high);
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border-color: rgba(255,255,255,0.08);
    box-shadow: 0 8px 20px rgba(0,0,0,0.35);
    transform: translateX(4px);
  }

  /* hamburger: mais visível sobre o overlay escuro */
  .hamburger {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.08);
    color: var(--sidebar-text-high);
    z-index: 4;
  }

  /* transições suaves usando transform (GPU) */
  #sidebarNav {
    opacity: 0;
    transform: translateY(-8px);
    transition: opacity 0.26s ease, transform 0.26s ease;
    z-index: 2;
    pointer-events: none; /* evita clicks quando invisível */
  }
  .sidebar.active #sidebarNav {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  /* foco de acessibilidade com alto contraste */
  nav ul li a:focus {
    outline: none;
    box-shadow: 0 8px 26px rgba(0,0,0,0.5), 0 0 0 4px rgba(255,255,255,0.04);
    color: var(--sidebar-text-high);
  }

  nav ul li a:hover, nav ul li a.active {
  transform: translateX(3px);
  box-shadow: 0 6px 18px rgba(0,0,0,0.2);
}
.sidebar.active::-webkit-scrollbar-thumb { border-radius: 8px; }
}


  /* botões e inputs: desativa will-change pesado */
  .btn, .form-row input, .form-row select, .form-row textarea {
    will-change: auto !important;
    backface-visibility: hidden;
    transition-duration: var(--anim-duration-mobile);
  }

  /* cards e painéis: blur/sombra leves */
  .panel, .form-section {
    backdrop-filter: blur(var(--card-blur-mobile));
    box-shadow: var(--shadow-light);
    transition: transform var(--anim-duration-mobile) ease, box-shadow var(--anim-duration-mobile) ease;
  }

  /* ao clicar no hamburger — ativa visual completo e exibe nav */
  body.sidebar-open .sidebar {
    box-shadow: var(--shadow-heavy);
    backdrop-filter: blur(var(--sidebar-blur-default)) saturate(140%);
  }
  body.sidebar-open #sidebarNav { opacity: 1; pointer-events: auto; transform: translateY(0); }

  /* diminuir intensidade de hover/transforms para evitar repaints contínuos */
  nav ul li a:hover, nav ul li a.active {
    transform: translateX(3px) !important;
    box-shadow: 0 6px 18px rgba(0,0,0,.2) !important;
  }

  /* esconder efeitos de brilho em botões (pseudo) */
  .btn::before { display: none !important; }
    }

    /* ===== MOBILE RESPONSIVE (from diario.html) ===== */
    @media (max-width:1000px) {

    
  :root { --mobile-animation-scale: 1.8; }
  
      .form-section {
        padding: 20px;
        margin-bottom: 20px;
      }

      .form-row {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .form-row label,
      .form-row input,
      .form-row select,
      .form-row textarea {
        flex: 1 1 100%;
      }

      .radio-group {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }

      .manage-actions {
        flex-direction: column;
        gap: 8px;
        width: 100%;
      }

      .btn-edit-wide {
        width: 100%;
      }

      .icon-btn {
        width: 100%;
        height: 44px;
      }

      .table-wrapper {
        overflow-x: auto;
      }

      th, td {
        padding: 12px 14px;
        font-size: 13px;
      }

      .topbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
        padding: 16px;
      }

      .topbar h2 {
        font-size: 20px;
      }
    }

    @media (max-width:560px) {
      .sidebar-header {
        padding: 16px 18px;
      }

      .brand-text h1 {
        font-size: 15px;
      }

      .logo {
        width: 44px;
        height: 44px;
        font-size: 18px;
      }

      .hamburger {
        width: 44px;
        height: 44px;
        font-size: 18px;
      }

      nav ul li a {
        padding: 12px 14px;
        font-size: 14px;
      }

      nav ul li a i {
        width: 20px;
        font-size: 15px;
      }

      .form-section {
        padding: 16px;
      }

      .form-section h3 {
        font-size: 16px;
      }

      .btn {
        padding: 8px 16px;
        font-size: 13px;
      }
      
      
      .btn::before { display: none !important; }

      .btn, .form-row input, .form-row select, .form-row textarea {
    will-change: auto !important;
  }

  body::before {
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    filter: none !important;
    background: rgba(11,12,15,0.9) !important; /* translúcido simples */
    box-shadow: 0 6px 14px rgba(0,0,0,0.45) !important; /* sombra mais leve */
     will-change: transform;
    backface-visibility: hidden;
    transform: translateZ(0);
    animation: floatBg-mobile calc(20s * var(--mobile-animation-scale)) ease-in-out infinite;
  }

  tr:hover td { background: transparent; }


  @keyframes floatBg-mobile {
    0%   { transform: translate3d(0, 0, 0) rotate(0deg); }
    50%  { transform: translate3d(0, -12px, 0) rotate(1deg); }
    100% { transform: translate3d(0, 0, 0) rotate(0deg); }
  }

  /* 2) Cards: permitir leve elevação via transform/opacity só */
  .panel, .form-section {
    will-change: transform, opacity;
    backface-visibility: hidden;
    transform: translateZ(0);
    /* faça a entrada mais lenta/menor - menos “movimento” */
    animation: cardSlideInMobile calc(0.6s * var(--mobile-animation-scale)) ease both;
  }
  @keyframes cardSlideInMobile {
    from { opacity: 0; transform: translate3d(0, 8px, 0) scale(.996); }
    to   { opacity: 1; transform: translate3d(0, 0, 0) scale(1); }
  }

  /* 3) Btn shimmer removido já — apenas micro feedback por transform */
  .btn { transition: transform 120ms cubic-bezier(.2,.9,.25,1); }

  /* 4) limitar sombras/blur durante animações */
  .panel.animating, .form-section.animating {
    box-shadow: 0 6px 14px rgba(0,0,0,0.36) !important; /* mais leve */
    -webkit-backdrop-filter: none !important;
    backdrop-filter: none !important;
  }

  /* 5) reduzir número de elementos animados ao mesmo tempo (ex.: esconder pseudo-elements) */
  .panel::before, .form-section::after { display: none !important; }
    }

    @media (max-width: 480px) {
      .sidebar.active {
        max-height: 100vh;
      }

      .container {
        margin-top: 76px;
        padding: 16px;
      }

      .sidebar {
        min-height: 76px;
        max-height: 76px;
      }

      .sidebar-header {
        min-height: 76px;
        padding: 14px 16px;
      }

      .topbar h2 {
        font-size: 18px;
      }

      .notification-content {
        padding: 20px;
        max-width: 95%;
      }

      .notification-content button {
        width: 100%;
        padding: 12px;
        font-size: 16px;
      }

      .form-section::before,
    .panel::before {
        display: none;
    }
    
    body::before {
        background: radial-gradient(circle at 50% 50%, rgba(159, 204, 177, 0.02) 0%, transparent 60%);
        animation: none;
    }
    
    .form-section, .panel {
        backdrop-filter: none;
        background: rgba(255,255,255,0.04);
    }
    }

    /* ===== FORM ENHANCEMENTS ===== */
    .memberLocalSelect,
    .memberCustomLocalInput {
      flex: 1 1 150px;
    }

    @media (max-width: 600px) {
      .memberLocalSelect,
      .memberCustomLocalInput {
        flex: 1 1 100%;
      }

      .abonar-wrap {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .abonar-wrap.visible {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }

      .abonar-dsr {
        margin: 0;
        font-size: 13px;
      }

      .abonar-wrap select {
        width: 100% !important;
        min-width: 0;
        flex: 1 1 auto;
      }
    }

    /* ===== SCROLLBAR STYLING ===== */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.02);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(159, 204, 177, 0.3);
      border-radius: 4px;
      transition: background 0.3s ease;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(159, 204, 177, 0.5);
    }

    /* ===== LOADING STATES ===== */
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn:disabled:hover {
      transform: none !important;
      box-shadow: var(--neumo-shadow);
    }

    /* ===== NOTIFICATION ICONS ===== */
    #notificationMessage {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0;
  text-align: center;
}

    /* floating modal notification */
    .notification-modal{ 
  position: fixed; 
  inset: 0; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  background: rgba(0,0,0,0.7); 
  backdrop-filter: blur(4px);
  z-index: 600;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
  will-change: transform;
}
.notification-modal.show {
  opacity: 1;
  visibility: visible;
}

    .notification-content{
  background: rgba(11, 12, 15, 0.95);
  backdrop-filter: blur(20px) saturate(130%);
  padding: 20px 28px;
  border-radius: 16px;
  max-width: 420px;
  width: 92%;
  border: 1px solid rgba(255,255,255,0.12);
  box-shadow: 0 24px 80px rgba(0,0,0,0.8), inset 0 1px 0 rgba(255,255,255,0.05);
  color: var(--text);
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  transform: scale(0.9) translateY(20px);
  transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.notification-modal.show .notification-content {
  transform: scale(1) translateY(0);
}

    .notification-content button{
  margin-top: 20px;
  display: inline-block;
  border-radius: 12px;
  padding: 12px 24px;
  border: 1px solid rgba(255,255,255,0.08);
  cursor: pointer;
  background: var(--btn-grad);
  color: white;
  font-weight: 700;
  transition: all 0.3s ease;
  font-size: 14px;
  filter: drop-shadow(0 0 20px rgba(79, 70, 229, 0.4)) drop-shadow(0 0 40px rgba(79, 70, 229, 0.2));
}

/* Estilos para os ícones das notificações */
.notification-icon {
  font-size: 45px;
  margin-bottom: 8px;
  position: relative;
  display: block;
  text-align: center;
  width: 100%;
}

.notification-icon.success {
  color: #28a745;
  filter: drop-shadow(0 0 20px rgba(40, 167, 69, 0.4)) drop-shadow(0 0 40px rgba(40, 167, 69, 0.2));
}

.notification-icon.error {
  color: #dc3545;
  filter: drop-shadow(0 0 20px rgba(220, 53, 69, 0.4)) drop-shadow(0 0 40px rgba(220, 53, 69, 0.2));
}

.notification-icon.warning {
  color: #ffc107;
  filter: drop-shadow(0 0 20px rgba(255, 193, 7, 0.4)) drop-shadow(0 0 40px rgba(255, 193, 7, 0.2));
}

.notification-icon.info {
  color: #2196f3;
  filter: drop-shadow(0 0 20px rgba(33, 150, 243, 0.4)) drop-shadow(0 0 40px rgba(33, 150, 243, 0.2));
}

.notification-text {
  font-size: 16px;
  line-height: 1.5;
  color: var(--text);
  margin: 0;
  text-align: center;
}

    /* ===== SELECT STYLING ===== */
    select, .select-like{
  background-color: var(--input-bg) !important; color:var(--text) !important; border:1px solid var(--input-border) !important;
  -webkit-appearance:none; -moz-appearance:none; appearance:none; padding-right:35px !important;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24'%3E%3Cpath fill='%23e1efe6' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E") !important;
  background-repeat:no-repeat !important; background-position:right 12px center !important; background-size:16px 16px !important;
}
select option{ background-color:var(--bg) !important; color:var(--text) !important; }
select option:hover, select option:checked{ background:var(--accent) !important; color:#0b150f !important; }
select option[disabled]{ color:var(--muted) !important; }

    /* ===== AUTOFILL DARK ===== */
   input:-webkit-autofill, textarea:-webkit-autofill, select:-webkit-autofill{
  -webkit-box-shadow: 0 0 0px 1000px rgba(11,12,15,0.78) inset !important;
  box-shadow: 0 0 0px 1000px rgba(11,12,15,0.78) inset !important;
  -webkit-text-fill-color: var(--text) !important;
  transition: background-color 5000s ease-in-out 0s !important;
}
input:-webkit-autofill:focus{ -webkit-box-shadow: 0 0 0px 1000px rgba(11,12,15,0.78) inset !important; }


    /* ===== ANIMATION UTILITIES ===== */
    .fade-in{ animation: fadeIn 0.5s cubic-bezier(.15,.9,.25,1); }
@keyframes fadeIn{ from{opacity:0} to{opacity:1} }

.slide-up{ animation: slideUp 0.6s cubic-bezier(.15,.9,.25,1); }
@keyframes slideUp{ from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:translateY(0)} }


.btn, .form-row input, .form-row select, .form-row textarea{ will-change:auto; backface-visibility:hidden;}
.sidebar, .form-section{ contain: layout style paint; }

    /* ===== ENHANCED GLASS EFFECT ===== */
    .form-section::after{
  content:''; position:absolute; inset:0;
  background: linear-gradient(135deg, rgba(159,204,177,0.01) 0%, transparent 50%, rgba(57,102,107,0.01) 100%);
  pointer-events:none; opacity:0; transition:opacity 0.4s cubic-bezier(.15,.9,.25,1);
}
.form-section:hover::after{ opacity:1; }

/* headings */
.form-section h3{
  font-size:18px; font-weight:600; color:var(--text); margin-bottom:20px; display:flex; align-items:center;
}
.form-section h3 i{
  margin-right:10px; font-size:16px; color:var(--accent); background: rgba(159,204,177,0.1);
  padding:6px; border-radius:6px; box-shadow: 0 2px 8px rgba(159,204,177,0.2);
}

    /* ===== FOCUS STATES ===== */
    .btn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .form-row input:focus-visible,
    .form-row select:focus-visible,
    .form-row textarea:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* ===== PERFORMANCE OPTIMIZATIONS ===== */
    .sidebar, .form-section {
      contain: layout style paint;
    }

    .btn, .form-row input, .form-row select, .form-row textarea {
  will-change: auto !important;
}

    .hidden {
      display: none !important;
    }

    .matricula-name-searching::placeholder {
  font-style: italic;
}

.name-origin-icon{
  position: absolute;
  display: inline-flex;         /* <-- torna o conteúdo flex para centralizar */
  align-items: center;          /* centra vertical */
  justify-content: center;      /* centra horizontal */
  width: 20px;                  /* ajuste conforme quiser */
  height: 20px;                 /* largura = altura para ficar simétrico */
  padding: 0;                   /* remove padding que desloca */
  font-size: 14px;
  line-height: 1;               /* evita deslocamento por line-height */
  border-radius: 6px;
  background: rgba(255,255,255,0.95);
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  color: var(--secondary);
  box-sizing: border-box;
}

.dev-note {
      color:var(--muted);
      font-size:12px;
      text-align:center;
      padding:12px 10px;
      border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
      border: 1px solid rgba(255,255,255,0.02);
      box-shadow: var(--neumo-shadow);
    }
    .dev-note strong { color:var(--text); letter-spacing:0.01em; font-weight:700; }
    .dev-note .meta { display:block; margin-top:6px; color: rgba(225,239,230,0.45); font-size:11px; }

  </style>

</head>
<body>
  <div class="sidebar" aria-label="Navegação">
    <div class="sidebar-header">
      <div class="brand">
        <div class="logo"><img src="./favicon/favicon.svg" alt="" style="width: 75%;"></div>
        <div class="brand-text">
          <h1>Estrutura</h1>
          <p>Apropriações</p>
        </div>
      </div>
      <button id="toggleMenu" class="hamburger" aria-label="Abrir menu">
        <i class="fas fa-bars"></i>
      </button>
    </div>
    <nav id="sidebarNav">
      <ul id="menuList">
        <li>
          <a href="./dashboard.html" class="active">
            <i class="fas fa-file-signature"></i><span>Apropriações</span>
          </a>
        </li>
        <li>
          <a href="./equipes/equipe.html">
            <i class="fas fa-users-cog"></i><span>Equipes</span>
          </a>
        </li>
        <li>
          <a href="./apontamentos/apontamentos.html">
            <i class="fas fa-clipboard-list"></i><span>Apontamentos</span>
          </a>
        </li>
        <li>
          <a href="./diario/diario.html">
            <i class="fas fa-book"></i><span>Diário de obra</span>
          </a>
        </li>
        <li>
          <a href="./efetivo/efetivo.html">
            <i class="fas fa-user-friends"></i><span>Efetivo</span>
          </a>
        </li>
        <li>
          <a href="./anotar/anotar.html">
            <i class="fas fa-sticky-note" aria-hidden="true"></i><span>Anotações</span>
          </a>
        </li>
        <li>
          <a href="#">
            <i class="fas fa-calendar-check"></i><span>Abono DSR</span>
          </a>
        </li>
        <li>
          <a href="https://detroitbrasil.qforms.com.br/QuestionarioWeb/ResponderQuestionarioLink?chave=ADC929D335B064357179BDBAE1686855"
            target="_blank" rel="noopener noreferrer">
            <i class="fa-solid fa-shield-halved"></i><span>Observa+</span>
          </a>
        </li>
        <li>
          <a href="./configurações/configuração.html">
            <i class="fas fa-cog"></i><span>Configurações</span>
          </a>
        </li>
      </ul>
    </nav>
  </div>

  <div class="container">
    <header><h2>Apropriação de Equipes</h2></header>

    <!-- Gerenciar Equipe -->
    <section class="form-section" id="teamSection">
      <h3><i class="fa-solid fa-users-gear"></i> Gerenciar Equipe</h3>

      <div style="margin-bottom:12px;">
        <button id="createTeamBtn" class="btn"><i class="fas fa-plus-circle"></i> Criar Equipe</button>
      </div>

      <div id="createTeamArea" style="display:none;">
        <div class="form-row">
          <label for="teamName">Nome da Equipe:</label>
          <input type="text" id="teamName" placeholder="Ex: Semana 1 - Plataforma X" autocomplete="off" />
        </div>

        <div class="form-row">
          <label>Turno padrão da equipe:</label>
          <div class="radio-group">
            <input type="radio" id="shiftDiurno" name="teamShift" value="Diurno" checked />
            <label for="shiftDiurno">Diurno</label>

            <input type="radio" id="shiftNoturno" name="teamShift" value="Noturno" />
            <label for="shiftNoturno">Noturno</label>
          </div>
        </div>

        <div id="membersContainer"></div>

        <div style="display:flex; gap:10px; align-items:center; margin-top:10px;">
          <button id="addMemberBtn" class="btn"><i class="fa-solid fa-plus"></i> Adicionar Membro</button>
          <button id="saveTeamBtn" class="btn"><i class="fa-solid fa-user-plus"></i> Salvar Equipe</button>
          <button id="cancelCreateTeamBtn" class="btn" style="background:#c0392b; display:none;"><i class="fa-solid fa-xmark"></i> Cancelar</button>
        </div>
      </div>

      <h3 class="outros" style="margin-top:14px;"><i class="fa-solid fa-pen-to-square"></i> Editar Equipe</h3>
      <div class="form-row">
        <label for="teamSelectManage">Selecione uma equipe para editar:</label>
        <select id="teamSelectManage"><option value="">-- Nenhuma selecionada --</option></select>
        <div class="manage-actions">
          <button id="editTeamBtn" class="btn btn-edit-wide" type="button"><i class="fas fa-edit"></i> Editar Equipe</button>
          <button id="deleteTeamBtn" class="icon-btn" aria-label="Excluir equipe" title="Excluir equipe" type="button"><i class="fas fa-trash"></i></button>
        </div>
      </div>
    </section>

    <!-- Enviar Apropriação -->
    <section class="form-section" id="recordSection">
      <h3><i class="fas fa-paper-plane"></i> Enviar Apropriação</h3>

      <div class="form-row">
        <label for="dateInput">Data:</label>
        <input type="date" id="dateInput" value="" />
      </div>

      <div class="form-row">
        <label for="galpaoSelect">Galpão:</label>
        <select id="galpaoSelect" aria-label="Selecione um galpão">
          <option value="">Selecione um galpão</option>
          <option value="Galpão 1">Galpão 1</option>
          <option value="Galpão 2">Galpão 2</option>
          <option value="Galpão 3">Galpão 3</option>
          <option value="Galpão 4">Galpão 4</option>
        </select>
      </div>

      <div class="form-row">
        <label for="teamSelect">Equipe:</label>
        <select id="teamSelect"></select>
      </div>

      <div id="shiftsContainer" style="display:flex; flex-direction:column; gap:10px;"></div>

      <div style="margin-top:12px;">
        <button id="submitRecordBtn" class="btn"><i class="fa-solid fa-check"></i> Enviar Apropriação</button>
      </div>
    </section>

    <!-- Registros Recentes -->
    <section class="form-section">
      <h3><i class="fas fa-history"></i> Registros Recentes</h3>

      <div style="margin-bottom:12px;">
        <button id="loadRecordsBtn" class="btn"><i class="fas fa-download"></i> Carregar Recentes</button>
        <span id="recordsStatus" style="margin-left:12px;color:var(--text);font-size:0.95rem;"></span>
      </div>

      <div class="table-wrapper" id="recordsTableWrapper" style="max-height:360px; overflow:auto;">
        <table id="recordsTable">
          <thead><tr><th>Data</th><th>Galpão</th><th>Equipe</th><th>Usuário</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <div class="dev-note reveal">
        <div>Sistema desenvolvido por <strong>Gustavo Carvalho</strong></div>
        <div>Setor de <strong>Estrutura</strong></div>
        <span class="meta">Agilidade, confiabilidade e design de excelência — pensado para líderes de obra que buscam precisão e confiança • © 2025</span>
      </div>
  </div>

  <!-- Modais e indicadores -->
  <div id="notificationModal" class="notification-modal" style="display:none">
    <div class="notification-content">
      <p id="notificationMessage" style="display:flex;align-items:center;gap:10px">
        <i class="fas fa-info-circle" style="color:var(--accent-strong);"></i>
        <span id="notificationText">Mensagem</span>
      </p>
      <div style="display:flex;justify-content:center">
        <button id="notificationOkBtn">OK</button>
      </div>
    </div>
  </div>

  <div id="confirmModal" class="notification-modal" style="display:none;">
    <div class="notification-content">
      <p id="confirmMessage" style="color:#dc3545; font-weight:bold;"></p>
      <div style="display:flex; justify-content:space-around; margin-top:20px;">
        <button id="confirmYesBtn" class="btn" style="background:#c0392b;">SIM</button>
        <button id="confirmNoBtn" class="btn">NÃO</button>
      </div>
    </div>
  </div>

  <div id="sync-indicator" aria-hidden="true" style="display:block;"></div>
  <div id="connection-status" class="connection-status offline" aria-hidden="true">Offline</div>
  <div id="cache-status" class="cache-status">Cache: -</div>

  <!-- SCRIPT: módulo otimizado -->
  <script type="module">

    // --- Autenticação otimizada (cache + rate-limit) ---
const CACHE_KEY = 'auth_session';         // salvo pelo login
const VALIDATION_KEY = 'auth_validated';  // sessão validada para esta aba
let lastFirebaseRequest = 0;
const FIREBASE_COOLDOWN = 3000; // 3s entre tentativas
let isValidating = false;

function getAuthCache() {
  try {
    const cached = localStorage.getItem(CACHE_KEY);
    if (!cached) return null;
    const cache = JSON.parse(cached);
    if (!cache.uid || !cache.timestamp) {
      localStorage.removeItem(CACHE_KEY);
      sessionStorage.removeItem(VALIDATION_KEY);
      return null;
    }
    return cache;
  } catch {
    localStorage.removeItem(CACHE_KEY);
    sessionStorage.removeItem(VALIDATION_KEY);
    return null;
  }
}

function isSessionValidated() {
  return sessionStorage.getItem(VALIDATION_KEY) === 'true';
}

async function validateAuthentication() {
  if (isValidating) return { isAuthenticated: false };
  isValidating = true;
  try {
    // 1) cache + sessão validada -> sem requests
    const cachedAuth = getAuthCache();
    if (cachedAuth && isSessionValidated()) {
      return { isAuthenticated: true, user: { uid: cachedAuth.uid, ...cachedAuth.userData }, source: 'cache_validated' };
    }

    // 2) cache existe, mas sessão não validada -> try to validate with Firebase
    if (cachedAuth && cachedAuth.uid) {
      // se offline confia no cache
      if (!navigator.onLine) {
        sessionStorage.setItem(VALIDATION_KEY, 'true');
        return { isAuthenticated: true, user: { uid: cachedAuth.uid, ...cachedAuth.userData }, source: 'cache_offline' };
      }

      // rate limiting: evita múltiplas validações em sequência
      const now = Date.now();
      if (now - lastFirebaseRequest < FIREBASE_COOLDOWN) {
        sessionStorage.setItem(VALIDATION_KEY, 'true');
        return { isAuthenticated: true, user: { uid: cachedAuth.uid, ...cachedAuth.userData }, source: 'cache_rate_limited' };
      }

      // valida com Firebase (com timeout)
      try {
        lastFirebaseRequest = now;
        const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('Firebase timeout')), 3000));
        const authPromise = new Promise((resolve) => {
          const unsubscribe = onAuthStateChanged(auth, (user) => { unsubscribe(); resolve(user); });
        });
        const user = await Promise.race([authPromise, timeoutPromise]);
        if (user && user.uid === cachedAuth.uid) {
          sessionStorage.setItem(VALIDATION_KEY, 'true');
          return { isAuthenticated: true, user: { uid: user.uid, email: user.email, ...cachedAuth.userData }, source: 'firebase_validated' };
        } else {
          localStorage.removeItem(CACHE_KEY);
          sessionStorage.removeItem(VALIDATION_KEY);
          return { isAuthenticated: false, source: 'firebase_rejected' };
        }
      } catch (error) {
        // timeout ou falha -> degrade gracefully
        if (error.message?.includes('timeout') || !navigator.onLine) {
          sessionStorage.setItem(VALIDATION_KEY, 'true');
          return { isAuthenticated: true, user: { uid: cachedAuth.uid, ...cachedAuth.userData }, source: 'cache_firebase_failed' };
        }
        localStorage.removeItem(CACHE_KEY);
        sessionStorage.removeItem(VALIDATION_KEY);
        return { isAuthenticated: false, source: 'firebase_error' };
      }
    }

    // sem cache -> não autenticado
    return { isAuthenticated: false, source: 'not_authenticated' };
  } finally {
    isValidating = false;
  }
}

async function logout() {
  try {
    // limpa cache local do app
    localStorage.removeItem(CACHE_KEY);
    localStorage.removeItem('uid');
    sessionStorage.removeItem(VALIDATION_KEY);

    // reset estado local
    currentUser = null;

    // tenta signOut (se online) mas não bloqueia a navegação
    if (navigator.onLine) {
      try {
        const { signOut } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js");
        await signOut(auth);
      } catch (err) {
        console.warn('Erro logout Firebase (não crítico):', err);
      }
    }

    // redirect imediato
    window.location.replace('./index.html');
  } catch (err) {
    console.error('Erro no logout:', err);
    window.location.replace('./index.html');
  }
}


    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import {
      initializeFirestore,
      persistentLocalCache,
      persistentMultipleTabManager,
      collection,
      query,
      where,
      getDocs,
      addDoc,
      doc,
      getDoc,
      setDoc,
      writeBatch,
      orderBy,
      limit,
      startAfter,
      Timestamp
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDtnzixicBYAQkuoeB5tgCGpDLt1lByMZo",
      authDomain: "apropriacao-estrutura.firebaseapp.com",
      projectId: "apropriacao-estrutura",
      storageBucket: "apropriacao-estrutura.appspot.com",
      messagingSenderId: "155266586257",
      appId: "1:155266586257:web:6d70edc967cdbfc56e5130",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = initializeFirestore(app, {
      localCache: persistentLocalCache({ tabManager: persistentMultipleTabManager() })
    });

    // Helpers
    function escapeHtml(str = '') {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
    function getCachedUID() { return localStorage.getItem('uid'); }
    function clearCachedUID() { localStorage.removeItem('uid'); }

    // createShiftRowForRecord (já otimizada)
    function createShiftRowForRecord({
      name, memberMatricula, block = "", vessel = "", shift = "",
      observations = "", local = "", customLocal = "", details = "",
      absent = false, abono = 'VERIFICAR', absenceReason = ''
    }) {
      const div = document.createElement("div");
      div.className = "form-row";
      div.style.position = "relative";
      const uid = 's' + Math.random().toString(36).slice(2,8);
      const finalLocal = local === "Outros" && customLocal ? customLocal : local;

      if (absent) {
        div.innerHTML = `
          <input type="text" id="shiftName-${uid}" name="shiftName[]" class="shiftName" value="${escapeHtml(name)}" readonly autocomplete="off" />
          <input type="text" id="shiftMatricula-${uid}" name="shiftMatricula[]" class="shiftMatricula" value="${escapeHtml(memberMatricula)}" readonly autocomplete="off" />
          <input type="hidden" id="shiftBlock-${uid}" name="shiftBlock[]" class="shiftBlock" value="" />
          <input type="hidden" id="shiftVessel-${uid}" name="shiftVessel[]" class="shiftVessel" value="" />
          <input type="hidden" id="shiftTurno-${uid}" name="shiftTurno[]" class="shiftTurno" value="FALTA" />
          <input type="hidden" id="shiftLocal-${uid}" name="shiftLocal[]" class="shiftLocal" value="" />
          <input type="hidden" id="shiftDetails-${uid}" name="shiftDetails[]" class="shiftDetails" value="" />
          <textarea id="shiftAbsenceReason-${uid}" name="shiftAbsenceReason[]" class="shiftAbsenceReason" placeholder="Motivo da falta" rows="2" aria-label="Motivo da falta">${escapeHtml(absenceReason)}</textarea>
          <div class="abonar-wrap visible">
            <label class="abonar-dsr" for="shiftAbono-${uid}">Abonar DSR</label>
            <select id="shiftAbono-${uid}" name="shiftAbono[]" class="shiftAbono">
              <option value="VERIFICAR" ${abono === 'VERIFICAR' ? 'selected' : ''}>VERIFICAR</option>
              <option value="SIM" ${abono === 'SIM' ? 'selected' : ''}>SIM</option>
              <option value="NAO" ${abono === 'NAO' ? 'selected' : ''}>NÃO</option>
            </select>
          </div>
        `;
      } else {
        div.innerHTML = `
          <input type="text" id="shiftName-${uid}" name="shiftName[]" class="shiftName" value="${escapeHtml(name)}" readonly autocomplete="off" />
          <input type="text" id="shiftMatricula-${uid}" name="shiftMatricula[]" class="shiftMatricula" value="${escapeHtml(memberMatricula)}" readonly autocomplete="off" />
          <input type="text" id="shiftBlock-${uid}" name="shiftBlock[]" class="shiftBlock" value="${escapeHtml(block)}" placeholder="Bloco" autocomplete="off" />
          <input type="text" id="shiftVessel-${uid}" name="shiftVessel[]" class="shiftVessel" value="${escapeHtml(vessel)}" placeholder="Embarcação" autocomplete="off" />
          <select id="shiftTurno-${uid}" name="shiftTurno[]" class="shiftTurno">
            <option value="">Selecione Turno</option>
            <option value="Diurno" ${shift === "Diurno" ? "selected" : ""}>Diurno</option>
            <option value="Noturno" ${shift === "Noturno" ? "selected" : ""}>Noturno</option>
          </select>
          <input type="text" id="shiftLocal-${uid}" name="shiftLocal[]" class="shiftLocal" value="${escapeHtml(finalLocal)}" readonly autocomplete="off" />
          <input type="hidden" id="shiftDetails-${uid}" name="shiftDetails[]" class="shiftDetails" value="${escapeHtml(details)}" />
          <input type="text" id="shiftObservations-${uid}" name="shiftObservations[]" class="shiftObservations" placeholder="Observações" value="${escapeHtml(observations)}" autocomplete="off" />
        `;
      }
      return div;
    }

    // Cache & TeamsManager classes (igual ao anterior)...
    class FirebaseCache {
      constructor() {
        this.memoryCache = new Map();
        this.TTL = { teams: 24 * 60 * 60 * 1000, records: 60 * 60 * 1000, meta: 5 * 60 * 1000 };
        this.pendingRequests = new Map();
        this.syncIndicator = document.getElementById('sync-indicator');
        this.connectionStatus = document.getElementById('connection-status');
        this.cacheStatus = document.getElementById('cache-status');
        this.updateConnectionStatus();
        window.addEventListener('online', () => this.updateConnectionStatus());
        window.addEventListener('offline', () => this.updateConnectionStatus());
      }
      updateConnectionStatus() {
        const isOnline = navigator.onLine;
        if (this.connectionStatus) {
          this.connectionStatus.textContent = isOnline ? 'Online' : 'Offline';
          this.connectionStatus.className = `connection-status ${isOnline ? 'online' : 'offline'}`;
        }
      }
      showSyncIndicator(message = 'Sincronizando...') {
        if (this.syncIndicator) { this.syncIndicator.textContent = message; this.syncIndicator.classList.add('show'); }
      }
      hideSyncIndicator() { if (this.syncIndicator) this.syncIndicator.classList.remove('show'); }
      updateCacheStatus(message) { if (this.cacheStatus) this.cacheStatus.textContent = `Cache: ${message}`; }
      getCacheKey(collection, userId, filter = {}) {
        const filterStr = Object.keys(filter).length ? '_' + Object.entries(filter).map(([k,v]) => `${k}:${v}`).join('_') : '';
        return `${collection}_${userId}${filterStr}`;
      }
      isCacheValid(cacheKey, ttl) {
        const cached = this.memoryCache.get(cacheKey);
        if (!cached) return false;
        return (Date.now() - cached.timestamp) < ttl;
      }
      getFromMemoryCache(cacheKey) { const c = this.memoryCache.get(cacheKey); return c ? c.data : null; }
      setMemoryCache(cacheKey, data, metadata = {}) {
        this.memoryCache.set(cacheKey, { data, timestamp: Date.now(), version: metadata.version || Date.now() });
      }
      getFromLocalStorage(cacheKey, ttl) {
        try {
          const stored = localStorage.getItem(cacheKey);
          if (!stored) return null;
          const parsed = JSON.parse(stored);
          if (!parsed || !parsed.timestamp) return null;
          if (Date.now() - parsed.timestamp > ttl) { localStorage.removeItem(cacheKey); return null; }
          return parsed.data;
        } catch (e) { console.warn('Erro ao ler cache local', e); return null; }
      }
      setLocalStorage(cacheKey, data, metadata = {}) {
        try { localStorage.setItem(cacheKey, JSON.stringify({ data, timestamp: Date.now(), version: metadata.version || Date.now() })); } catch (e) { console.warn('Erro ao salvar cache local', e); }
      }
      clearCache(cacheKey) { this.memoryCache.delete(cacheKey); try { localStorage.removeItem(cacheKey); } catch (e) {} }
    }

    class OptimizedTeamsManager {
      constructor(firebaseCache, db, currentUser) {
        this.cache = firebaseCache;
        this.db = db;
        this.currentUser = currentUser;
        this.lastMetaCheck = 0;
        this.syncInterval = null;
        this.isOnline = navigator.onLine;
        this.setupConnectivityListeners();
      }
      setupConnectivityListeners() {
        window.addEventListener('online', () => { this.isOnline = true; this.backgroundSync(); });
        window.addEventListener('offline', () => { this.isOnline = false; });
        document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible' && this.isOnline) this.backgroundSync(); });
      }
      async loadTeams(forceRefresh = false) {
        const cacheKey = this.cache.getCacheKey('teams', this.currentUser.uid);
        if (!forceRefresh) {
          if (this.cache.isCacheValid(cacheKey, this.cache.TTL.teams)) {
            const cachedData = this.cache.getFromMemoryCache(cacheKey);
            if (cachedData) { this.rebuildUI(cachedData); this.cache.updateCacheStatus('Memória (atualizado)'); setTimeout(()=>this.backgroundSync(),100); return cachedData; }
          }
          const localData = this.cache.getFromLocalStorage(cacheKey, this.cache.TTL.teams);
          if (localData) {
            const dataMap = new Map(Object.entries(localData));
            this.cache.setMemoryCache(cacheKey, dataMap);
            this.rebuildUI(dataMap);
            this.cache.updateCacheStatus('Local Storage');
            setTimeout(()=>this.backgroundSync(),100);
            return dataMap;
          }
        }
        return await this.fetchFromServer(cacheKey);
      }
      async fetchFromServer(cacheKey, showIndicator=true) {
        if (this.cache.pendingRequests.has(cacheKey)) return await this.cache.pendingRequests.get(cacheKey);
        const prom = this.performServerFetch(cacheKey, showIndicator);
        this.cache.pendingRequests.set(cacheKey, prom);
        try { const res = await prom; return res; } finally { this.cache.pendingRequests.delete(cacheKey); }
      }
      async performServerFetch(cacheKey, showIndicator=true) {
        if (showIndicator) { this.cache.showSyncIndicator(); this.cache.updateCacheStatus('Servidor...'); }
        try {
          const q = query(collection(this.db, "teams"), where("ownerUid", "==", this.currentUser.uid), where("deleted", "==", false));
          const snapshot = await getDocs(q);
          const teamsData = new Map();
          snapshot.forEach(docSnap => teamsData.set(docSnap.id, this.normalizeTeam(docSnap.data())));
          this.cache.setMemoryCache(cacheKey, teamsData, { version: Date.now() });
          const dataForCache = Object.fromEntries([...teamsData.entries()].map(([k,v]) => [k,v]));
          this.cache.setLocalStorage(cacheKey, dataForCache, { version: Date.now() });
          this.rebuildUI(teamsData);
          if (showIndicator) { this.cache.showSyncIndicator('Atualizado!'); this.cache.updateCacheStatus('Sincronizado'); setTimeout(()=>this.cache.hideSyncIndicator(),2000); }
          return teamsData;
        } catch (error) {
          console.error('Erro ao buscar teams:', error);
          this.cache.updateCacheStatus('Erro na sincronização');
          if (showIndicator) this.cache.hideSyncIndicator();
          throw error;
        }
      }
      async backgroundSync() {
        if (!this.isOnline) return;
        const now = Date.now();
        if (now - this.lastMetaCheck < this.cache.TTL.meta) return;
        this.lastMetaCheck = now;
        try {
          const needsUpdate = await this.checkIfNeedsUpdate();
          if (needsUpdate) {
            const cacheKey = this.cache.getCacheKey('teams', this.currentUser.uid);
            await this.fetchFromServer(cacheKey, false);
          }
        } catch (e) { console.warn('Background sync falhou:', e); }
      }
      async checkIfNeedsUpdate() {
        try {
          const metaRef = doc(this.db, "meta", `teams_${this.currentUser.uid}`);
          const metaSnap = await getDoc(metaRef);
          if (!metaSnap.exists()) return true;
          const serverVersion = metaSnap.data().version || 0;
          const cacheKey = this.cache.getCacheKey('teams', this.currentUser.uid);
          const cached = this.cache.memoryCache.get(cacheKey);
          const localVersion = cached ? cached.version : 0;
          return serverVersion > localVersion;
        } catch (error) {
          if (error?.code === 'permission-denied') { console.warn('Sem permissão para ler metadata - usando fallback'); return false; }
          return false;
        }
      }
      async saveTeam(teamData, editingTeamId = null) {
        const cacheKey = this.cache.getCacheKey('teams', this.currentUser.uid);
        let currentCache = this.cache.getFromMemoryCache(cacheKey) || new Map();
        if (!(currentCache instanceof Map)) currentCache = new Map(Object.entries(currentCache));
        const tempId = editingTeamId || `temp_${Date.now()}`;
        const normalizedData = this.normalizeTeam(teamData);
        currentCache.set(tempId, normalizedData);
        this.cache.setMemoryCache(cacheKey, currentCache);
        this.rebuildUI(currentCache);
        this.cache.updateCacheStatus('Salvando...');
        try {
          let finalId;
          if (editingTeamId) {
            await setDoc(doc(this.db, "teams", editingTeamId), teamData);
            finalId = editingTeamId;
          } else {
            const docRef = await addDoc(collection(this.db, "teams"), teamData);
            finalId = docRef.id;
            if (tempId !== finalId) { currentCache.delete(tempId); currentCache.set(finalId, normalizedData); this.cache.setMemoryCache(cacheKey, currentCache); this.rebuildUI(currentCache); }
          }
          await this.updateMetadata();
          this.cache.setLocalStorage(cacheKey, Object.fromEntries(currentCache));
          this.cache.updateCacheStatus('Salvo');
          return finalId;
        } catch (error) {
          if (!editingTeamId) { currentCache.delete(tempId); this.cache.setMemoryCache(cacheKey, currentCache); this.rebuildUI(currentCache); }
          this.cache.updateCacheStatus('Erro ao salvar');
          throw error;
        }
      }
      async deleteTeam(teamId) {
        const cacheKey = this.cache.getCacheKey('teams', this.currentUser.uid);
        let currentCache = this.cache.getFromMemoryCache(cacheKey) || new Map();
        if (!(currentCache instanceof Map)) currentCache = new Map(Object.entries(currentCache));
        const backupTeam = currentCache.get(teamId);
        currentCache.delete(teamId);
        this.cache.setMemoryCache(cacheKey, currentCache);
        this.rebuildUI(currentCache);
        this.cache.updateCacheStatus('Removendo...');
        try {
          await setDoc(doc(this.db, "teams", teamId), { deleted: true, deletedAt: Timestamp.now(), deletedBy: this.currentUser.uid }, { merge: true });
          await this.updateMetadata();
          this.cache.setLocalStorage(cacheKey, Object.fromEntries(currentCache));
          this.cache.updateCacheStatus('Removido');
        } catch (error) {
          if (backupTeam) { currentCache.set(teamId, backupTeam); this.cache.setMemoryCache(cacheKey, currentCache); this.rebuildUI(currentCache); }
          this.cache.updateCacheStatus('Erro ao remover');
          throw error;
        }
      }
      async updateMetadata() {
        try {
          const metaRef = doc(this.db, "meta", `teams_${this.currentUser.uid}`);
          await setDoc(metaRef, { version: Date.now(), updatedAt: Timestamp.now(), userId: this.currentUser.uid });
        } catch (e) { console.warn('Erro ao atualizar metadata:', e); }
      }
      normalizeTeam(raw = {}) {
        return {
          name: raw.name || '',
          shift: raw.shift || '',
          ownerUid: raw.ownerUid || '',
          members: (raw.members || []).map(m => ({
            name: m.name || '',
            matricula: m.matricula || '',
            block: m.block || '',
            vessel: m.vessel || '',
            local: m.local || '',
            customLocal: m.customLocal || '',
            details: m.details || '',
            absent: !!m.absent,
            abono: m.abono || 'VERIFICAR',
            absenceReason: m.absenceReason || ''
          }))
        };
      }
      rebuildUI(teamsData) {
        const teamSelect = document.getElementById("teamSelect");
        const teamSelectManage = document.getElementById("teamSelectManage");
        if (!teamSelect || !teamSelectManage) return;
        teamSelect.innerHTML = '<option value="">Selecione uma equipe</option>';
        teamSelectManage.innerHTML = '<option value="">-- Nenhuma selecionada --</option>';
        const dataToIterate = teamsData instanceof Map ? teamsData : new Map(Object.entries(teamsData || {}));
        dataToIterate.forEach((teamData, teamId) => {
          const option1 = document.createElement('option'); option1.value = teamId; option1.textContent = teamData.name || teamId; teamSelect.appendChild(option1);
          const option2 = option1.cloneNode(true); teamSelectManage.appendChild(option2);
        });
      }
      startPeriodicSync(intervalMs = 5 * 60 * 1000) { this.stopPeriodicSync(); this.syncInterval = setInterval(()=>{ if (document.visibilityState === 'visible' && this.isOnline) this.backgroundSync(); }, intervalMs); }
      stopPeriodicSync() { if (this.syncInterval) { clearInterval(this.syncInterval); this.syncInterval = null; } }
    }

    // Globals
    let currentUser = null;
    let editingTeamId = null;
    let firebaseCache = null;
    let teamsManager = null;

    function showNotification(message, type = "info") {
  const modal = document.getElementById("notificationModal");
  const msg = document.getElementById("notificationMessage");
  const okBtn = document.getElementById("notificationOkBtn");
  if (!modal || !msg || !okBtn) { alert(message); return; }
  
  const iconClass = {
    success: 'fas fa-check-circle',
    error: 'fas fa-times-circle',
    warning: 'fas fa-exclamation-triangle',
    info: 'fas fa-info-circle',
  };
  
  msg.innerHTML = `
    <div class="notification-icon ${type}">
      <i class="${iconClass[type]}"></i>
    </div>
    <p class="notification-text">${message}</p>
  `;
  
  // Mostrar o modal com animação
  modal.style.display = "flex";
  setTimeout(() => modal.classList.add("show"), 10);
  
  okBtn.focus();
  okBtn.onclick = () => closeNotification();
}
function closeNotification() {
  const modal = document.getElementById("notificationModal");
  if (!modal) return;
  
  modal.classList.remove("show");
  setTimeout(() => {
    modal.style.display = "none";
  }, 300);
}

    function setupModalHandlers() {
      const notificationModal = document.getElementById("notificationModal");
      if (notificationModal) {
        notificationModal.addEventListener("click", (e) => { if (e.target === notificationModal) notificationModal.style.display = "none"; });
      }
      const confirmModal = document.getElementById("confirmModal");
      const confirmNoBtn = document.getElementById("confirmNoBtn");
      const confirmYesBtn = document.getElementById("confirmYesBtn");
      if (confirmNoBtn) confirmNoBtn.addEventListener("click", () => { if (confirmModal) confirmModal.style.display = "none"; });
      if (confirmYesBtn) confirmYesBtn.addEventListener("click", async () => {
        const teamSelectManage = document.getElementById("teamSelectManage");
        const teamId = teamSelectManage?.value;
        if (!teamId) { showNotification("Selecione uma equipe para excluir.", "warning"); return; }
        try {
          await teamsManager.deleteTeam(teamId);
          if (confirmModal) confirmModal.style.display = "none";
          clearTeamForm();
          showNotification("Equipe excluída com sucesso!", "success");
        } catch (e) {
          console.error('Erro ao excluir equipe:', e);
          if (confirmModal) confirmModal.style.display = "none";
          showNotification("Erro ao excluir equipe.", "error");
        }
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          const notificationModal = document.getElementById("notificationModal");
          const confirmModal = document.getElementById("confirmModal");
          if (notificationModal && notificationModal.style.display === "flex") notificationModal.style.display = "none";
          if (confirmModal && confirmModal.style.display === "flex") confirmModal.style.display = "none";
        }
      });
    }

    // ===== Records (lazy load) =====
    let lastVisibleRecord = null;
    let isFetchingRecords = false;
    let recordsCache = [];
    let recordsInitialized = false;
    let noMoreRecords = false;
    const LOAD_BATCH_SIZE = 5;

    function appendRecordsToTable(newDocs) {
      const tbody = document.querySelector("#recordsTable tbody");
      if (!tbody) return;
      const fragment = document.createDocumentFragment();
      for (const r of newDocs) {
        const date = r.date?.toDate?.() || new Date();
        const dateStr = date.toLocaleString("pt-BR", { day: '2-digit', month: '2-digit', year: 'numeric', hour:'2-digit', minute:'2-digit' });
        const galp = (r.galpao || "").replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const team = (r.teamName || r.teamId || "").replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const user = (r.userName || "").replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${dateStr}</td><td>${galp}</td><td>${team}</td><td>${user}</td>`;
        fragment.appendChild(tr);
      }
      tbody.appendChild(fragment);
    }

    function clearRecordsTable() {
      const tbody = document.querySelector("#recordsTable tbody");
      if (tbody) tbody.innerHTML = '';
      recordsCache = [];
      lastVisibleRecord = null;
      noMoreRecords = false;
    }

    async function loadRecords(reset = false) {
      if (isFetchingRecords) return;
      if (noMoreRecords && !reset) return;
      isFetchingRecords = true;
      const loadBtn = document.getElementById('loadRecordsBtn');
      const statusSpan = document.getElementById('recordsStatus');
      if (loadBtn) { loadBtn.disabled = true; loadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Carregando...'; }
      if (statusSpan) statusSpan.textContent = '';

      try {
        if (reset) { clearRecordsTable(); recordsInitialized = true; noMoreRecords = false; lastVisibleRecord = null; }

        let q = query(collection(db, "records"), where("createdBy", "==", currentUser.uid), orderBy("date", "desc"), limit(LOAD_BATCH_SIZE));
        if (!reset && lastVisibleRecord) q = query(q, startAfter(lastVisibleRecord));

        const snap = await getDocs(q);
        if (!snap.empty) {
          lastVisibleRecord = snap.docs[snap.docs.length - 1];
          const newDocs = [];
          snap.forEach(docSnap => newDocs.push(docSnap.data()));
          appendRecordsToTable(newDocs);
          recordsCache = recordsCache.concat(newDocs);
          if (snap.size < LOAD_BATCH_SIZE) {
            noMoreRecords = true;
            if (statusSpan) statusSpan.textContent = 'Todos os registros carregados.';
          }
        } else {
          noMoreRecords = true;
          if (reset && statusSpan) statusSpan.textContent = 'Nenhum registro encontrado.';
        }
      } catch (e) {
        console.error('Erro ao carregar records:', e);
        showNotification('Erro ao carregar registros recentes.', 'error');
      } finally {
        isFetchingRecords = false;
        if (loadBtn) {
          loadBtn.disabled = noMoreRecords;
          if (noMoreRecords) { loadBtn.innerHTML = '<i class="fas fa-check"></i> Carregado'; }
          else { loadBtn.innerHTML = '<i class="fas fa-download"></i> Carregar Mais'; loadBtn.style.display = ''; }
        }
      }
    }

    function setupInfiniteScroll() {
      const tableWrapper = document.getElementById("recordsTableWrapper") || document.querySelector("#recordsTable")?.parentElement;
      if (!tableWrapper) return;
      let scrollTimeout;
      tableWrapper.addEventListener("scroll", () => {
        if (!recordsInitialized || noMoreRecords) return;
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          if (tableWrapper.scrollTop + tableWrapper.clientHeight >= tableWrapper.scrollHeight - 50) loadRecords(false);
        }, 120);
      });
    }

    // ===== sendRecord (igual) =====
    async function sendRecord() {
      const teamSelect = document.getElementById("teamSelect");
      const teamId = teamSelect?.value;
      const teamName = teamSelect?.options[teamSelect.selectedIndex]?.text || '';
      const dateStr = document.getElementById("dateInput")?.value;
      const galpao = document.getElementById("galpaoSelect")?.value;

      if (!dateStr) { showNotification("Por favor, informe a data.", "warning"); return; }
      if (!galpao) { showNotification("Selecione um galpão para enviar.", "warning"); return; }
      if (!teamId) { showNotification("Selecione uma equipe para enviar a apropriação.", "warning"); return; }

      const cacheKey = firebaseCache.getCacheKey('teams', currentUser.uid);
      let teamsData = firebaseCache.getFromMemoryCache(cacheKey);
      if (!teamsData) {
        const fromLocal = firebaseCache.getFromLocalStorage(cacheKey, firebaseCache.TTL.teams);
        if (fromLocal) { teamsData = new Map(Object.entries(fromLocal)); firebaseCache.setMemoryCache(cacheKey, teamsData); }
      }
      if (!teamsData) {
        try { await teamsManager.loadTeams(true); teamsData = firebaseCache.getFromMemoryCache(cacheKey); if (!teamsData) { showNotification("Equipe selecionada não encontrada.", "warning"); return; } }
        catch (e) { console.error("Erro ao recarregar equipes:", e); showNotification("Erro ao acessar os dados da equipe.", "error"); return; }
      }

      const teamData = teamsData instanceof Map ? teamsData.get(teamId) : teamsData[teamId];
      if (!teamData) { showNotification("Equipe selecionada não encontrada.", "warning"); return; }

      const shiftsContainer = document.getElementById("shiftsContainer");
      const shiftRows = shiftsContainer?.querySelectorAll(".form-row") || [];
      if (shiftRows.length === 0) { showNotification("Selecione uma equipe com membros para apropriar.", "warning"); return; }

      const records = [];
      for (const row of shiftRows) {
        const name = row.querySelector(".shiftName")?.value?.trim() || "";
        const memberMatricula = row.querySelector(".shiftMatricula")?.value?.trim() || "";
        const memberOriginal = teamData.members.find(m => m.name === name && m.matricula === memberMatricula);
        const hasAbonoSelect = !!row.querySelector(".shiftAbono");
        const turnoValue = row.querySelector(".shiftTurno")?.value || "";
        const isAbsent = hasAbonoSelect || turnoValue === 'FALTA';
        const absenceReason = row.querySelector(".shiftAbsenceReason")?.value?.trim() || "";
        const abono = row.querySelector(".shiftAbono")?.value || 'VERIFICAR';

        let vesselShift = "", blockShift = "", details = "", local = "";

        if (!isAbsent) {
          vesselShift = row.querySelector(".shiftVessel")?.value?.trim() || "";
          blockShift = row.querySelector(".shiftBlock")?.value?.trim() || "";
          details = row.querySelector(".shiftDetails")?.value?.trim() || "";
          const localInput = row.querySelector(".shiftLocal");
          if (localInput && localInput.value != null) local = localInput.value.trim() || "";
          else local = (memberOriginal?.local === "Outros") ? (memberOriginal?.customLocal || "") : (memberOriginal?.local || "");
          if (!row.querySelector(".shiftTurno")?.value) { showNotification(`Preencha o turno do membro: ${name}`, "warning"); return; }
        } else {
          vesselShift = ""; blockShift = ""; details = ""; local = "";
        }

        records.push({
          date: Timestamp.fromDate(new Date(dateStr)),
          galpao,
          teamId,
          teamName,
          userId: currentUser.uid,
          userName: currentUser.displayName || currentUser.email,
          name,
          memberMatricula,
          vesselShift,
          blockShift,
          shift: isAbsent ? 'FALTA' : (row.querySelector(".shiftTurno")?.value || ""),
          observations: row.querySelector(".shiftObservations")?.value?.trim() || "",
          local,
          details,
          absent: isAbsent,
          absenceReason,
          abono,
          createdBy: currentUser.uid,
        });
      }

      try {
        firebaseCache.showSyncIndicator('Enviando apropriações...');
        const BATCH_LIMIT = 400;
        let batch = writeBatch(db);
        let ops = 0;

        for (const rec of records) {
          const [yyyy, mm, dd] = dateStr.split('-');
          const dateStrForId = `${dd}-${mm}-${yyyy}`;
          const safeName = rec.name.replace(/[/\\#.%$[\]]/g, "-");
          const docId = `${safeName}, ${rec.memberMatricula} - ${dateStrForId}`;
          batch.set(doc(db, "records", docId), rec);
          ops++;
          if (ops >= BATCH_LIMIT) { await batch.commit(); batch = writeBatch(db); ops = 0; }
        }
        if (ops > 0) await batch.commit();

        const galpaoSel = document.getElementById("galpaoSelect");
        if (galpaoSel) galpaoSel.selectedIndex = 0;
        const teamSel = document.getElementById("teamSelect");
        if (teamSel) teamSel.selectedIndex = 0;
        const sc = document.getElementById("shiftsContainer");
        if (sc) sc.innerHTML = "";

        const submitBtn = document.getElementById("submitRecordBtn");
        if (submitBtn) { submitBtn.disabled = true; setTimeout(()=>submitBtn.disabled = false, 1500); }

        firebaseCache.showSyncIndicator('Apropriações enviadas!');
        setTimeout(()=>firebaseCache.hideSyncIndicator(), 1800);
        showNotification("Apropriações enviadas com sucesso!", "success");

        try { localStorage.setItem(`teams_meta_last_check_ts`, String(Date.now())); } catch (e) {}

        if (typeof loadRecords === 'function') loadRecords(true);

      } catch (e) {
        console.error('Erro ao enviar apropriações:', e);
        firebaseCache.hideSyncIndicator();
        showNotification("Erro ao enviar apropriações.", "error");
      }
    }

    // ======= <AQUI: função que faltava> handleTeamSelection =======
    function handleTeamSelection() {
      const teamSelect = document.getElementById("teamSelect");
      const teamId = teamSelect?.value;
      const shiftsContainer = document.getElementById("shiftsContainer");

      if (!shiftsContainer) return;
      if (!teamId) {
        shiftsContainer.innerHTML = "";
        return;
      }

      const cacheKey = firebaseCache.getCacheKey('teams', currentUser.uid);
      let teamsData = firebaseCache.getFromMemoryCache(cacheKey);

      if (!teamsData) {
        const local = firebaseCache.getFromLocalStorage(cacheKey, firebaseCache.TTL.teams);
        if (local) {
          teamsData = new Map(Object.entries(local));
          firebaseCache.setMemoryCache(cacheKey, teamsData);
        }
      }

      if (!teamsData) {
        shiftsContainer.innerHTML = "";
        return;
      }

      const teamData = teamsData instanceof Map ? teamsData.get(teamId) : teamsData[teamId];
      if (!teamData || !teamData.members || teamData.members.length === 0) {
        shiftsContainer.innerHTML = "";
        return;
      }

      shiftsContainer.innerHTML = "";
      const turnoPadrao = teamData.shift || "";
      const frag = document.createDocumentFragment();

      for (const member of teamData.members) {
        const row = createShiftRowForRecord({
          name: member.name,
          memberMatricula: member.matricula,
          block: member.block || "",
          vessel: member.vessel || "",
          shift: turnoPadrao,
          observations: "",
          local: member.local || "",
          customLocal: member.customLocal || "",
          details: member.details || "",
          absent: !!member.absent,
          abono: member.abono || 'VERIFICAR',
          absenceReason: member.absenceReason || ''
        });
        frag.appendChild(row);
      }

      shiftsContainer.appendChild(frag);
    }
    // ===============================================================

    // Create member row (team management)
    function createMemberRow(member = { name: "", matricula: "", block: "", vessel: "", local: "", customLocal: "", details: "", absent: false, abono: 'VERIFICAR', absenceReason: '' }) {
      const div = document.createElement("div");
      div.className = "form-row";
      div.style.position = "relative";
      const uid = 'm' + Math.random().toString(36).slice(2,8);

      div.innerHTML = `
        <input type="text" id="memberName-${uid}" name="memberName[]" class="memberName" placeholder="Nome" value="${escapeHtml(member.name)}" autocomplete="off" />
        <input type="text" id="memberMatricula-${uid}" name="memberMatricula[]" class="memberMatricula" placeholder="Matrícula" value="${escapeHtml(member.matricula)}" autocomplete="off" />
        <input type="text" id="memberBlock-${uid}" name="memberBlock[]" class="memberBlock" placeholder="Bloco" value="${escapeHtml(member.block)}" autocomplete="off" />
        <input type="text" id="memberVessel-${uid}" name="memberVessel[]" class="memberVessel" placeholder="Embarcação" value="${escapeHtml(member.vessel)}" autocomplete="off" />
        <select id="memberLocalSelect-${uid}" name="memberLocal[]" class="memberLocalSelect">
          <option value="">Selecione Local</option>
          <option value="Montagem" ${member.local === "Montagem" ? "selected" : ""}>Montagem</option>
          <option value="Sub Montagem" ${member.local === "Sub Montagem" ? "selected" : ""}>Sub Montagem</option>
          <option value="Edificação" ${member.local === "Edificação" ? "selected" : ""}>Edificação</option>
          <option value="Outros" ${member.local === "Outros" ? "selected" : ""}>Outros</option>
        </select>
        <input type="text" id="memberCustomLocalInput-${uid}" name="memberCustomLocal[]" class="memberCustomLocalInput" placeholder="Informe outro local" value="${escapeHtml(member.customLocal || '')}" autocomplete="off" />
        <input type="text" id="memberDetailsInput-${uid}" name="memberDetails[]" class="memberDetailsInput" placeholder="Detalhes (Perfilado, Barras, Anteparas)" value="${escapeHtml(member.details || '')}" autocomplete="off" />
        <input type="text" id="memberAbsenceReasonInput-${uid}" name="memberAbsenceReason[]" class="memberAbsenceReasonInput" placeholder="Motivo da falta / Observações" value="${escapeHtml(member.absenceReason || '')}" style="display:none; flex:1;" autocomplete="off" />
        <div class="abonar-wrap">
          <label class="abonar-dsr" for="memberAbono-${uid}">Abonar DSR</label>
          <select id="memberAbono-${uid}" name="memberAbono[]" class="memberAbonoSelect">
            <option value="VERIFICAR" ${member.abono === 'VERIFICAR' ? 'selected' : ''}>VERIFICAR</option>
            <option value="SIM" ${member.abono === 'SIM' ? 'selected' : ''}>SIM</option>
            <option value="NAO" ${member.abono === 'NAO' ? 'selected' : ''}>NÃO</option>
          </select>
        </div>
        <label class="absentLabel" style="margin-left:8px;">
          <input type="checkbox" id="memberAbsentCheckbox-${uid}" name="memberAbsent[]" class="memberAbsentCheckbox" ${member.absent ? 'checked' : ''}/> Falta
        </label>
        <button class="btn removeMemberBtn" type="button" title="Remover membro"><i class="fas fa-trash"></i></button>
      `;

      const localSelect = div.querySelector(".memberLocalSelect");
      const customLocalInput = div.querySelector(".memberCustomLocalInput");
      const absentCheckbox = div.querySelector(".memberAbsentCheckbox");
      const absenceReasonInput = div.querySelector(".memberAbsenceReasonInput");
      const abonoWrap = div.querySelector(".abonar-wrap");
      const abonoSelect = div.querySelector(".memberAbonoSelect");
      const detailsInput = div.querySelector(".memberDetailsInput");

      function toggleCustomLocal() {
        if (localSelect.value === "Outros") { customLocalInput.style.display = "block"; } else { customLocalInput.style.display = "none"; customLocalInput.value = ""; }
      }

      function toggleAbsentMode() {
        const isAbsent = absentCheckbox.checked;
        const toToggle = [div.querySelector(".memberBlock"), div.querySelector(".memberVessel"), localSelect, customLocalInput, detailsInput];
        if (isAbsent) {
          toToggle.forEach(el => { if (el) el.style.display = "none"; });
          absenceReasonInput.style.display = "block";
          if (abonoWrap) abonoWrap.classList.add("visible");
          if (member.abono && abonoSelect) abonoSelect.value = member.abono;
          setTimeout(()=>absenceReasonInput.focus(),50);
        } else {
          toToggle.forEach(el => { if (el) el.style.display = ""; });
          absenceReasonInput.style.display = "none";
          if (abonoWrap) abonoWrap.classList.remove("visible");
          if (abonoSelect) abonoSelect.value = "VERIFICAR";
        }
      }

      localSelect.addEventListener("change", toggleCustomLocal);
      absentCheckbox.addEventListener("change", toggleAbsentMode);

      toggleCustomLocal();
      if (member.absent) toggleAbsentMode();

      div.querySelector(".removeMemberBtn").onclick = () => div.remove();
      return div;
    }

    // showCreateArea, clearTeamForm, setupEventListeners, handlers (igual ao anterior)...

    function showCreateArea(mode) {
      const createArea = document.getElementById('createTeamArea');
      const createBtn = document.getElementById('createTeamBtn');
      const cancelBtn = document.getElementById('cancelCreateTeamBtn');
      const saveBtn = document.getElementById('saveTeamBtn');
      if (mode === 'create') {
        editingTeamId = null;
        if (createArea) { createArea.style.display = 'block'; createArea.classList.add('show'); }
        if (createBtn) createBtn.style.display = 'none';
        if (cancelBtn) { cancelBtn.style.display = 'inline-block'; cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancelar Criação'; }
        if (saveBtn) saveBtn.textContent = 'Salvar Equipe';
        setTimeout(()=>{ const input = document.getElementById('teamName'); if (input) input.focus(); },30);
      } else if (mode === 'edit') {
        if (createArea) { createArea.style.display = 'block'; createArea.classList.add('show'); }
        if (createBtn) createBtn.style.display = 'none';
        if (cancelBtn) { cancelBtn.style.display = 'inline-block'; cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancelar Edição'; }
        if (saveBtn) saveBtn.textContent = 'Atualizar Equipe';
      } else {
        if (createArea) { createArea.style.display = 'none'; createArea.classList.remove('show'); }
        if (createBtn) createBtn.style.display = '';
        if (cancelBtn) cancelBtn.style.display = 'none';
        if (saveBtn) saveBtn.textContent = 'Salvar Equipe';
        editingTeamId = null;
      }
    }

    function clearTeamForm() {
      const teamNameEl = document.getElementById("teamName");
      if (teamNameEl) teamNameEl.value = "";
      const radioDiurno = document.querySelector('input[name="teamShift"][value="Diurno"]');
      if (radioDiurno) radioDiurno.checked = true;
      const membersContainer = document.getElementById("membersContainer");
      if (membersContainer) membersContainer.innerHTML = "";
    }

    window.addEventListener('DOMContentLoaded', async () => {
  try {
    // valida autenticação com lógica otimizada
    const authResult = await validateAuthentication();

    if (!authResult.isAuthenticated) {
      // não autenticado -> volta pra login
      window.location.href = './index.html';
      return;
    }

    // compatibilidade: currentUser precisa ter uid (e possivelmente displayName/email)
    currentUser = { uid: authResult.user.uid, email: authResult.user.email, displayName: authResult.user.displayName };

    // salva UID para compatibilidade com resto do app (se necessário)
    try { localStorage.setItem('uid', currentUser.uid); } catch (e) {}

    // inicializa cache / managers / UI
    firebaseCache = new FirebaseCache();
    teamsManager = new OptimizedTeamsManager(firebaseCache, db, currentUser);
    setupModalHandlers();
    setDateToday();
    setupEventListeners();

    try {
      await teamsManager.loadTeams();
      teamsManager.startPeriodicSync();
    } catch (e) {
      console.error('Erro ao carregar dados iniciais:', e);
      showNotification('Erro ao carregar dados iniciais.', 'error');
    }

    // setup infinite scroll depois que DOM e dados estiverem prontos
    setTimeout(()=>setupInfiniteScroll(), 500);

  } catch (e) {
    console.error('Erro na inicialização:', e);
    window.location.href = './index.html';
  }
});

    function setDateToday() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      const el = document.getElementById("dateInput");
      if (el) el.value = `${yyyy}-${mm}-${dd}`;
    }

    function setupEventListeners() {
      const createTeamBtn = document.getElementById("createTeamBtn");
      const cancelCreateBtn = document.getElementById("cancelCreateTeamBtn");
      if (createTeamBtn) createTeamBtn.addEventListener("click", ()=> showCreateArea('create'));
      if (cancelCreateBtn) cancelCreateBtn.addEventListener("click", ()=> { clearTeamForm(); showCreateArea(null); });

      const addMemberBtn = document.getElementById("addMemberBtn");
      const membersContainer = document.getElementById("membersContainer");
      if (addMemberBtn && membersContainer) addMemberBtn.addEventListener("click", ()=> membersContainer.appendChild(createMemberRow()));

      const saveTeamBtn = document.getElementById("saveTeamBtn");
      if (saveTeamBtn) saveTeamBtn.addEventListener("click", handleSaveTeam);

      const editTeamBtn = document.getElementById("editTeamBtn");
      if (editTeamBtn) editTeamBtn.addEventListener("click", handleEditTeam);

      const deleteTeamBtn = document.getElementById("deleteTeamBtn");
      if (deleteTeamBtn) deleteTeamBtn.addEventListener("click", () => {
        const teamSelectManage = document.getElementById("teamSelectManage");
        const teamId = teamSelectManage?.value;
        const teamName = teamSelectManage?.options[teamSelectManage.selectedIndex]?.text || '';
        if (!teamId) { showNotification("Selecione uma equipe para excluir.", "warning"); return; }
        const confirmModal = document.getElementById("confirmModal");
        const confirmMessage = document.getElementById("confirmMessage");
        if (confirmModal && confirmMessage) {
          confirmMessage.textContent = `Deseja apagar a equipe "${teamName}"? Essa alteração não pode ser revertida.`;
          confirmModal.style.display = "flex";
        }
      });

      const loadRecordsBtn = document.getElementById('loadRecordsBtn');
if (loadRecordsBtn) {
  loadRecordsBtn.addEventListener('click', async () => {
    // evita cliques repetidos enquanto já está buscando
    if (isFetchingRecords) return;

    // Se nunca inicializamos, fazemos o primeiro carregamento (reset)
    if (!recordsInitialized) {
      await loadRecords(true);
      // loadRecords(true) já marca recordsInitialized = true internamente
      return;
    }

    // Se já inicializou, carrega o próximo lote (mesma lógica do scroll)
    if (!noMoreRecords) {
      await loadRecords(false);
    }
  });
}

      const submitRecordBtn = document.getElementById("submitRecordBtn");
      if (submitRecordBtn) submitRecordBtn.addEventListener("click", sendRecord);

      // team select change -> usa a função que corrigi
      const teamSelectEl = document.getElementById("teamSelect");
      if (teamSelectEl) teamSelectEl.addEventListener("change", handleTeamSelection);

      const teamSelectManage = document.getElementById("teamSelectManage");
      if (teamSelectManage) teamSelectManage.addEventListener("change", () => { /* placeholder */ });
    }

    async function handleSaveTeam() {
      const name = document.getElementById("teamName")?.value?.trim();
      if (!name) { showNotification("Por favor, informe o nome da equipe.", "info"); return; }
      const shiftRadio = document.querySelector('input[name="teamShift"]:checked');
      const shift = shiftRadio ? shiftRadio.value : "Diurno";
      const members = [];
      const memberRows = document.querySelectorAll("#membersContainer .form-row");
      for (const row of memberRows) {
        const nameInput = row.querySelector(".memberName");
        const matriculaInput = row.querySelector(".memberMatricula");
        const blockInput = row.querySelector(".memberBlock");
        const vesselInput = row.querySelector(".memberVessel");
        if (!nameInput?.value?.trim() || !matriculaInput?.value?.trim()) { showNotification("Todos os membros devem ter nome e matrícula.", "warning"); return; }
        const detailsInput = row.querySelector(".memberDetailsInput");
        const isAbsent = !!row.querySelector(".memberAbsentCheckbox")?.checked;
        if (!isAbsent && !detailsInput?.value?.trim()) { showNotification("O campo Detalhes é obrigatório para membros presentes.", "warning"); return; }
        members.push({
          name: nameInput.value.trim(),
          matricula: matriculaInput.value.trim(),
          block: blockInput.value.trim(),
          vessel: vesselInput.value.trim(),
          local: row.querySelector(".memberLocalSelect")?.value || "",
          customLocal: row.querySelector(".memberCustomLocalInput")?.value.trim() || "",
          details: detailsInput?.value?.trim() || "",
          absent: isAbsent,
          abono: (row.querySelector(".memberAbonoSelect")?.value) || 'VERIFICAR',
          absenceReason: (row.querySelector(".memberAbsenceReasonInput")?.value || '').trim()
        });
      }
      if (members.length === 0) { showNotification("Adicione pelo menos um membro na equipe.", "warning"); return; }
      const teamData = { name, shift, members, ownerUid: currentUser.uid, deleted: false };
      try {
        const teamId = await teamsManager.saveTeam(teamData, editingTeamId);
        showNotification("Equipe salva com sucesso!", "success");
        clearTeamForm(); showCreateArea(null);
      } catch (e) {
        console.error('Erro ao salvar equipe:', e);
        showNotification("Erro ao salvar equipe.", "error");
      }
    }

    async function handleEditTeam() {
      const teamSelectManage = document.getElementById("teamSelectManage");
      const teamId = teamSelectManage?.value;
      if (!teamId) { showNotification("Selecione uma equipe para editar.", "warning"); return; }

      const cacheKey = firebaseCache.getCacheKey('teams', currentUser.uid);
      let teamsData = firebaseCache.getFromMemoryCache(cacheKey);
      if (!teamsData) {
        const local = firebaseCache.getFromLocalStorage(cacheKey, firebaseCache.TTL.teams);
        if (local) { teamsData = new Map(Object.entries(local)); firebaseCache.setMemoryCache(cacheKey, teamsData); }
      }
      if (!teamsData) {
        try { await teamsManager.loadTeams(true); teamsData = firebaseCache.getFromMemoryCache(cacheKey); } catch (e) { console.error("Erro ao carregar equipes:", e); showNotification("Erro ao acessar dados da equipe.", "error"); return; }
      }
      const teamData = teamsData instanceof Map ? teamsData.get(teamId) : teamsData[teamId];
      if (!teamData) { showNotification("Equipe não encontrada.", "warning"); return; }

      const teamNameEl = document.getElementById("teamName"); if (teamNameEl) teamNameEl.value = teamData.name || "";
      const radio = document.querySelector(`input[name="teamShift"][value="${teamData.shift}"]`); if (radio) radio.checked = true;
      const membersContainer = document.getElementById("membersContainer"); if (membersContainer) { membersContainer.innerHTML = ""; (teamData.members || []).forEach(m => membersContainer.appendChild(createMemberRow(m))); }

      editingTeamId = teamId;
      showCreateArea('edit');
      const saveTeamBtn = document.getElementById("saveTeamBtn"); if (saveTeamBtn) saveTeamBtn.innerHTML = '<i class="fas fa-rotate"></i> Atualizar Equipe';
      const createBtn = document.getElementById('createTeamBtn'); if (createBtn) createBtn.style.display = 'none';
      const cancelCreateBtn = document.getElementById('cancelCreateTeamBtn'); if (cancelCreateBtn) cancelCreateBtn.style.display = 'inline-block';
      setTimeout(()=>{ if (teamNameEl) teamNameEl.focus(); }, 40);
    }

    window.addEventListener('beforeunload', () => {
      if (teamsManager) teamsManager.stopPeriodicSync();
    });
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => { if (firebaseCache) firebaseCache.updateConnectionStatus(); }, 150);
    });

    // expose loadRecords
    window.loadRecords = loadRecords;
// ------------------ THEME (claro / escuro) ------------------
// Mantém compatibilidade com o comportamento anterior (usa localStorage 'dark' === '1')
function initDarkMode() {
  try {
    const dark = localStorage.getItem('dark');
    if (dark === '1') {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }

    // se existir checkbox no DOM, atualiza seu estado visual
    const toggle = document.getElementById('themeToggle');
    if (toggle) toggle.checked = (dark === '1');

  } catch (e) {
    // se localStorage não estiver disponível, apenas ignore
    console.warn('Não foi possível aplicar preferência de tema:', e?.message || e);
  }
}

function setDarkMode(enabled) {
  try {
    if (enabled) {
      document.documentElement.classList.add('dark');
      localStorage.setItem('dark', '1');
    } else {
      document.documentElement.classList.remove('dark');
      localStorage.setItem('dark', '0');
    }
    updateThemeUi();
  } catch (e) {
    console.warn('Não foi possível salvar preferência de tema:', e?.message || e);
  }
}

// Attacha eventos ao checkbox (chamar após DOM pronto)
function setupThemeToggleHandler() {
  const toggle = document.getElementById('themeToggle');
  if (toggle) {
    // clique / mudança
    toggle.addEventListener('change', (e) => {
      setDarkMode(!!e.target.checked);
    });
  }

  // sincroniza entre abas / janelas
  window.addEventListener('storage', (e) => {
    if (e.key === 'dark') {
      const newVal = e.newValue === '1';
      document.documentElement.classList.toggle('dark', newVal);
      const toggle = document.getElementById('themeToggle');
      if (toggle) toggle.checked = newVal;
      updateThemeUi();
    }
  });
}

// Chamar init e setup antes de renderizar a UI principal para evitar "flash"
initDarkMode();
setupThemeToggleHandler();
// -------------------------------------------------------------
// efetivo-integration-full.js
// Versão completa pronta para substituir
// - Leitura XLSX robusta
// - Debounce, delayed-not-found, minMatLength=3
// - "Procurando..." no placeholder do campo Nome
// - Preservação de nome manual
// - Notificações dedupe (background rgba(11,12,15,0.9))
// - Icones FontAwesome, origin icon dentro do input (wrapper)
// - MutationObserver desconectável

class MatriculaNameIntegration {
  constructor(options = {}) {
    this.xlsxUrl = options.xlsxUrl || window.EFETIVO_XLSX_URL || './efetivo/dados_efetivo/efetivo.xlsx';
    this.efetivoData = [];
    this._efetivoMap = new Map();
    this.initialized = false;
    this._mutationObserver = null;
    this._loadingPromise = null;
    this._beforeUnloadHandler = null;

    this.options = {
  log: !!options.log,
  minMatLength: typeof options.minMatLength === 'number' ? options.minMatLength : 3,
  debounceMs: typeof options.debounceMs === 'number' ? options.debounceMs : 600,
  delayedNotFoundMs: typeof options.delayedNotFoundMs === 'number' ? options.delayedNotFoundMs : 1500,
  notificationDedupeMs: typeof options.notificationDedupeMs === 'number' ? options.notificationDedupeMs : 5000,
  searchingDisplayMs: typeof options.searchingDisplayMs === 'number' ? options.searchingDisplayMs : 3000
};

    this._activeNotifications = new Map();
    this._lastNotifications = new Map();

    try { ensureFontAwesome(); } catch (e) { console.warn('Não foi possível injetar FontAwesome automaticamente:', e); }

    this.init().catch(err => console.error('Erro init MatriculaNameIntegration:', err));
  }

  log(...args) {
    if (this.options.log) console.log('[MatriculaIntegration]', ...args);
  }

  normalizeMatricula(raw) {
    if (raw == null) return '';
    let s = String(raw).trim();
    s = s.replace(/\.0$/, '').replace(/\s+/g, '').trim();
    return s;
  }

  async init() {
    await this.waitForEfetivoData();
    this.setupMatriculaIntegration();
    this.initialized = true;
    this.log('Inicializado — registros:', this.efetivoData.length);
  }

  async waitForEfetivoData() {
    try {
      const ok = await this.loadFromXlsx();
      if (ok && this.efetivoData.length > 0) return;
    } catch (e) {
      console.warn('Tentativa inicial loadFromXlsx falhou:', e);
    }

    let attempts = 0;
    const maxAttempts = 50;
    while (attempts < maxAttempts) {
      if (Array.isArray(window.efetivoCompleto) && window.efetivoCompleto.length > 0) {
        this.efetivoData = window.efetivoCompleto;
        this.buildMapFromArray(this.efetivoData);
        this.log('efetivo carregado via window.efetivoCompleto:', this.efetivoData.length);
        return;
      }

      if (typeof window.carregarETDistribuir === 'function' && attempts === 10) {
        try {
          await window.carregarETDistribuir();
          if (Array.isArray(window.efetivoCompleto) && window.efetivoCompleto.length > 0) {
            this.efetivoData = window.efetivoCompleto;
            this.buildMapFromArray(this.efetivoData);
            return;
          }
        } catch (e) {
          console.warn('carregarETDistribuir() erro:', e);
        }
      }

      if (attempts === 20) {
        try {
          const ok2 = await this.loadFromXlsx();
          if (ok2 && this.efetivoData.length > 0) return;
        } catch (e) {
          console.warn('Segunda tentativa loadFromXlsx falhou:', e);
        }
      }

      attempts++;
      await new Promise(r => setTimeout(r, 100));
    }

    console.warn('Não foi possível carregar dados do efetivo após tentativas; efetivoData vazio.');
  }

  buildMapFromArray(arr) {
    const mapa = new Map();
    for (const c of (arr || [])) {
      const mat = this.normalizeMatricula(c.matricula || c.matriculaRaw || c.matric || '');
      const nome = (c.nome || c.name || c.Nome || '').trim();
      if (!mat) continue;
      if (!mapa.has(mat)) {
        mapa.set(mat, { nome: nome || '', matricula: mat, raw: c, origem: c.origem || '' });
      } else {
        const prev = mapa.get(mat);
        if ((!prev.nome || prev.nome.length === 0) && nome) mapa.set(mat, { nome, matricula: mat, raw: c, origem: c.origem || '' });
      }
    }
    this._efetivoMap = mapa;
  }

  async loadFromXlsx() {
    if (this._loadingPromise) return this._loadingPromise;
    if (typeof XLSX === 'undefined') {
      console.warn('SheetJS (XLSX) não detectado. CDN sugerido: https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js');
      return false;
    }

    this._loadingPromise = (async () => {
      try {
        const res = await fetch(this.xlsxUrl, { cache: 'no-cache' });
        if (!res.ok) {
          console.warn('Falha ao buscar xlsx:', this.xlsxUrl, res.status, res.statusText);
          return false;
        }
        const ab = await res.arrayBuffer();
        const workbook = XLSX.read(ab, { type: 'array' });

        const sheetName = workbook.SheetNames.find(n => /efetiv/i.test(n)) || workbook.SheetNames[0];
        if (!sheetName) {
          console.warn('Nenhuma sheet encontrada no xlsx');
          return false;
        }
        const ws = workbook.Sheets[sheetName];
        let rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });

        if (!rows || rows.length === 0) {
          console.warn('Planilha vazia:', sheetName);
          return false;
        }

        // expandir merges
        try {
          const merges = ws['!merges'] || [];
          for (const merge of merges) {
            const s = merge.s, e = merge.e;
            const startVal = (rows[s.r] && rows[s.r][s.c]) !== undefined ? rows[s.r][s.c] : '';
            for (let rr = s.r; rr <= e.r; rr++) {
              rows[rr] = rows[rr] || [];
              for (let cc = s.c; cc <= e.c; cc++) {
                if (rows[rr][cc] === undefined || rows[rr][cc] === '') rows[rr][cc] = startVal;
              }
            }
          }
        } catch (e) {
          console.warn('Falha ao expandir merges (continuando):', e);
        }

        // detectar header rows e encontrar primeira linha de dados
        const headerKeywords = ['matr', 'matrícula', 'matricula', 'nome', 'nome completo', 'mat.', 'cpf', 'rg', 'colaborador', 'funcao', 'função', 'equipe', 'setor', 'cargo', 'matrícula/contrato'];
        function isHeaderRow(row) {
          if (!row || row.length === 0) return false;
          let nonEmpty = 0;
          let textLike = 0;
          let keyMatches = 0;
          for (const cell of row) {
            const txt = String(cell || '').toLowerCase().trim();
            if (!txt) continue;
            nonEmpty++;
            const cleanedNum = txt.replace(/[.,\s]/g, '');
            if (isNaN(Number(cleanedNum))) {
              if (txt.length >= 2) textLike++;
            }
            for (const kw of headerKeywords) {
              if (txt.includes(kw)) {
                keyMatches++;
              }
            }
          }
          if (keyMatches >= 1) return true;
          if (nonEmpty > 0 && (textLike / nonEmpty) > 0.6) return true;
          return false;
        }

        let startRow = 0;
        let found = false;
        for (let r = 0; r < rows.length; r++) {
          if (isHeaderRow(rows[r])) {
            continue;
          }
          const row = rows[r] || [];
          const numRegex = /^\s*\d+(?:\.0)?\s*$/;
          const nameRegex = /^[A-Za-zÀ-ÖØ-öø-ÿ\.\- ]{3,}$/;
          const hasNum = row.some(cell => numRegex.test(String(cell || '')));
          const hasName = row.some(cell => nameRegex.test(String(cell || '')));
          if (hasNum && hasName) {
            startRow = r;
            found = true;
            break;
          }
        }
        if (!found) {
          for (let r = 0; r < rows.length; r++) {
            const row = rows[r] || [];
            const hasNum = row.some(cell => /^\s*\d+(?:\.0)?\s*$/.test(String(cell || '')));
            if (hasNum) {
              startRow = r;
              found = true;
              break;
            }
          }
        }
        if (startRow < 0) startRow = 0;
        if (startRow >= rows.length) startRow = 0;

        // build stats por coluna
        const effectiveRows = rows.slice(startRow);
        const maxRowsToCheck = Math.min(effectiveRows.length, 1000);
        const colCount = Math.max(...effectiveRows.map(r => (r || []).length));
        const stats = Array.from({ length: colCount }, () => ({ numLike: 0, nameLike: 0 }));
        const nameRegex = /^[A-Za-zÀ-ÖØ-öø-ÿ\.\- ]{3,}$/;
        const numRegex = /^\s*\d+(?:\.0)?\s*$/;

        for (let r = 0; r < maxRowsToCheck; r++) {
          const row = effectiveRows[r] || [];
          for (let c = 0; c < colCount; c++) {
            const cell = String(row[c] ?? '').trim();
            if (!cell) continue;
            if (numRegex.test(cell)) stats[c].numLike++;
            if (nameRegex.test(cell)) stats[c].nameLike++;
          }
        }

        const thresholdNum = 6;
        const thresholdName = 6;
        const usedPairs = new Set();
        const foundPairs = [];

        for (let c = 0; c < colCount; c++) {
          if (stats[c].numLike >= thresholdNum) {
            for (let offset = 1; offset <= 4 && (c + offset) < colCount; offset++) {
              const nc = c + offset;
              if (stats[nc].nameLike >= thresholdName) {
                const key = `${c}:${nc}`;
                if (!usedPairs.has(key)) {
                  usedPairs.add(key);
                  foundPairs.push({ matCol: c, nameCol: nc });
                }
                break;
              }
            }
          }
          if (stats[c].nameLike >= thresholdName) {
            for (let offset = 1; offset <= 4 && (c + offset) < colCount; offset++) {
              const nc = c + offset;
              if (stats[nc].numLike >= thresholdNum) {
                const key = `${nc}:${c}`;
                if (!usedPairs.has(key)) {
                  usedPairs.add(key);
                  foundPairs.push({ matCol: nc, nameCol: c });
                }
                break;
              }
            }
          }
        }

        if (foundPairs.length === 0) {
          for (let c = 0; c < colCount - 1; c++) {
            if (stats[c].numLike > 5 && stats[c + 1].nameLike > 5) {
              foundPairs.push({ matCol: c, nameCol: c + 1 });
              break;
            }
          }
          if (foundPairs.length === 0) {
            const bestNum = stats.map((s, i) => ({ i, s: s.numLike })).sort((a, b) => b.s - a.s)[0];
            const bestName = stats.map((s, i) => ({ i, s: s.nameLike })).sort((a, b) => b.s - a.s)[0];
            if (bestNum && bestName && bestNum.s > 3 && bestName.s > 3) {
              foundPairs.push({ matCol: bestNum.i, nameCol: bestName.i });
            }
          }
        }

        const mapa = new Map();

        for (const pair of foundPairs) {
          const mc = pair.matCol, nc = pair.nameCol;
          for (let r = 0; r < effectiveRows.length; r++) {
            const row = effectiveRows[r] || [];
            const rawMat = String(row[mc] ?? '').trim();
            const rawName = String(row[nc] ?? '').trim();
            if (!rawMat) continue;
            const matric = this.normalizeMatricula(rawMat);
            if (!matric) continue;
            if (!mapa.has(matric)) {
              mapa.set(matric, { nome: rawName || '', matricula: matric, origem: `sheet:${sheetName} col${mc}-${nc}` });
            } else {
              const prev = mapa.get(matric);
              if ((!prev.nome || prev.nome.length === 0) && rawName && rawName.length > 0) {
                mapa.set(matric, { nome: rawName, matricula: matric, origem: `sheet:${sheetName} col${mc}-${nc}` });
              }
            }
          }
        }

        if (mapa.size === 0) {
          for (let c = 0; c < colCount - 1; c++) {
            for (let r = 0; r < effectiveRows.length; r++) {
              const row = effectiveRows[r] || [];
              const rawMat = String(row[c] ?? '').trim();
              const rawName = String(row[c + 1] ?? '').trim();
              if (!rawMat) continue;
              const matric = this.normalizeMatricula(rawMat);
              if (!matric) continue;
              if (!mapa.has(matric)) mapa.set(matric, { nome: rawName || '', matricula: matric, origem: `adj:${c}-${c+1}` });
            }
          }
        }

        const lista = [];
        for (const [mat, obj] of mapa.entries()) {
          lista.push({ nome: obj.nome, matricula: obj.matricula, cargo: '', entrada: '', status: 'ativo', equipeHint: '' });
        }

        this.efetivoData = lista;
        this._efetivoMap = mapa;

        try { window.efetivoCompleto = window.efetivoCompleto || this.efetivoData; } catch (e) {}

        this.log('loadFromXlsx (multiblocos + merges+headers): pares detectados:', foundPairs.length, 'registros finais:', lista.length, 'sheet:', sheetName, 'startRow:', startRow);
        return true;
      } catch (err) {
        console.error('Erro ao carregar/parsear xlsx (multiblocos):', err);
        return false;
      } finally {
        this._loadingPromise = null;
      }
    })();

    return this._loadingPromise;
  }

  async loadFromJSONFallback() {
    const equipesArquivos = {
      Montagem: './dados_efetivo/colaboradores_montagem.json',
      Desempeno: './dados_efetivo/colaboradores_desempeno.json',
      'Meio Oficial': './dados_efetivo/colaboradores_meio_oficial.json',
      Andaimes: './dados_efetivo/colaboradores_andaimes.json',
      Soldador: './dados_efetivo/colaboradores_soldador.json',
      CEFAP: './dados_efetivo/colaboradores_cefap.json',
      Liderança: './dados_efetivo/colaboradores_lideranca.json'
    };

    const lista = [];
    for (const [equipe, url] of Object.entries(equipesArquivos)) {
      try {
        const res = await fetch(url);
        if (!res.ok) continue;
        const dados = await res.json();
        for (const colab of dados) {
          lista.push({
            nome: colab.nome || colab.Nome || '',
            matricula: colab.matricula || colab.Matrícula || '',
            cargo: colab.nivel || colab.cargo || colab.funcao || '',
            entrada: colab.entrada || colab.data || '',
            status: colab.status || 'ativo',
            equipeHint: equipe
          });
        }
      } catch (e) {
        console.warn('Erro carregando JSON fallback', url, e);
      }
    }
    this.efetivoData = lista;
    this.buildMapFromArray(lista);
    this.log('Dados carregados do JSON fallback:', lista.length);
  }

  setupMatriculaIntegration() {
    if (typeof window.refreshMatriculaIntegration !== 'function') {
      window.refreshMatriculaIntegration = () => this.refreshMatriculaIntegration();
    }
    if (typeof window.cleanupMatriculaIntegration !== 'function') {
      window.cleanupMatriculaIntegration = () => this.disconnect();
    }
    this.refreshMatriculaIntegration();
    this.setupDynamicFieldsObserver();
  }

  refreshMatriculaIntegration() {
    document.querySelectorAll('.memberName, .shiftName').forEach(n => {
      try {
        if (!n.value || String(n.value).trim() === '') {
          n.disabled = true;
          n.style.backgroundColor = '#f5f5f5';
          n.style.cursor = 'not-allowed';
          n.style.opacity = '0.7';
          this.setNameOrigin(n, 'unknown');
          // placeholder padrão
          if (!n.placeholder) n.placeholder = 'Nome';
        } else {
          n.disabled = false;
          const row = n.closest('.form-row');
          const matInput = row?.querySelector('.memberMatricula, .shiftMatricula');
          if (matInput) {
            const mat = this.normalizeMatricula(matInput.value || '');
            if (mat && this._efetivoMap && this._efetivoMap.has(mat)) {
              const entry = this._efetivoMap.get(mat);
              this.setNameOrigin(n, 'efetivo', entry.origem);
            } else {
              this.setNameOrigin(n, 'manual');
            }
          } else {
            this.setNameOrigin(n, 'manual');
          }
        }
      } catch (e) {}
    });

    document.querySelectorAll('.memberMatricula, .shiftMatricula').forEach(inp => {
      try {
        const row = inp.closest('.form-row');
        const nameInput = row?.querySelector('.memberName, .shiftName');
        if (nameInput) {
          const value = String(inp.value || '').trim();
          if (value && this.normalizeMatricula(value).length >= this.options.minMatLength) {
            this.searchAndFillName(value, nameInput, { suppressNotFound: true, matriculaField: inp });
          }
        }
      } catch (e) {}
    });
  }

  // helper para garantir wrapper ao redor do input (para ícone ficar dentro da caixa)
  ensureInputWrapper(inputEl) {
    if (!inputEl || !inputEl.parentElement) return inputEl.parentElement || inputEl;
    const existingWrapper = inputEl.closest('.input-icon-wrapper');
    if (existingWrapper) return existingWrapper;
    const wrapper = document.createElement('div');
    wrapper.className = 'input-icon-wrapper';
    const parent = inputEl.parentElement;
    parent.replaceChild(wrapper, inputEl);
    wrapper.appendChild(inputEl);
    return wrapper;
  }

  setNameOrigin(nameField, origin = 'unknown', sourceInfo = '') {
    try {
      if (!nameField) return;
      if (nameField._suppressOrigin) return;
      nameField.classList.remove('origin-efetivo', 'origin-manual', 'origin-unknown');
      nameField.setAttribute('data-origin', origin);

      // remover ícone existente (no wrapper)
      const wrapper = this.ensureInputWrapper(nameField);
      const existing = wrapper?.querySelector('.name-origin-icon');
      if (existing) existing.remove();

      const icon = document.createElement('i');
      icon.classList.add('name-origin-icon', 'fa-fw');
      icon.setAttribute('aria-hidden', 'true');
      icon.style.cssText = 'position:absolute;right:25px;top:50%;transform:translateY(-50%);font-size:14px;line-height:1;pointer-events:auto;cursor:default;';

      if (origin === 'efetivo') {
        nameField.classList.add('origin-efetivo');
        icon.classList.add('fas', 'fa-check-circle');
        icon.title = sourceInfo ? `Nome preenchido automaticamente (origem: ${sourceInfo})` : 'Nome preenchido automaticamente (efetivo)';
      } else if (origin === 'manual') {
        nameField.classList.add('origin-manual');
        icon.classList.add('fas', 'fa-pencil-alt');
        icon.title = 'Nome inserido/alterado manualmente';
      } else {
        nameField.classList.add('origin-unknown');
        icon.classList.add('fas', 'fa-info-circle');
        icon.title = 'Origem do nome: desconhecida';
      }
      icon.setAttribute('role', 'img');
      icon.setAttribute('aria-label', icon.title);
      wrapper.style.position = wrapper.style.position || 'relative';
      wrapper.appendChild(icon);

      // ajuste padding-right do input para caber o ícone
      try {
        const computed = window.getComputedStyle(nameField);
        const currentPaddingRight = parseFloat(computed.paddingRight || 0);
        const needed = 40;
        if (currentPaddingRight < needed) {
          nameField.style.paddingRight = (needed + 6) + 'px';
        }
      } catch (e) {}
    } catch (e) {
      console.warn('setNameOrigin erro:', e);
    }
  }

  _setNameProgrammatically(nameField, value) {
    try {
      try { delete nameField.dataset.manualEntered; } catch(e) {}
      nameField._suppressOrigin = true;
      nameField.value = value;
      setTimeout(() => { nameField._suppressOrigin = false; }, 50);
    } catch (e) {}
  }

  setupExistingFields() {
    document.querySelectorAll('.memberMatricula').forEach(f => this.setupMatriculaField(f, 'member'));
    document.querySelectorAll('.shiftMatricula').forEach(f => this.setupMatriculaField(f, 'shift'));
  }

  setupDynamicFieldsObserver() {
    if (this._mutationObserver) return;
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        mutation.addedNodes.forEach((node) => {
          if (node.nodeType !== 1) return;
          const matriculaFields = node.querySelectorAll ? node.querySelectorAll('.memberMatricula, .shiftMatricula') : [];
          matriculaFields.forEach(field => {
            if (!field.hasAttribute('data-matricula-setup')) {
              const type = field.classList.contains('memberMatricula') ? 'member' : 'shift';
              this.setupMatriculaField(field, type);
            }
          });
          if (node.classList && (node.classList.contains('memberMatricula') || node.classList.contains('shiftMatricula'))) {
            if (!node.hasAttribute('data-matricula-setup')) {
              const type = node.classList.contains('memberMatricula') ? 'member' : 'shift';
              this.setupMatriculaField(node, type);
            }
          }
        });
      });
    });

    observer.observe(document.body, { childList: true, subtree: true });
    this._mutationObserver = observer;

    this._beforeUnloadHandler = () => {
      try {
        this.disconnect();
      } catch (e) { /* ignore */ }
    };
    window.addEventListener('beforeunload', this._beforeUnloadHandler);
    window.addEventListener('pagehide', this._beforeUnloadHandler);
  }

  disconnect() {
    try {
      if (this._mutationObserver) {
        try { this._mutationObserver.disconnect(); } catch (e) { /* ignore */ }
        this._mutationObserver = null;
      }
      if (this._beforeUnloadHandler) {
        try { window.removeEventListener('beforeunload', this._beforeUnloadHandler); } catch (e) {}
        try { window.removeEventListener('pagehide', this._beforeUnloadHandler); } catch (e) {}
        this._beforeUnloadHandler = null;
      }
      this.log('MutationObserver desconectado e handlers removidos.');
    } catch (e) {
      console.warn('Erro ao desconectar MutationObserver:', e);
    }
  }

  setupMatriculaField(matriculaField, type) {
    if (!matriculaField || matriculaField.hasAttribute('data-matricula-setup')) return;
    matriculaField.setAttribute('data-matricula-setup', 'true');

    const nameField = this.findCorrespondingNameField(matriculaField, type);
    if (!nameField) return;

    this.disableNameField(nameField);
    this.setupMatriculaEvents(matriculaField, nameField);
    this.setupNameFieldEvents(nameField, matriculaField);

    nameField.addEventListener('input', (e) => {
      if (nameField._suppressOrigin) return;
      try {
        nameField.dataset.manualEntered = '1';
        const normalizedMat = this.normalizeMatricula(matriculaField.value || '');
        if (normalizedMat) matriculaField.dataset.manualNameMatricula = normalizedMat;
      } catch (err) {}
      this.setNameOrigin(nameField, 'manual');
    });
  }

  findCorrespondingNameField(matriculaField, type) {
    const container = matriculaField.closest('.form-row');
    if (!container) return null;
    const nameClass = type === 'member' ? '.memberName' : '.shiftName';
    return container.querySelector(nameClass);
  }

  // substitua disableNameField por esta versão
disableNameField(nameField) {
  try {
    // mantém o disabled (ou você pode remover se preferir readonly)
    nameField.disabled = true;
    nameField.style.backgroundColor = '#f5f5f5';
    nameField.style.cursor = 'not-allowed';
    nameField.style.opacity = '0.7';
    nameField.title = 'Digite a matrícula para preencher automaticamente o nome';
    if (!nameField.placeholder) nameField.placeholder = 'Nome';

    const wrapper = this.ensureInputWrapper(nameField);

    // ícone de cadeado (mantém compatibilidade com seu código)
    if (wrapper && !wrapper.querySelector('.name-disabled-icon')) {
      const icon = document.createElement('i');
      icon.className = 'fas fa-lock name-disabled-icon';
      icon.style.cssText = 'position:absolute;right:8px;top:50%;transform:translateY(-50%);color:var(--bg);pointer-events:none;z-index:1;';
      wrapper.style.position = wrapper.style.position || 'relative';
      wrapper.appendChild(icon);
    }

    // overlay que captura cliques mesmo com input disabled
    if (wrapper && !wrapper.querySelector('.name-disabled-overlay')) {
      const overlay = document.createElement('button'); // usar button melhora acessibilidade
      overlay.type = 'button';
      overlay.className = 'name-disabled-overlay';
      overlay.setAttribute('aria-hidden', 'true');
      overlay.style.cssText = [
        'position:absolute',
        'inset:0',
        'border:0',
        'background:transparent',
        'cursor:not-allowed',
        'z-index:2',
        'padding:0',
        'margin:0'
      ].join(';');
      // click do overlay mostra notificação e foca no campo matrícula
      const clickHandler = (e) => {
        e.preventDefault();
        try {
          this.showNameFieldNotification(nameField);
          const row = nameField.closest('.form-row');
          const mat = row?.querySelector('.memberMatricula, .shiftMatricula');
          if (mat) mat.focus();
        } catch (err) { console.warn('overlay click erro:', err); }
      };
      overlay.addEventListener('click', clickHandler);
      // guarda referência pro possível cleanup
      overlay._matOverlayHandler = clickHandler;
      wrapper.appendChild(overlay);
    }

    this.setNameOrigin(nameField, 'unknown');
  } catch (e) {
    console.warn('disableNameField erro:', e);
  }
}

enableNameField(nameField) {
  try {
    nameField.disabled = false;
    nameField.style.backgroundColor = '';
    nameField.style.cursor = '';
    nameField.style.opacity = '';
    nameField.title = '';
    const wrapper = this.ensureInputWrapper(nameField);
    if (wrapper) {
      // remove ícone de cadeado se existir
      const icon = wrapper.querySelector('.name-disabled-icon');
      if (icon) icon.remove();

      // remove overlay se existir (e listener)
      const overlay = wrapper.querySelector('.name-disabled-overlay');
      if (overlay) {
        try {
          if (overlay._matOverlayHandler) overlay.removeEventListener('click', overlay._matOverlayHandler);
        } catch (err) {}
        overlay.remove();
      }

      const successIcon = document.createElement('i');
      successIcon.className = 'fas fa-check-circle';
      successIcon.style.cssText = 'position:absolute;right:8px;top:50%;transform:translateY(-50%);color:#10b981;pointer-events:none;z-index:1;animation:fadeInOut 2s ease;';
      wrapper.appendChild(successIcon);
      setTimeout(() => successIcon.remove(), 2000);
    }
  } catch (e) {
    console.warn('enableNameField erro:', e);
  }
}

  // showLoadingForField: mostra "Procurando..." no placeholder do campo Nome (sem apagar value do usuário)
  showLoadingForField(matriculaField) {
  try {
    if (!matriculaField) return;
    if (matriculaField.dataset._searching === '1') return;
    matriculaField.dataset._searching = '1';

    const row = matriculaField.closest('.form-row');
    const nameField = row?.querySelector('.memberName, .shiftName');

    // remover spinner legado
    try {
      const parent = matriculaField.parentElement;
      const oldIcon = parent?.querySelector('.matricula-loading-icon');
      if (oldIcon) oldIcon.remove();
    } catch(e){}

    if (nameField) {
  const nameIsManual = nameField.dataset && nameField.dataset.manualEntered === '1';
  if (!nameIsManual) {
    if (!nameField.dataset._prevPlaceholder) {
      nameField.dataset._prevPlaceholder = String(nameField.placeholder || '');
    }
    nameField.dataset._prevDisabled = nameField.disabled ? '1' : '0';
    nameField.placeholder = 'Procurando...';
    nameField.classList.add('matricula-name-searching');
    nameField.disabled = true;
    
    // NOVO: Armazenar timestamp de quando começou a procurar
    nameField.dataset._searchStartTime = Date.now().toString();
    
    // NOVO: Limpar flag de placeholder especial quando iniciar nova busca
    delete nameField.dataset._hasNotFoundPlaceholder;
    
    // NOVO: Limpar qualquer timer anterior
    if (matriculaField._searchingDisplayTimer) {
      clearTimeout(matriculaField._searchingDisplayTimer);
      matriculaField._searchingDisplayTimer = null;
    }
  }
}
  } catch (e) {
    console.warn('showLoadingForField erro:', e);
  }
}

  // hideLoadingForField: restaura placeholder e estado anterior, ou chama resetNamePlaceholderIfEmpty
  hideLoadingForField(matriculaField) {
  try {
    if (!matriculaField) return;
    delete matriculaField.dataset._searching;

    const row = matriculaField.closest('.form-row');
    const nameField = row?.querySelector('.memberName, .shiftName');

    // remover spinner legado
    try {
      const parent = matriculaField.parentElement;
      const oldIcon = parent?.querySelector('.matricula-loading-icon');
      if (oldIcon) oldIcon.remove();
    } catch(e){}

    if (nameField) {
      const nameIsManual = nameField.dataset && nameField.dataset.manualEntered === '1';
      if (!nameIsManual) {
        // NOVO: Verificar tempo decorrido
        const searchStartTime = parseInt(nameField.dataset._searchStartTime || '0');
        const currentTime = Date.now();
        const elapsedTime = currentTime - searchStartTime;
        const minDisplayTime = this.options.searchingDisplayMs;
        
        if (elapsedTime < minDisplayTime) {
          // Ainda não passou tempo suficiente, aguardar
          const remainingTime = minDisplayTime - elapsedTime;
          matriculaField._searchingDisplayTimer = setTimeout(() => {
            this._actuallyHideLoading(nameField);
            matriculaField._searchingDisplayTimer = null;
          }, remainingTime);
        } else {
          // Tempo já passou, pode esconder imediatamente
          this._actuallyHideLoading(nameField);
        }
      }
    }

    if (nameField) {
  // Só resetar se não estiver aguardando o timer E se não tiver placeholder especial
  if (!matriculaField._searchingDisplayTimer) {
    const currentPlaceholder = nameField.placeholder || '';
    // Não resetar se já tem placeholder de "não encontrado" 
    if (!currentPlaceholder.includes('não encontrado') && !currentPlaceholder.includes('digite manualmente')) {
      this.resetNamePlaceholderIfEmpty(matriculaField, nameField);
    }
  }
}
  } catch (e) {
    console.warn('hideLoadingForField erro:', e);
  }
}

_actuallyHideLoading(nameField) {
  try {
    // NOVO: Preservar placeholder especial de "não encontrado"
    const hasNotFoundPlaceholder = nameField.dataset._hasNotFoundPlaceholder === '1';
    
    if (!hasNotFoundPlaceholder) {
      if (typeof nameField.dataset._prevPlaceholder !== 'undefined') {
        nameField.placeholder = nameField.dataset._prevPlaceholder || '';
        delete nameField.dataset._prevPlaceholder;
      } else {
        nameField.placeholder = '';
      }
    }
    // Se tem placeholder de "não encontrado", não alterar o placeholder
    
    if (typeof nameField.dataset._prevDisabled !== 'undefined') {
      nameField.disabled = nameField.dataset._prevDisabled === '1';
      delete nameField.dataset._prevDisabled;
    }
    nameField.classList.remove('matricula-name-searching');
    delete nameField.dataset._searchStartTime;
  } catch (e) {
    console.warn('_actuallyHideLoading erro:', e);
  }
}


  // restaura placeholder "Nome" se tanto matrícula quanto nome estiverem vazios
  resetNamePlaceholderIfEmpty(matriculaField, nameField) {
  try {
    const matVal = String((matriculaField?.value) || '').trim();
    const nameVal = String((nameField?.value) || '').trim();
    if (!matVal && !nameVal) {
      try { delete nameField.dataset.manualEntered; } catch(e){}
      try { delete matriculaField.dataset.manualNameMatricula; } catch(e){}
      try { delete nameField.dataset._prevPlaceholder; } catch(e){}
      try { delete nameField.dataset._prevDisabled; } catch(e){}
      
      // NOVO: Verificar se o campo tem um placeholder específico (não encontrado)
      const currentPlaceholder = nameField.placeholder || '';
      if (!currentPlaceholder.includes('não encontrado') && !currentPlaceholder.includes('digite manualmente')) {
        nameField.placeholder = 'Nome';
      }
      // Se já tem placeholder de "não encontrado", manter ele
      
      nameField.classList.remove('matricula-name-searching');
      nameField.disabled = true;
      this.setNameOrigin(nameField, 'unknown');
    }
  } catch (e) {
    console.warn('resetNamePlaceholderIfEmpty erro:', e);
  }
}

  setupMatriculaEvents(matriculaField, nameField) {
    matriculaField._matricula_debounce = matriculaField._matricula_debounce || null;
    matriculaField._delayedNotFoundTimer = matriculaField._delayedNotFoundTimer || null;
    const minLen = this.options.minMatLength;
    const dbMs = this.options.debounceMs;
    const delayedNotFoundMs = this.options.delayedNotFoundMs;

    const clearDelayedNotFound = () => {
      try {
        if (matriculaField._delayedNotFoundTimer) {
          clearTimeout(matriculaField._delayedNotFoundTimer);
          matriculaField._delayedNotFoundTimer = null;
        }
      } catch (e) {}
    };

    const handleInput = (value) => {
      clearDelayedNotFound();
      this.hideLoadingForField(matriculaField);

      const normalizedVal = this.normalizeMatricula(value);
      const manualMatForThis = matriculaField.dataset.manualNameMatricula || '';
      const nameIsManual = nameField.dataset && nameField.dataset.manualEntered === '1';

      if (!value || normalizedVal.length < minLen) {
        if (nameIsManual && manualMatForThis && manualMatForThis === normalizedVal) {
          this.setNameOrigin(nameField, 'manual');
          return;
        } else {
          try {
            if (!nameField._suppressOrigin) {
              try { delete nameField.dataset.manualEntered; } catch(e){}
              try { delete matriculaField.dataset.manualNameMatricula; } catch(e){}
              nameField.value = '';
              this.disableNameField(nameField);
            }
          } catch(e){}
          if (matriculaField._matricula_debounce) clearTimeout(matriculaField._matricula_debounce);
          this.resetNamePlaceholderIfEmpty(matriculaField, nameField);
          return;
        }
      }

      if (nameIsManual && manualMatForThis && manualMatForThis !== normalizedVal) {
        try {
          delete nameField.dataset.manualEntered;
          delete matriculaField.dataset.manualNameMatricula;
        } catch(e){}
      }

      if (matriculaField._matricula_debounce) clearTimeout(matriculaField._matricula_debounce);
      this.showLoadingForField(matriculaField);

      matriculaField._matricula_debounce = setTimeout(() => {
        clearDelayedNotFound();
        this.searchAndFillName(value, nameField, { suppressNotFound: true, matriculaField });
      }, dbMs);
    };

    matriculaField.addEventListener('input', (e) => handleInput(e.target.value.trim()));

    matriculaField.addEventListener('blur', (e) => {
      const v = e.target.value.trim();
      if (matriculaField._matricula_debounce) {
        clearTimeout(matriculaField._matricula_debounce);
        matriculaField._matricula_debounce = null;
      }
      if (matriculaField._delayedNotFoundTimer) {
        clearTimeout(matriculaField._delayedNotFoundTimer);
        matriculaField._delayedNotFoundTimer = null;
      }
      const normalizedVal = this.normalizeMatricula(v);
      const manualMatForThis = matriculaField.dataset.manualNameMatricula || '';
      const nameIsManual = nameField.dataset && nameField.dataset.manualEntered === '1';

      if (v && normalizedVal.length >= minLen) {
        if (nameIsManual && manualMatForThis && manualMatForThis === normalizedVal) {
          this.enableNameField(nameField);
          this.setNameOrigin(nameField, 'manual');
          this.hideLoadingForField(matriculaField);
          return;
        }

        this.showLoadingForField(matriculaField);
        this.searchAndFillName(v, nameField, { suppressNotFound: false, matriculaField });
      } else {
        this.hideLoadingForField(matriculaField);
        this.resetNamePlaceholderIfEmpty(matriculaField, nameField);
      }
    });

    const observerCleanup = new MutationObserver((mutations) => {
      if (!document.body.contains(matriculaField)) {
        try {
          if (matriculaField._matricula_debounce) clearTimeout(matriculaField._matricula_debounce);
          if (matriculaField._delayedNotFoundTimer) clearTimeout(matriculaField._delayedNotFoundTimer);
          this.hideLoadingForField(matriculaField);
        } catch (e) {}
        observerCleanup.disconnect();
      }
    });
    observerCleanup.observe(document.body, { childList: true, subtree: true });
  }

  setupNameFieldEvents(nameField, matriculaField) {
    nameField.addEventListener('click', (e) => {
      if (nameField.disabled) {
        e.preventDefault();
        this.showNameFieldNotification(nameField);
      }
    });

    nameField.addEventListener('focus', (e) => {
      if (nameField.disabled) {
        e.preventDefault();
        nameField.blur();
        this.showNameFieldNotification(nameField);
        matriculaField.focus();
      }
    });

    nameField.addEventListener('change', () => {
      if (nameField.dataset && nameField.dataset.manualEntered === '1') {
        const normalizedMat = this.normalizeMatricula(matriculaField.value || '');
        if (normalizedMat) matriculaField.dataset.manualNameMatricula = normalizedMat;
      }
    });
  }

  searchAndFillName(matricula, nameField, opts = {}) {
    if (!matricula) return;
    const normalized = this.normalizeMatricula(matricula);
    if (!normalized) return;
    if (normalized.length < this.options.minMatLength) {
      this.log('Busca ignorada — matrícula menor que minMatLength:', normalized);
      return;
    }

    const suppressNotFound = !!opts.suppressNotFound;
    const matriculaField = opts.matriculaField || (nameField?.closest ? nameField.closest('.form-row')?.querySelector('.memberMatricula, .shiftMatricula') : null);
    try {
      if (matriculaField && matriculaField._delayedNotFoundTimer) {
        clearTimeout(matriculaField._delayedNotFoundTimer);
        matriculaField._delayedNotFoundTimer = null;
      }
    } catch (e) {}

    if (!this._efetivoMap || this._efetivoMap.size === 0) {
      if (!this._loadingPromise) {
        this._loadingPromise = this.loadFromXlsx();
      }
      if (this._loadingPromise) {
        this._loadingPromise.then(() => {
          try { this._tryFillFromMap(normalized, nameField, { suppressNotFound, matriculaField }); } catch(e){}
        }).catch(() => {
          if (matriculaField) this.hideLoadingForField(matriculaField);
        });
      } else {
        if (matriculaField) this.hideLoadingForField(matriculaField);
      }
      return;
    }

    this._tryFillFromMap(normalized, nameField, { suppressNotFound, matriculaField });
  }

  _tryFillFromMap(normalizedMatricula, nameField, opts = {}) {
    const suppressNotFound = !!opts.suppressNotFound;
    const matriculaField = opts.matriculaField || (nameField?.closest ? nameField.closest('.form-row')?.querySelector('.memberMatricula, .shiftMatricula') : null);

    try {
      if (matriculaField) this.hideLoadingForField(matriculaField);
    } catch (e) {}

    const entry = this._efetivoMap.get(normalizedMatricula);

    try {
      if (matriculaField && matriculaField._delayedNotFoundTimer) {
        clearTimeout(matriculaField._delayedNotFoundTimer);
        matriculaField._delayedNotFoundTimer = null;
      }
    } catch (e) {}

    if (entry && entry.nome) {
  // NOVO: Esconder loading imediatamente quando encontrar
  try {
    if (matriculaField) this.hideLoadingForField(matriculaField);
  } catch (e) {}
  
  try { delete nameField.dataset.manualEntered; } catch(e){}
  try { delete matriculaField.dataset.manualNameMatricula; } catch(e){}
  try { delete nameField.dataset._hasNotFoundPlaceholder; } catch(e){}
  this._setNameProgrammatically(nameField, entry.nome);
  this.enableNameField(nameField);
  this.setNameOrigin(nameField, 'efetivo', entry.origem || '');
  this.showSuccessNotification(`Nome preenchido: ${entry.nome} (editável)`);
  this.log('Matrícula encontrada:', normalizedMatricula, '→', entry.nome);
  return;
}

    const nameIsManual = nameField.dataset && nameField.dataset.manualEntered === '1';
    const manualMatForThis = matriculaField ? (matriculaField.dataset.manualNameMatricula || '') : '';
    if (nameIsManual && manualMatForThis && manualMatForThis === normalizedMatricula) {
  // NOVO: Esconder loading para nomes manuais
  try {
    if (matriculaField) this.hideLoadingForField(matriculaField);
  } catch (e) {}
  
  this.enableNameField(nameField);
  this.setNameOrigin(nameField, 'manual');
  this.log('Matrícula não encontrada, mas existe nome manual associado — preservando.');
  return;
}

    if (suppressNotFound) {
      if (matriculaField) {
        try {
          const delayed = this.options.delayedNotFoundMs;
          if (matriculaField._delayedNotFoundTimer) clearTimeout(matriculaField._delayedNotFoundTimer);
          const currentVal = String(matriculaField.value || '').trim();
          matriculaField._delayedNotFoundTimer = setTimeout(() => {
            if (String(matriculaField.value || '').trim() === currentVal && this.normalizeMatricula(currentVal).length >= this.options.minMatLength) {
              this._tryFillFromMap(this.normalizeMatricula(currentVal), nameField, { suppressNotFound: false, matriculaField: matriculaField });
            }
            matriculaField._delayedNotFoundTimer = null;
          }, delayed);
        } catch (e) {
          this.enableNameField(nameField);
          this.setNameOrigin(nameField, 'manual');
        }
      } else {
        this.enableNameField(nameField);
        this.setNameOrigin(nameField, 'manual');
      }
    } else {
  // NOVO: Aguardar tempo mínimo antes de permitir digitação manual
  try {
    if (matriculaField) this.hideLoadingForField(matriculaField);
  } catch (e) {}
  
  // Aguardar o hideLoadingForField processar antes de habilitar o campo
  setTimeout(() => {
    this.enableNameField(nameField);
    this.setNameOrigin(nameField, 'manual');
    if (!(nameField.dataset && nameField.dataset.manualEntered === '1')) {
      nameField.value = '';
    }
    nameField.placeholder = 'Nome não encontrado - digite manualmente';
    
    // NOVO: Marcar que este campo tem placeholder especial
    nameField.dataset._hasNotFoundPlaceholder = '1';
    
    try { nameField.focus(); } catch(e){}
    if (!(nameField.dataset && nameField.dataset.manualEntered === '1')) {
      this.showWarningNotification(`Matrícula ${normalizedMatricula} não encontrada no efetivo. Digite o nome manualmente.`);
    } else {
      this.log('Notificação de não encontrado suprimida pois existe nome manual.');
    }
    this.log('Matrícula não encontrada (confirmado):', normalizedMatricula);
  }, 100);
}
  }

  showNameFieldNotification(nameField) {
    this.showInfoNotification('Campo bloqueado! Digite a matrícula primeiro para preencher automaticamente o nome.', 6000);
    nameField.style.animation = 'shake 0.5s ease-in-out';
    setTimeout(() => nameField.style.animation = '', 500);
  }

  showSuccessNotification(message, duration = 3000) { this.showNotification(message, 'success', duration); }
  showWarningNotification(message, duration = 4000) { this.showNotification(message, 'warning', duration); }
  showInfoNotification(message, duration = 4000) { this.showNotification(message, 'info', duration); }

  // notificações com dedupe / refresh (background rgba(11,12,15,0.9))
  showNotification(message, type = 'info', duration = 3000) {
    if (typeof window.showNotification === 'function') {
      try { window.showNotification(message, type); } catch (e) { console.warn('showNotification falhou:', e); }
      return;
    }

    const key = `${(type||'info')}|${String(message || '').trim()}`;
    const dedupeMs = this.options.notificationDedupeMs || 5000;
    const now = Date.now();

    if (this._activeNotifications.has(key)) {
      const item = this._activeNotifications.get(key);
      try { clearTimeout(item.timeoutId); } catch (e) {}
      item.timeoutId = setTimeout(() => {
        try { if (item.el && item.el.parentElement) item.el.remove(); } catch(e){}
        this._activeNotifications.delete(key);
      }, duration);

      try {
        item.el.classList.remove('matricula-notification--flash');
        void item.el.offsetWidth;
        item.el.classList.add('matricula-notification--flash');
      } catch (e) {}

      this._lastNotifications.set(key, now);
      return;
    }

    const lastTs = this._lastNotifications.get(key) || 0;
    if (now - lastTs < dedupeMs) {
      this.log('Notificação deduplicada (pulada):', key);
      return;
    }

    this.createNotificationSystem();
    const notification = this.createNotificationElement(message, type);
    notification.dataset._notifKey = key;

    const container = document.getElementById('matricula-notifications');
    if (container) container.appendChild(notification);

    const timeoutId = setTimeout(() => {
      try {
        if (notification.parentElement) notification.remove();
      } catch (e) {}
      this._activeNotifications.delete(key);
    }, duration);

    this._activeNotifications.set(key, { el: notification, timeoutId });
    this._lastNotifications.set(key, now);
  }

  createNotificationSystem() {
    if (document.getElementById('matricula-notifications')) return;
    const container = document.createElement('div');
    container.id = 'matricula-notifications';
    container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000; pointer-events: none;';
    document.body.appendChild(container);

    if (!document.getElementById('matricula-notification-styles')) {
      const style = document.createElement('style');
      style.id = 'matricula-notification-styles';
      style.textContent = [
        '.matricula-notification{background: rgba(11,12,15,0.9); color: rgba(255,255,255,0.95); border-radius:8px; padding:12px 16px; margin-bottom:8px; box-shadow:0 4px 12px rgba(0,0,0,0.25); border-left:4px solid; max-width:400px; pointer-events:auto; animation:slideInRight .3s ease, fadeOut .3s ease 2.7s forwards;}',
        '.matricula-notification.success{border-left-color:#10b981;}',
        '.matricula-notification.warning{border-left-color:#f59e0b;}',
        '.matricula-notification.info{border-left-color:#3b82f6;}',
        '.matricula-notification.error{border-left-color:#ef4444;}',
        '.matricula-notification i{margin-right:8px;color:rgba(255,255,255,0.95);}',
        '.matricula-notification--flash{box-shadow:0 6px 18px rgba(0,0,0,0.35); transform: translateY(-3px); transition: all 220ms ease;}',
        '@keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}',
        '@keyframes fadeOut{to{opacity:0;transform:translateX(100%)}}',
        '@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}'
      ].join('\n');
      document.head.appendChild(style);
    }
  }

  createNotificationElement(message, type) {
    const icons = {
      success: '<i class="fas fa-check-circle" aria-hidden="true"></i>',
      warning: '<i class="fas fa-exclamation-triangle" aria-hidden="true"></i>',
      info: '<i class="fas fa-info-circle" aria-hidden="true"></i>',
      error: '<i class="fas fa-times-circle" aria-hidden="true"></i>'
    };
    const div = document.createElement('div');
    div.className = `matricula-notification ${type}`;
    div.innerHTML = `<div style="display:flex;align-items:center;gap:8px;">${icons[type] || icons.info}<span style="flex:1;font-size:14px;line-height:1.4;">${escapeHtml(message)}</span></div>`;
    return div;
  }

  async reloadEfetivoData() {
    this.log('Forçando recarga do efetivo (xlsx)...');
    this.efetivoData = [];
    this._efetivoMap = new Map();
    await this.loadFromXlsx();
    try { this.refreshMatriculaIntegration(); } catch (e) {}
    this.log('Recarregado — registros:', this.efetivoData.length);
  }

  getStats() {
    return {
      totalColaboradores: this.efetivoData.length,
      colaboradoresComMatricula: this.efetivoData.filter(c => c.matricula).length,
      initialized: this.initialized,
      mapSize: this._efetivoMap.size
    };
  }
}

function ensureFontAwesome() {
  const hasFA = !!document.querySelector('link[href*="fontawesome"],link[href*="font-awesome"],link[href*="cdnjs.cloudflare.com/ajax/libs/font-awesome"],script[src*="kit.fontawesome.com"],script[src*="fontawesome"]');
  if (hasFA) return;
  const href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css';
  if (!document.querySelector(`link[href="${href}"]`)) {
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = href;
    link.crossOrigin = 'anonymous';
    document.head.appendChild(link);
    link.onload = () => {};
    link.onerror = () => { console.warn('Falha ao carregar FontAwesome a partir do CDN'); };
  }
}

// estilos adicionais (wrapper, placeholder "Procurando..." e origin icon)
// estilos adicionais (wrapper, placeholder "Procurando..." e origin icon)
if (!document.getElementById('matricula-integration-styles')) {
  const style = document.createElement('style');
  style.id = 'matricula-integration-styles';
  style.textContent = [
    '.form-row{position:relative;}',
    // MODIFICAÇÃO: Usar var(--bg) nos inputs desabilitados
    '.memberName:disabled,.shiftName:disabled{background-color:var(--bg) !important; color:var(--text-color) !important; transition:all .3s ease;}',
    '.memberName:disabled:hover,.shiftName:disabled:hover{background-color:var(--card) !important;}',
    '.input-icon-wrapper{position:relative;display:inline-block;width:100%;}',
    '.input-icon-wrapper input,.input-icon-wrapper textarea,.input-icon-wrapper select{width:100%;box-sizing:border-box;}',
    '.name-disabled-icon{position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:14px;color:#999;pointer-events:none;}',
    '.origin-efetivo{outline:2px solid rgba(16,185,129,0.18);border-radius:4px;padding-right:28px;}',
    '.origin-manual{outline:2px solid rgba(59,130,246,0.12);border-radius:4px;padding-right:28px;}',
    '.matricula-loading-icon{color:#cbd5e1;}'
  ].join('\n');
  document.head.appendChild(style);
}

// inicializador
let matriculaIntegration = null;
function startIntegrationWhenReady(opts = {}) {
  if (matriculaIntegration) return;
  matriculaIntegration = new MatriculaNameIntegration({
  xlsxUrl: window.EFETIVO_XLSX_URL || './efetivo/dados_efetivo/efetivo.xlsx',
  log: !!opts.log,
  minMatLength: typeof opts.minMatLength === 'number' ? opts.minMatLength : 3,
  debounceMs: typeof opts.debounceMs === 'number' ? opts.debounceMs : 600,
  delayedNotFoundMs: typeof opts.delayedNotFoundMs === 'number' ? opts.delayedNotFoundMs : 1500,
  notificationDedupeMs: typeof opts.notificationDedupeMs === 'number' ? opts.notificationDedupeMs : 5000,
  searchingDisplayMs: typeof opts.searchingDisplayMs === 'number' ? opts.searchingDisplayMs : 3000
});
  window.matriculaIntegration = matriculaIntegration;
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => startIntegrationWhenReady());
} else {
  startIntegrationWhenReady();
}

window.reloadMatriculaData = async function() {
  if (!matriculaIntegration) startIntegrationWhenReady();
  await new Promise(r => setTimeout(r, 300));
  if (matriculaIntegration) await matriculaIntegration.reloadEfetivoData();
};

window.cleanupMatriculaIntegration = function() {
  try {
    if (window.matriculaIntegration && typeof window.matriculaIntegration.disconnect === 'function') {
      window.matriculaIntegration.disconnect();
    }
  } catch (e) {}
};

console.log('efetivo-integration (com placeholder "Procurando..." e preservação manual) carregado');

// Controle da sidebar em dispositivos móveis
    document.addEventListener('DOMContentLoaded', function() {
      const toggleMenuBtn = document.getElementById('toggleMenu');
      const sidebar = document.querySelector('.sidebar');
      
      if (toggleMenuBtn && sidebar) {
        toggleMenuBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          sidebar.classList.toggle('active');
          
          // Alterar ícone do hamburger quando o menu estiver aberto
          const icon = toggleMenuBtn.querySelector('i');
          if (sidebar.classList.contains('active')) {
            icon.classList.remove('fa-bars');
            icon.classList.add('fa-times');
          } else {
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
          }
        });
        
        // Fechar o menu ao clicar fora dele
        document.addEventListener('click', function(event) {
          if (!sidebar.contains(event.target) && !toggleMenuBtn.contains(event.target)) {
            sidebar.classList.remove('active');
            const icon = toggleMenuBtn.querySelector('i');
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
          }
        });
        
        // Prevenir que cliques dentro do menu fechem ele
        sidebar.addEventListener('click', function(e) {
          e.stopPropagation();
        });
      }
    });
  </script>
</body>
</html>
