<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Site/Aplicativo para realizar as apropriações">
  <title>Estrutura | Apropriação</title>
  <!-- Firebase -->
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="icon" type="image/png" href="./favicon/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="./favicon/favicon.svg" />
<link rel="shortcut icon" href="./favicon/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="./favicon/apple-touch-icon.png" />
<link rel="manifest" href="./favicon/site.webmanifest" />
<link rel="stylesheet" href="./theme.css">
  <style>

    :root{
      --bg: #f5f7fa;
      --card: #ffffff;
      --text: #2c3e50;
      --accent: #2c3e50;
      --soft: #ccc;
      --text2: black;
      --submit: #27ae60;
      --tabela: #f0f0f0;
      --tabela-text: #333;
      --text-muted: black;
      --accent-hover: #34495e;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }
    body {
      display: flex;
      min-height: 100vh;
      background-color: var(--bg);
    }
    .sidebar {
      width: 220px;
      background: #2c3e50;
      color: #fff;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .dark .sidebar {
  background: var(--card);       /* #090b16 */
  color: var(--text);            /* #e0e0e0 */
  border-right: 1px solid var(--soft); /* #3c3f68 como linha */  
} 

.dark .sidebar a:hover,
.dark .sidebar a.active {
  background: var(--soft);       /* #3c3f68 */
}
    .hamburger {
      display: none;
      background: none;
      border: none;
      color: #fff;
      font-size: 24px;
      position: absolute;
      left: 0;
      cursor: pointer;
    }
    .logo {
      font-size: 24px;
      user-select: none;
    }
    nav ul {
      list-style: none;
      margin-top: 20px;
    }
    nav ul li {
      margin: 15px 0;
    }
    nav ul li a {
      text-decoration: none;
      color: #fff;
      display: flex;
      align-items: center;
      padding: 10px;
      border-radius: 4px;
      transition: background 0.2s;
    }
    nav ul li a i {
      margin-right: 10px;
    }
    nav ul li a.active,
    nav ul li a:hover {
      background: #34495e;
    }
    .main-content {
      flex: 1;
      padding: 30px;
    }
    header h2 {
      margin-bottom: 20px;
      color: var(--accent);
    }
    .dark header h2{
      background: rgba(92,124,250, .1);
      display: inline-block;
      padding: 6px 10px;
  border-radius: 4px;
    }
    .form-section {
      background: var(--card);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }
    .form-section h3 {
      margin-bottom: 15px;
      color: var(--accent);
    }
    .dark .form-section h3{
      background: rgba(83, 155, 245, 0.1);
      display: inline-block;
      padding: 6px 10px;
  border-radius: 4px;
    }
    .form-section h3 i{
      margin-right: 10px;
    }
    .outros{
      color: var(--text);
      margin-top: 25px;
    }
    .outros i{
      margin-right: 10px;
    }
    .form-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
      align-items: center;
    }
    .form-row label {
      flex: 1 1 120px;
      color: var(--text);
    }
    .form-row input,
    .form-row select,
    .form-row textarea {
      flex: 2 1 200px;
      padding: 8px;
      border: 1px solid var(--soft);
      border-radius: 4px;
      font-size: 14px;
      background-color: var(--bg);
      color: var(--text-muted);
    }
    .form-row textarea {
      resize: vertical;
      min-height: 40px;
    }
    /* Radio buttons estilos e alinhamento lado a lado */
    .radio-group {
      display: flex;
      gap: 30px;
      align-items: center;
    }
    .radio-group label {
      position: relative;
      padding-left: 30px;
      cursor: pointer;
      font-size: 16px;
      user-select: none;
      color: var(--text);
    }
    .radio-group input[type="radio"] {
      position: absolute;
      opacity: 0;
      cursor: pointer;
    }
    .radio-group label::before {
      content: "";
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      border: 2px solid var(--accent);
      border-radius: 50%;
      background: var(--card);
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }
    .radio-group input[type="radio"]:checked + label::before {
      border-color: var(--accent);
      background: var(--accent);
    }
    .radio-group label::after {
      content: "";
      position: absolute;
      left: 6px;
      top: 50%;
      transform: translateY(-50%) scale(0);
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--card);
      transition: transform 0.3s ease;
    }
    .radio-group input[type="radio"]:checked + label::after {
      transform: translateY(-50%) scale(1);
    }
    .btn {
      background: var(--accent);
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    .btn:hover {
      background: var(--accent-hover);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }
    .btn i {
  margin-right: 6px;
  font-size: 1em;
}

.btn#submitRecordBtn,
#submitRecordBtn {
      background-color: var(--submit);
      transition: background 0.2s ease;
    }
    #submitRecordBtn:hover {
  background: #1f8e4f; /* tom levemente mais escuro para hover */
}
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: var(--bg);
      color: var(--text2);
    }
    th,
    td {
      padding: 12px;
      border-bottom: 1px solid var(--soft);
      text-align: left;
      font-size: 14px;
    }
    th {
      background: var(--tabela);
      color: var(--tabela-text);
    }
@media (max-width: 768px) {
  body {
    flex-direction: column;
  }
  .sidebar {
    width: 100%;
    padding: 15px;
    flex-direction: column; /* <--- mudou de row para column */
    align-items: center;
    justify-content: flex-start;
  }

  .dark .sidebar {
      border-right: none !important;
      border-bottom: 1px solid var(--soft);
    }

  .sidebar-header {
    width: 100%;
    justify-content: center;
    position: relative;
  }

  .hamburger {
    display: block;
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
  }

  .logo {
    font-size: 20px;
    text-align: center;
    width: 100%;
  }

  nav ul {
    width: 100%;
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transform-origin: top center;
    transform: translateY(-10px);
    transition: max-height 0.4s ease, opacity 0.4s ease, transform 0.4s ease;
    margin-top: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  nav ul.active {
    max-height: 700px;
    opacity: 1;
    transform: translateY(0);
  }

  .main-content {
    padding: 15px;
  }

  section.form-section:last-of-type {
    margin-top: 30px;
    padding: 20px;
  }

  #recordsTable th,
  #recordsTable td {
    padding: 10px;
    font-size: 13px;
  }

  .table-wrapper {
    overflow-x: auto;
    margin-top: 15px;
  }

  .table-wrapper table {
    min-width: 500px;
  }
}


@media (max-width: 600px) {
  .form-row {
    flex-direction: column;
    align-items: stretch;
  }
  .form-row label, 
  .form-row input,
  .form-row select,
  .form-row textarea {
    flex: 1 1 100%;
  }
  .radio-group {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
}

.table-wrapper {
  overflow-x: auto;
  margin-top: 20px;
}
.table-wrapper table {
  width: 100%;
  min-width: 600px; /* garante que enrole antes de “quebrar” */
}

@media (max-width: 480px) {
  header h2 {
    font-size: 1.2rem;
  }
  .btn {
    padding: 8px 12px;
    font-size: 0.9rem;
    margin-bottom: 5px;
  }
  .btn i {
    font-size: 0.95em;
    margin-right: 5px;
  }
}

.memberLocalSelect {
  flex: 1 1 150px;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 14px;
}

.memberCustomLocalInput {
  flex: 2 1 250px;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 14px;
  margin-left: 8px;
  display: none; /* fica oculto até seleção "Outros" */
  transition: opacity 0.3s ease;
}

@media (max-width: 600px) {
  .form-row {
    flex-wrap: wrap;
  }
  .memberLocalSelect,
  .memberCustomLocalInput {
    flex: 1 1 100%;
    margin-left: 0;
    margin-top: 8px;
  }
}

#editTeamBtn {
  background-color: #1E88E5;
}

#notificationMessage {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
  margin-bottom: 20px;
  font-size: 16px;
  color: var(--text);
  text-align: center;
}

#notificationMessage i {
  font-size: 32px;
  color: #2196f3;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background-color: #e0f7fa;
  box-sizing: border-box;
}

.notification-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.4);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.notification-content {
  background: var(--bg);
  padding: 25px 35px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  max-width: 400px;
  width: 90%; /* importante para responsividade */
  text-align: center;
  animation: fadeInUp 0.35s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  border-radius: 12px;
  border: 1px solid #ddd;
  box-sizing: border-box;
}

.notification-content p {
  margin-bottom: 20px;
  color: #222;
  font-size: 16px;
  line-height: 1.5;
  word-wrap: break-word; /* evita estouro de texto */
}

.notification-content button {
  background-color: var(--accent);
  transition: background-color 0.3s ease;
  color: white;
  padding: 8px 20px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  min-width: 80px;
}

.notification-content button:hover {
  background-color: #34495e;
}

.notification-content button:focus {
  outline-offset: 2px;
}

#notificationMessage i[style*="color:#28a745"] {
  background-color: #d4edda;
}

#notificationMessage i[style*="color:#dc3545"] {
  background-color: #f8d7da;
}

#notificationMessage i[style*="color:#ffc107"] {
  background-color: #fff8e1;
}

.dark #notificationMessage i {
  /* fundo neutro para ícones no dark mode */
  background-color: var(--badge-bg);
  color: var(--badge-text); /* se quiseres ícone claro por cima do fundo escuro */
}

/* Mantém os 'tints' por tipo (baseado nas cores inline atuais) — ajusta se preciso */
.dark #notificationMessage i[style*="color:#28a745"] { /* success */
  background-color: rgba(40,167,69,0.12);
}
.dark #notificationMessage i[style*="color:#dc3545"] { /* error */
  background-color: rgba(220,53,69,0.12);
}
.dark #notificationMessage i[style*="color:#ffc107"] { /* warning */
  background-color: rgba(255,193,7,0.08);
}
.dark #notificationMessage i[style*="color:#2196f3"] { /* info */
  background-color: rgba(33,150,243,0.10);
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Responsividade */

@media (max-width: 480px) {
  .notification-content {
    max-width: 95%;
    padding: 20px 20px;
  }

  .notification-content button {
    width: 30%;
    padding: 10px 0;
    font-size: 16px;
    min-width: unset;
  }
}

.absentLabel input[type="checkbox"] {
  appearance: none;
  width: 10px;
  height: 10px;
  border: 2px solid #9ca3af;
  border-radius: 4px;
  background-color: white;
  position: relative;
  transition: all 0.2s ease;
  flex-shrink: 0;
  vertical-align: middle;
}

.absentLabel input[type="checkbox"]::after {
  content: "";
  position: absolute;
  top: 1px;
  left: 5px;
  width: 4px;
  height: 8px;
  border-right: 2px solid white;
  border-bottom: 2px solid white;
  transform: rotate(45deg);
  opacity: 0;
  transition: opacity 0.2s ease;
}

.absentLabel input[type="checkbox"]:checked {
  background-color: var(--accent); /* Cor do checkbox marcado */
  border-color: var(--accent-hover);
}

.absentLabel input[type="checkbox"]:checked::after {
  opacity: 1;
}

/* wrapper padrão: escondido e pronto para exibir em linha (label ao lado do select) */
.form-row .abonar-wrap {
  display: none;           /* escondido por padrão */
  flex-direction: row;     /* desktop: lado a lado */
  align-items: center;
  gap: 8px;
}

/* quando precisar mostrar, ativamos a classe .visible */
.form-row .abonar-wrap.visible {
  display: flex !important; /* !important para garantir sobreposição de inline styles */
}

/* mobile: empilha verticalmente (texto em cima do select) */
@media (max-width: 600px) {
  .form-row .abonar-wrap,
  .form-row .abonar-wrap.visible {
    flex-direction: column;    /* empilha label em cima do select */
    align-items: flex-start;
    gap: 4px;
  }
  .abonar-dsr {
    margin: 0;
    font-size: 13px;
  }
.form-row .abonar-wrap select {
    width: 100% !important;     /* ocupa toda a largura do .form-row */
    min-width: 0;               /* remove min-width que impediria encolher em telas pequenas */
    flex: 1 1 auto;
  }

  /* opcional: uniformizar paddings/margens com os outros inputs */
  .form-row .abonar-wrap select,
  .form-row input,
  .form-row select,
  .form-row textarea {
    box-sizing: border-box;
  }

}

/* estilo do label (texto) */
.abonar-dsr {
  display: block;
  font-size: 13px;
  color: var(--text);
  margin-right: 4px; /* quando em row, cria espaçamento entre label e select */
}

/* Container dos botões ao lado do select */
.manage-actions {
  display: inline-flex;
  gap: 8px;
}

/* Botão Editar (maior) */
.btn-edit-wide {
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 8px 14px;
  height: 40px;          /* altura fixa para alinhar com icon-btn */
  min-width: 160px;      /* largura mínima, ajusta conforme desejar */
  flex: 1 1 auto;        /* ocupa o espaço disponível */
  white-space: nowrap;
  border-radius: 6px;
}

/* Botão compacto só com ícone (Excluir) */
.icon-btn {
  width: 44px;           /* largura fixa */
  height: 40px;          /* mesma altura do .btn-edit-wide */
  border-radius: 6px;
  border: none;
  cursor: pointer;
  background-color: #c0392b;
  color: white;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  transition: transform .12s ease, box-shadow .12s ease, background-color .12s ease;
}

/* ícone centralizado e pequeno */
.icon-btn i { margin: 0; font-size: 16px; line-height: 1; display:inline-block; }

/* hover do ícone */
.icon-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 12px rgba(0,0,0,0.12);
  background-color: #a9322b;
}

.btn-edit-wide:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 12px rgba(0,0,0,0.12);
}

@keyframes slideFadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to   { opacity: 1; transform: translateY(0); }
}
#createTeamArea.show {
  display: block !important;
  animation: slideFadeIn 260ms ease;
}

  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <button id="toggleMenu" class="hamburger">
        <i class="fas fa-bars"></i>
      </button>
      <h1 class="logo">Estrutura</h1>
    </div>
    <nav>
      <ul id="menuList">
  <li>
    <a href="#" class="active">
      <i class="fas fa-file-signature"></i> Apropriações
    </a>
  </li>
  <li>
    <a href="./equipes/equipe.html">
      <i class="fas fa-users-cog"></i> Equipes
    </a>
  </li>
  <li>
    <a href="./apontamentos/apontamentos.html">
      <i class="fas fa-clipboard-list"></i> Apontamentos
    </a>
  </li>
  <li>
    <a href="./diario/diario.html">
      <i class="fas fa-book"></i> Diário de obra
    </a>
  </li>
  <li>
    <a href="./efetivo/efetivo.html">
      <i class="fas fa-user-friends"></i> Efetivo
    </a>
  </li>
  <li>
    <a href="./anotar/anotar.html">
      <i class="fas fa-sticky-note" aria-hidden="true"></i> Anotações
    </a>
  </li>
  <li>
    <a href="#">
      <i class="fas fa-calendar-check"></i> Abono DSR
    </a>
  </li>
  <li>
  <a href="https://detroitbrasil.qforms.com.br/QuestionarioWeb/ResponderQuestionarioLink?chave=ADC929D335B064357179BDBAE1686855"
     target="_blank"
     rel="noopener noreferrer">
    <i class="fa-solid fa-shield-halved"></i> Observa+
  </a>
</li>
  <li>
    <a href="./configurações/configuracao.html">
      <i class="fas fa-cog"></i> Configurações
    </a>
  </li>
</ul>
    </nav>
  </div>
  <div class="main-content">
    <header>
      <h2>Apropriação de Equipes</h2>
    </header>
    <!-- Formulário de Criação/Edição de Equipe -->
    <section class="form-section" id="teamSection">
      <h3><i class="fa-solid fa-users-gear"></i>Gerenciar Equipe</h3>

<!-- Botão Criar Equipe (visível por padrão) -->
<div style="margin-bottom:12px;">
  <button id="createTeamBtn" class="btn">
    <i class="fas fa-plus-circle"></i> Criar Equipe
  </button>
</div>

<!-- Área de criação/edição (oculta por padrão) -->
<div id="createTeamArea" style="display: none; animation: none;">
  <div class="form-row">
    <label for="teamName">Nome da Equipe:</label>
    <input
      type="text"
      id="teamName"
      placeholder="Ex: Semana 1 - Plataforma X"
      autocomplete="off"
    />
  </div>
  <div class="form-row">
    <label>Turno padrão da equipe:</label>
    <div class="radio-group">
      <input type="radio" id="shiftDiurno" name="teamShift" value="Diurno" checked />
      <label for="shiftDiurno">Diurno</label>

      <input type="radio" id="shiftNoturno" name="teamShift" value="Noturno" />
      <label for="shiftNoturno">Noturno</label>
    </div>
  </div>

  <div id="membersContainer">
    <!-- Linhas de membro serão injetadas aqui -->
  </div>

  <button id="addMemberBtn" class="btn"><i class="fa-solid fa-plus"></i>Adicionar Membro</button>
  <button id="saveTeamBtn" class="btn"><i class="fa-solid fa-user-plus"></i>Salvar Equipe</button>

  <div style="margin-top: 5px;">
    <button id="cancelCreateTeamBtn" class="btn" style="background: #c0392b">
      <i class="fa-solid fa-xmark"></i>Cancelar
    </button>
  </div>
</div>

<!-- (a seguir vem o H3 "Editar Equipe" que você já tem) -->
<h3 class="outros"><i class="fa-solid fa-pen-to-square"></i>Editar Equipe</h3>
<div class="form-row">
  <label for="teamSelectManage">Selecione uma equipe para editar:</label>
  <select id="teamSelectManage">
    <option value="">-- Nenhuma selecionada --</option>
    <!-- opções preenchidas pelo loadTeamsManage() -->
  </select>
  <div class="manage-actions">
    <!-- botão Editar: largura maior -->
    <button id="editTeamBtn" class="btn btn-edit-wide" type="button">
      <i class="fas fa-edit" style="margin-right:8px;"></i>
      Editar Equipe
    </button>

    <!-- botão Excluir: apenas ícone, pequeno -->
    <button id="deleteTeamBtn" class="icon-btn" aria-label="Excluir equipe" title="Excluir equipe" type="button">
      <i class="fas fa-trash"></i>
    </button>
  </div>
</div>
    </section>
    <!-- Formulário de Apropriação -->
    <section class="form-section" id="recordSection">
      <h3><i class="fas fa-paper-plane"></i>
Enviar Apropriação</h3>
      <div class="form-row">
        <label for="dateInput">Data:</label>
        <input type="date" id="dateInput" value="" />
      </div>
      <div class="form-row">
  <label for="galpaoSelect">Galpão:</label>
  <select id="galpaoSelect">
    <option value="Galpão 1">Galpão 1</option>
    <option value="Galpão 2">Galpão 2</option>
    <option value="Galpão 3">Galpão 3</option>
    <option value="Galpão 4">Galpão 4</option>
  </select>
</div>
      <div class="form-row">
        <label for="teamSelect">Equipe:</label>
        <select id="teamSelect"></select>
      </div>
      <div
        id="shiftsContainer"
        style="display: flex; flex-direction: column; gap: 10px"
      >
        <!-- Linhas dos membros para apropriação serão criadas aqui -->
      </div>
      <!-- Botão Adicionar Turno REMOVIDO -->
      <button id="submitRecordBtn" class="btn"><i class="fa-solid fa-check"></i>Enviar Apropriação</button>
    </section>
    <!-- Tabela de Registros -->
    <section class="form-section">
      <h3><i class="fas fa-history"></i>Registros Recentes</h3>

      <!-- NOVO: botão para iniciar o carregamento (carrega os 5 primeiros) -->
      <div style="margin-bottom:12px;">
        <button id="loadRecordsBtn" class="btn"><i class="fas fa-download"></i> Carregar Recentes</button>
        <span id="recordsStatus" style="margin-left:12px;color:var(--text);font-size:0.95rem;"></span>
      </div>

      <div class="table-wrapper" id="recordsTableWrapper" style="max-height:360px; overflow:auto;">
        <table id="recordsTable">
          <thead>
            <tr>
              <th>Data</th>
              <th>Galpão</th>
              <th>Equipe</th>
              <th>Usuário</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <div id="notificationModal" class="notification-modal" style="display:none;">
  <div class="notification-content">
    <p id="notificationMessage">
      <i class="fas fa-info-circle"></i>
      <!-- Texto da notificação será inserido aqui -->
    </p>
    <button id="notificationOkBtn">OK</button>
  </div>
</div>

<div id="confirmModal" class="notification-modal" style="display: none;">
  <div class="notification-content">
    <p id="confirmMessage" style="color: #dc3545; font-weight: bold;">
      <!-- Mensagem será inserida dinamicamente -->
    </p>
    <div style="display: flex; justify-content: space-around; margin-top: 20px;">
      <button id="confirmYesBtn" class="btn" style="background: #c0392b;">SIM</button>
      <button id="confirmNoBtn" class="btn">NÃO</button>
    </div>
  </div>
</div>

<a href="./dash.html">teste</a>


  <script type="module">
  // utilitários e imports
  function getCachedUID() { return localStorage.getItem('uid'); }
  function clearCachedUID() { localStorage.removeItem('uid'); }

  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
  import {
    initializeFirestore,
    persistentLocalCache,
    persistentMultipleTabManager,
    collection,
    query,
    where,
    getDocs,
    addDoc,
    doc,
    getDoc,
    setDoc,
    deleteDoc,
    writeBatch,
    orderBy,
    limit,
    startAfter,
    Timestamp
  } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

  function escapeHtml(str = '') {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  // --- criação de linha (para apropriações) ---
  function createShiftRowForRecord({
    name, memberMatricula, block = "", vessel = "", shift = "",
    observations = "", local = "", customLocal = "", details = "",
    absent = false, abono = 'VERIFICAR', absenceReason = ''
  }) {
    const div = document.createElement("div");
    div.className = "form-row";
    div.style.position = "relative";
    const uid = 's' + Math.random().toString(36).slice(2,8);
    const finalLocal = local === "Outros" && customLocal ? customLocal : local;

    if (absent) {
      div.innerHTML = `
        <input type="text" id="shiftName-${uid}" name="shiftName[]" class="shiftName" value="${escapeHtml(name)}" readonly autocomplete="off" />
        <input type="text" id="shiftMatricula-${uid}" name="shiftMatricula[]" class="shiftMatricula" value="${escapeHtml(memberMatricula)}" readonly autocomplete="off" />
        <input type="hidden" id="shiftBlock-${uid}" name="shiftBlock[]" class="shiftBlock" value="" />
        <input type="hidden" id="shiftVessel-${uid}" name="shiftVessel[]" class="shiftVessel" value="" />
        <input type="hidden" id="shiftTurno-${uid}" name="shiftTurno[]" class="shiftTurno" value="FALTA" />
        <input type="hidden" id="shiftLocal-${uid}" name="shiftLocal[]" class="shiftLocal" value="" />
        <input type="hidden" id="shiftDetails-${uid}" name="shiftDetails[]" class="shiftDetails" value="" />
        <textarea id="shiftAbsenceReason-${uid}" name="shiftAbsenceReason[]" class="shiftAbsenceReason" placeholder="Motivo da falta" rows="2" aria-label="Motivo da falta">${escapeHtml(absenceReason)}</textarea>

        <div class="abonar-wrap">
          <label class="abonar-dsr" for="shiftAbono-${uid}">Abonar DSR</label>
          <select id="shiftAbono-${uid}" name="shiftAbono[]" class="shiftAbono">
            <option value="VERIFICAR" ${abono === 'VERIFICAR' ? 'selected' : ''}>VERIFICAR</option>
            <option value="SIM" ${abono === 'SIM' ? 'selected' : ''}>SIM</option>
            <option value="NAO" ${abono === 'NAO' ? 'selected' : ''}>NÃO</option>
          </select>
        </div>
      `;
      const abWrap = div.querySelector('.abonar-wrap');
      if (abWrap) abWrap.classList.add('visible');
    } else {
      div.innerHTML = `
        <input type="text" id="shiftName-${uid}" name="shiftName[]" class="shiftName" value="${escapeHtml(name)}" readonly autocomplete="off" />
        <input type="text" id="shiftMatricula-${uid}" name="shiftMatricula[]" class="shiftMatricula" value="${escapeHtml(memberMatricula)}" readonly autocomplete="off" />
        <input type="text" id="shiftBlock-${uid}" name="shiftBlock[]" class="shiftBlock" value="${escapeHtml(block)}" placeholder="Bloco" autocomplete="off" />
        <input type="text" id="shiftVessel-${uid}" name="shiftVessel[]" class="shiftVessel" value="${escapeHtml(vessel)}" placeholder="Embarcação" autocomplete="off" />
        <select id="shiftTurno-${uid}" name="shiftTurno[]" class="shiftTurno">
          <option value="">Selecione Turno</option>
          <option value="Diurno" ${shift === "Diurno" ? "selected" : ""}>Diurno</option>
          <option value="Noturno" ${shift === "Noturno" ? "selected" : ""}>Noturno</option>
        </select>
        <input type="text" id="shiftLocal-${uid}" name="shiftLocal[]" class="shiftLocal" value="${escapeHtml(finalLocal)}" readonly autocomplete="off" />
        <input type="hidden" id="shiftDetails-${uid}" name="shiftDetails[]" class="shiftDetails" value="${escapeHtml(details)}" />
        <input type="text" id="shiftObservations-${uid}" name="shiftObservations[]" class="shiftObservations" placeholder="Observações" value="${escapeHtml(observations)}" autocomplete="off" />
      `;
    }
    return div;
  }

  // --- firebase setup ---
  const firebaseConfig = {
    apiKey: "AIzaSyDtnzixicBYAQkuoeB5tgCGpDLt1lByMZo",
    authDomain: "apropriacao-estrutura.firebaseapp.com",
    projectId: "apropriacao-estrutura",
    storageBucket: "apropriacao-estrutura.appspot.com",
    messagingSenderId: "155266586257",
    appId: "1:155266586257:web:6d70edc967cdbfc56e5130",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = initializeFirestore(app, {
    localCache: persistentLocalCache({ tabManager: persistentMultipleTabManager() })
  });

  let currentUser = null;
  let editingTeamId = null;

  // --- cache keys / TTLs ---
  const TEAMS_CACHE_KEY = 'teams_cache_v1';
  const TEAMS_CACHE_TTL_MS = 1000 * 60 * 60 * 24; // 24h
  const META_CHECK_TTL_MS = 5 * 60 * 1000; // 5 minutos (ajuste aqui se quiser)
  const META_LAST_CHECK_KEY = 'teams_meta_last_check_ts';

  const teamsCache = new Map();

  function normalizeTeam(raw = {}) {
    return {
      name: raw.name || '',
      shift: raw.shift || '',
      ownerUid: raw.ownerUid || '',
      members: (raw.members || []).map(m => ({
        name: m.name || '',
        matricula: m.matricula || '',
        block: m.block || '',
        vessel: m.vessel || '',
        local: m.local || '',
        customLocal: m.customLocal || '',
        details: m.details || '',
        absent: !!m.absent,
        abono: m.abono || 'VERIFICAR',
        absenceReason: m.absenceReason || ''
      }))
    };
  }

  // serialize / persist teams cache
  function serializeTeamsCache() {
    const entries = [];
    teamsCache.forEach((value, key) => {
      const safeValue = {
        name: value.name || '',
        shift: value.shift || '',
        ownerUid: value.ownerUid || '',
        members: (value.members || []).map(m => ({
          name: m.name || '',
          matricula: m.matricula || '',
          block: m.block || '',
          vessel: m.vessel || '',
          local: m.local || '',
          customLocal: m.customLocal || '',
          details: m.details || '',
          absent: !!m.absent,
          abono: m.abono || 'VERIFICAR',
          absenceReason: m.absenceReason || ''
        }))
      };
      entries.push([key, safeValue]);
    });
    const payload = { ts: Date.now(), entries };
    try {
      localStorage.setItem(TEAMS_CACHE_KEY, JSON.stringify(payload));
    } catch (err) {
      console.warn('Falha ao gravar teams cache no localStorage', err);
    }
  }

  function loadTeamsCacheFromLocalStorage() {
    try {
      const raw = localStorage.getItem(TEAMS_CACHE_KEY);
      if (!raw) return false;
      const payload = JSON.parse(raw);
      if (!payload || !payload.ts || !payload.entries) return false;
      if (Date.now() - payload.ts > TEAMS_CACHE_TTL_MS) {
        localStorage.removeItem(TEAMS_CACHE_KEY);
        return false;
      }
      teamsCache.clear();
      for (const [id, data] of payload.entries) teamsCache.set(id, data);
      return true;
    } catch (e) {
      console.warn('Erro ao ler teamsCache do localStorage', e);
      return false;
    }
  }

  function clearTeamsCacheLocalStorage() {
    try { localStorage.removeItem(TEAMS_CACHE_KEY); } catch (e) { console.warn('Erro ao limpar teams cache', e); }
  }

  // rebuild selects from cache
  function rebuildTeamSelectsFromCache() {
    const teamSelect = document.getElementById("teamSelect");
    const teamSelectManage = document.getElementById("teamSelectManage");
    if (!teamSelect || !teamSelectManage) return;

    teamSelect.innerHTML = '';
    teamSelectManage.innerHTML = '';

    const defaultOpt = document.createElement('option');
    defaultOpt.value = '';
    defaultOpt.textContent = 'Selecione uma equipe';
    teamSelect.appendChild(defaultOpt);

    const defaultOpt2 = document.createElement('option');
    defaultOpt2.value = '';
    defaultOpt2.textContent = '-- Nenhuma selecionada --';
    teamSelectManage.appendChild(defaultOpt2);

    const frag1 = document.createDocumentFragment();
    const frag2 = document.createDocumentFragment();

    teamsCache.forEach((data, id) => {
      const opt = document.createElement('option');
      opt.value = id;
      opt.textContent = data.name || id;
      frag1.appendChild(opt);

      const opt2 = opt.cloneNode(true);
      frag2.appendChild(opt2);
    });

    teamSelect.appendChild(frag1);
    teamSelectManage.appendChild(frag2);
  }

  // reads teams from Firestore once and populates cache
  async function loadTeamsOnce() {
    // try localStorage first
    const loadedFromLocal = loadTeamsCacheFromLocalStorage();
    if (loadedFromLocal) {
      rebuildTeamSelectsFromCache();
      return;
    }

    // otherwise fetch from server
    try {
      const q = query(collection(db, "teams"),
        where("ownerUid", "==", currentUser.uid),
        where("deleted", "==", false));
      const snap = await getDocs(q);

      teamsCache.clear();
      snap.forEach(docSnap => {
        const d = docSnap.data() || {};
        teamsCache.set(docSnap.id, normalizeTeam(d));
      });

      serializeTeamsCache();
      rebuildTeamSelectsFromCache();
    } catch (e) {
      console.error('Erro ao carregar teams do Firestore', e);
      throw e;
    }
  }

  // --- META check with TTL: decide whether to refresh teams from server ---
  async function shouldRefreshTeamsFromServer() {
    try {
      // check last local check
      const lastCheckRaw = localStorage.getItem(META_LAST_CHECK_KEY);
      const lastCheck = lastCheckRaw ? parseInt(lastCheckRaw, 10) : 0;
      const now = Date.now();

      if (lastCheck && (now - lastCheck) < META_CHECK_TTL_MS) {
        // checado recentemente -> não ler o Firestore
        return false;
      }

      // mark immediately to avoid concurrent triggers
      localStorage.setItem(META_LAST_CHECK_KEY, String(now));

      // read meta doc
      const metaRef = doc(db, "meta", "teams");
      const metaSnap = await getDoc(metaRef);

      if (!metaSnap.exists()) return true; // sem meta -> recarregar

      const serverTs = metaSnap.data().updatedAt?.toMillis?.() ?? 0;
      const raw = localStorage.getItem(TEAMS_CACHE_KEY);
      if (!raw) return true;
      const payload = JSON.parse(raw);
      const localTs = payload.ts || 0;

      return serverTs > localTs;
    } catch (e) {
      // **AQUI**: não silenciamos permission-denied.
      // Se for permission-denied, relançamos para que apareça no console e você saiba.
      if (e?.code === 'permission-denied' || (e?.message && e.message.toLowerCase().includes('permission'))) {
        throw e; // relança — assim você verá erro no console
      }
      // para outros erros transientes, apenas logamos e não forçamos refresh
      console.warn('Erro checando meta teams (silenciado):', e);
      return false;
    }
  }

  // SWR-style loader: decide if fetch from server is needed, otherwise use cache
  let loadTeamsInProgress = false;
  async function loadTeamsWithSWR(force = false) {
    if (loadTeamsInProgress) return;
    loadTeamsInProgress = true;
    try {
      if (force) {
        // force server fetch
        await loadTeamsOnce();
        return;
      }

      // Only fetch server if meta indicates newer or no local cache
      const localLoaded = loadTeamsCacheFromLocalStorage();
      if (!localLoaded) {
        await loadTeamsOnce();
        return;
      }

      const shouldRefresh = await shouldRefreshTeamsFromServer();
      if (shouldRefresh) {
        await loadTeamsOnce();
      } else {
        // local cache is fresh enough -> rebuild UI from cache
        rebuildTeamSelectsFromCache();
      }
    } catch (e) {
      console.warn('loadTeamsWithSWR warning:', e);
      // keep UI using cached items if any
      rebuildTeamSelectsFromCache();
      // note: permission errors from shouldRefreshTeamsFromServer will bubble up here and be visible in console
    } finally {
      loadTeamsInProgress = false;
    }
  }

  // --- DOMContentLoaded auth init ---
  window.addEventListener('DOMContentLoaded', () => {
    const cachedUid = getCachedUID();
    if (!cachedUid) {
      clearCachedUID();
      window.location.href = './index.html';
      return;
    }

    onAuthStateChanged(auth, async (user) => {
      if (user && user.uid === cachedUid) {
        currentUser = user;
        setDateToday();
        try {
          // use SWR to decide fetching (will use cache/local first)
          await loadTeamsWithSWR();
          // Registro: loadRecords is loaded by user clicking the load button (no auto)
        } catch (e) {
          console.error('Erro iniciais:', e);
          showNotification('Erro ao carregar dados iniciais.', 'error');
        }
      } else {
        clearCachedUID();
        window.location.href = './index.html';
      }
    });
  });

  function setDateToday() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const el = document.getElementById("dateInput");
    if (el) el.value = `${yyyy}-${mm}-${dd}`;
  }

  // --- team select change -> render shifts ---
  const teamSelectEl = document.getElementById("teamSelect");
  if (teamSelectEl) {
    teamSelectEl.addEventListener("change", function () {
      const teamId = this.value;
      const shiftsContainer = document.getElementById("shiftsContainer");
      if (!shiftsContainer) return;
      shiftsContainer.innerHTML = "";
      if (!teamId) return;

      const teamData = teamsCache.get(teamId);
      if (!teamData || !teamData.members || teamData.members.length === 0) return;

      const turnoPadrao = teamData.shift || "";
      const frag = document.createDocumentFragment();
      for (const member of teamData.members) {
        const row = createShiftRowForRecord({
          name: member.name,
          memberMatricula: member.matricula,
          block: member.block || "",
          vessel: member.vessel || "",
          shift: turnoPadrao,
          observations: "",
          local: member.local || "",
          customLocal: member.customLocal || "",
          details: member.details || "",
          absent: !!member.absent,
          abono: member.abono || 'VERIFICAR',
          absenceReason: member.absenceReason || ''
        });
        frag.appendChild(row);
      }
      shiftsContainer.appendChild(frag);
    });
  }

  // --- createMemberRow (team management UI) ---
  function createMemberRow(member = { name: "", matricula: "", block: "", vessel: "", local: "", customLocal: "", details: "", absent: false, abono: 'VERIFICAR', absenceReason: '' }) {
    const div = document.createElement("div");
    div.className = "form-row";
    div.style.position = "relative";
    const uid = 'm' + Math.random().toString(36).slice(2,8);

    div.innerHTML = `
      <input type="text" id="memberName-${uid}" name="memberName[]" class="memberName" placeholder="Nome" value="${escapeHtml(member.name)}" autocomplete="off" />
      <input type="text" id="memberMatricula-${uid}" name="memberMatricula[]" class="memberMatricula" placeholder="Matrícula" value="${escapeHtml(member.matricula)}" autocomplete="off" />

      <input type="text" id="memberBlock-${uid}" name="memberBlock[]" class="memberBlock" placeholder="Bloco" value="${escapeHtml(member.block)}" autocomplete="off" />
      <input type="text" id="memberVessel-${uid}" name="memberVessel[]" class="memberVessel" placeholder="Embarcação" value="${escapeHtml(member.vessel)}" autocomplete="off" />
      <select id="memberLocalSelect-${uid}" name="memberLocal[]" class="memberLocalSelect">
        <option value="">Selecione Local</option>
        <option value="Montagem" ${member.local === "Montagem" ? "selected" : ""}>Montagem</option>
        <option value="Sub Montagem" ${member.local === "Sub Montagem" ? "selected" : ""}>Sub Montagem</option>
        <option value="Edificação" ${member.local === "Edificação" ? "selected" : ""}>Edificação</option>
        <option value="Outros" ${member.local === "Outros" ? "selected" : ""}>Outros</option>
      </select>
      <input type="text" id="memberCustomLocalInput-${uid}" name="memberCustomLocal[]" class="memberCustomLocalInput" placeholder="Informe outro local" value="${escapeHtml(member.customLocal || '')}" style="display: none; margin-left: 5px; flex: 1;" autocomplete="off" />
      <input type="text" id="memberDetailsInput-${uid}" name="memberDetails[]" class="memberDetailsInput" placeholder="Detalhes (Perfilado, Barras, Anteparas)" value="${escapeHtml(member.details || '')}" autocomplete="off" />

      <input type="text" id="memberAbsenceReasonInput-${uid}" name="memberAbsenceReason[]" class="memberAbsenceReasonInput" placeholder="Motivo da falta / Observações" value="${escapeHtml(member.absenceReason || '')}" style="display:none; flex: 1;" autocomplete="off" />
      <div class="abonar-wrap">
        <label class="abonar-dsr" for="memberAbono-${uid}">Abonar DSR</label>
        <select id="memberAbono-${uid}" name="memberAbono[]" class="memberAbonoSelect">
          <option value="VERIFICAR" ${member.abono === 'VERIFICAR' ? 'selected' : ''}>VERIFICAR</option>
          <option value="SIM" ${member.abono === 'SIM' ? 'selected' : ''}>SIM</option>
          <option value="NAO" ${member.abono === 'NAO' ? 'selected' : ''}>NÃO</option>
        </select>
      </div>

      <label class="absentLabel" style="margin-left:8px;">
        <input type="checkbox" id="memberAbsentCheckbox-${uid}" name="memberAbsent[]" class="memberAbsentCheckbox" ${member.absent ? 'checked' : ''}/> Falta
      </label>

      <button class="btn removeMemberBtn" type="button"><i class="fas fa-trash" style="margin-left: 5px;"></i></button>
    `;

    const localSelect = div.querySelector(".memberLocalSelect");
    const customLocalInput = div.querySelector(".memberCustomLocalInput");
    const absentCheckbox = div.querySelector(".memberAbsentCheckbox");
    const absenceReasonInput = div.querySelector(".memberAbsenceReasonInput");
    const abonoSelect = div.querySelector(".memberAbonoSelect");
    const detailsInput = div.querySelector(".memberDetailsInput");
    const abonoWrap = div.querySelector(".abonar-wrap");

    function toggleCustomLocal() {
      if (localSelect.value === "Outros") {
        customLocalInput.style.display = "block";
      } else {
        customLocalInput.style.display = "none";
        customLocalInput.value = "";
      }
    }

    function toggleAbsentMode() {
      const isAbsent = absentCheckbox.checked;
      const toToggle = [div.querySelector(".memberBlock"), div.querySelector(".memberVessel"), localSelect, customLocalInput, detailsInput];
      if (isAbsent) {
        toToggle.forEach(el => { if (el) el.style.display = "none"; });
        absenceReasonInput.style.display = "block";
        if (abonoWrap) abonoWrap.classList.add("visible");
        if (member.abono && abonoSelect) abonoSelect.value = member.abono;
        setTimeout(() => { absenceReasonInput.focus(); }, 50);
      } else {
        toToggle.forEach(el => { if (el) el.style.display = ""; });
        absenceReasonInput.style.display = "none";
        if (abonoWrap) abonoWrap.classList.remove("visible");
        if (abonoSelect) abonoSelect.value = "VERIFICAR";
      }
    }

    localSelect.addEventListener("change", toggleCustomLocal);
    absentCheckbox.addEventListener("change", toggleAbsentMode);

    // init
    toggleCustomLocal();
    if (member.absent) toggleAbsentMode();

    div.querySelector(".removeMemberBtn").onclick = () => div.remove();
    return div;
  }

  const membersContainer = document.getElementById("membersContainer");
  const addMemberBtn = document.getElementById("addMemberBtn");
  const cancelEditBtn = document.getElementById("cancelEditBtn");

  if (addMemberBtn && membersContainer) {
    addMemberBtn.addEventListener("click", () => membersContainer.appendChild(createMemberRow()));
  }

  const saveTeamBtn = document.getElementById("saveTeamBtn");
  if (saveTeamBtn) saveTeamBtn.addEventListener("click", saveTeam);

  async function saveTeam() {
    const name = document.getElementById("teamName").value.trim();
    if (!name) { showNotification("Por favor, informe o nome da equipe para continuar.", "info"); return; }

    const shiftRadio = document.querySelector('input[name="teamShift"]:checked');
    const shift = shiftRadio ? shiftRadio.value : "Diurno";

    const members = [];
    const memberRows = membersContainer.querySelectorAll(".form-row");
    for (const row of memberRows) {
      const nameInput = row.querySelector(".memberName");
      const matriculaInput = row.querySelector(".memberMatricula");
      const blockInput = row.querySelector(".memberBlock");
      const vesselInput = row.querySelector(".memberVessel");
      if (!nameInput.value.trim() || !matriculaInput.value.trim()) {
        showNotification("Todos os membros devem ter nome e matrícula preenchidos.", "warning");
        return;
      }

      const detailsInput = row.querySelector(".memberDetailsInput");
      const isAbsent = !!row.querySelector(".memberAbsentCheckbox")?.checked;

      if (!isAbsent && !detailsInput.value.trim()) {
        showNotification("O campo Detalhes é obrigatório para membros presentes.", "warning");
        return;
      }

      members.push({
        name: nameInput.value.trim(),
        matricula: matriculaInput.value.trim(),
        block: blockInput.value.trim(),
        vessel: vesselInput.value.trim(),
        local: row.querySelector(".memberLocalSelect").value,
        customLocal: row.querySelector(".memberCustomLocalInput").value.trim(),
        details: detailsInput.value.trim(),
        absent: isAbsent,
        abono: (row.querySelector(".memberAbonoSelect")?.value) || 'VERIFICAR',
        absenceReason: (row.querySelector(".memberAbsenceReasonInput")?.value || '').trim()
      });
    }
    if (members.length === 0) { showNotification("Adicione pelo menos um membro na equipe.", "warning"); return; }

    const teamData = { name, shift, members, ownerUid: currentUser.uid, deleted: false };

    try {
      if (editingTeamId) {
        await setDoc(doc(db, "teams", editingTeamId), teamData);
        teamsCache.set(editingTeamId, normalizeTeam(teamData));
      } else {
        const ref = await addDoc(collection(db, "teams"), teamData);
        teamsCache.set(ref.id, normalizeTeam(teamData));
      }

      // persist cache and update UI
      serializeTeamsCache();
      rebuildTeamSelectsFromCache();

      // avoid immediate meta recheck (we just updated)
      localStorage.setItem(META_LAST_CHECK_KEY, String(Date.now()));

      editingTeamId = null;
      if (document.getElementById("cancelEditBtn")) document.getElementById("cancelEditBtn").style.display = "none";
      if (saveTeamBtn) saveTeamBtn.textContent = "Salvar Equipe";

      showNotification("Equipe salva com sucesso!", "success");
      clearTeamForm();
      showCreateArea(null);
    } catch (e) {
      console.error(e);
      showNotification("Erro ao salvar equipe.", "error");
    }
  }

  function clearTeamForm() {
    const teamNameEl = document.getElementById("teamName");
    if (teamNameEl) teamNameEl.value = "";
    const radioDiurno = document.querySelector('input[name="teamShift"][value="Diurno"]');
    if (radioDiurno) radioDiurno.checked = true;
    if (membersContainer) membersContainer.innerHTML = "";
  }

  if (cancelEditBtn) {
    cancelEditBtn.addEventListener("click", () => {
      clearTeamForm();
      editingTeamId = null;
      cancelEditBtn.style.display = "none";
      if (saveTeamBtn) saveTeamBtn.textContent = "Salvar Equipe";
    });
  }

  // --- enviar apropriação (records) ---
  const submitRecordBtn = document.getElementById("submitRecordBtn");
  if (submitRecordBtn) submitRecordBtn.addEventListener("click", sendRecord);

  async function sendRecord() {
    const teamSelect = document.getElementById("teamSelect");
    const teamId = teamSelect?.value;
    const teamName = teamSelect?.options[teamSelect.selectedIndex]?.text || '';

    const dateStr = document.getElementById("dateInput")?.value;
    const galpao = document.getElementById("galpaoSelect")?.value;
    if (!dateStr || !galpao || !teamId) { showNotification("Preencha todos os campos para enviar a apropriação.", "warning"); return; }

    // use cache first
    let teamData = teamsCache.get(teamId);
    if (!teamData) {
      try {
        await loadTeamsWithSWR(true); // force reload
        teamData = teamsCache.get(teamId);
        if (!teamData) { showNotification("Equipe selecionada não encontrada.", "warning"); return; }
      } catch (e) {
        console.error("Erro ao recarregar equipes:", e);
        showNotification("Erro ao acessar os dados da equipe.", "error");
        return;
      }
    }

    const shiftsContainer = document.getElementById("shiftsContainer");
    const shiftRows = shiftsContainer?.querySelectorAll(".form-row") || [];
    if (shiftRows.length === 0) { showNotification("Selecione uma equipe com membros para apropriar.", "warning"); return; }

    const records = [];
    for (const row of shiftRows) {
      const name = row.querySelector(".shiftName").value.trim();
      const memberMatricula = row.querySelector(".shiftMatricula").value.trim();

      const memberOriginal = teamData.members.find(m => m.name === name && m.matricula === memberMatricula);

      const hasAbonoSelect = !!row.querySelector(".shiftAbono");
      const turnoValue = row.querySelector(".shiftTurno")?.value || "";
      const isAbsent = hasAbonoSelect || turnoValue === 'FALTA';

      const absenceReason = row.querySelector(".shiftAbsenceReason")?.value?.trim() || "";
      const abono = row.querySelector(".shiftAbono")?.value || 'VERIFICAR';

      let vesselShift = "", blockShift = "", details = "", local = "";

      if (!isAbsent) {
        vesselShift = row.querySelector(".shiftVessel")?.value?.trim() || "";
        blockShift = row.querySelector(".shiftBlock")?.value?.trim() || "";
        details = row.querySelector(".shiftDetails")?.value?.trim() || "";

        const localInput = row.querySelector(".shiftLocal");
        if (localInput && localInput.value != null) {
          local = localInput.value.trim() || "";
        } else {
          local = (memberOriginal?.local === "Outros") ? (memberOriginal?.customLocal || "") : (memberOriginal?.local || "");
        }
      } else {
        vesselShift = "";
        blockShift = "";
        details = "";
        local = "";
      }

      if (!isAbsent && !(row.querySelector(".shiftTurno")?.value)) {
        showNotification(`Preencha o turno do membro: ${name}`);
        return;
      }

      records.push({
        date: Timestamp.fromDate(new Date(document.getElementById('dateInput').value)),
        galpao,
        teamId,
        teamName,
        userId: currentUser.uid,
        userName: currentUser.displayName || currentUser.email,
        name,
        memberMatricula,
        vesselShift,
        blockShift,
        shift: isAbsent ? 'FALTA' : (row.querySelector(".shiftTurno")?.value || ""),
        observations: row.querySelector(".shiftObservations")?.value?.trim() || "",
        local,
        details,
        absent: isAbsent,
        absenceReason,
        abono,
        createdBy: currentUser.uid,
      });
    }

    try {
      const BATCH_LIMIT = 400;
      let batch = writeBatch(db);
      let ops = 0;

      for (const rec of records) {
        const dateInputVal = document.getElementById('dateInput').value;
        let dateStrForId;
        if (dateInputVal) {
          const [yyyy, mm, dd] = dateInputVal.split('-');
          dateStrForId = `${dd}-${mm}-${yyyy}`;
        } else {
          const now = new Date();
          dateStrForId = `${String(now.getDate()).padStart(2, '0')}-${String(now.getMonth() + 1).padStart(2, '0')}-${now.getFullYear()}`;
        }
        const safeName = rec.name.replace(/[/\\#.%$[\]]/g, "-");
        const docId = `${safeName}, ${rec.memberMatricula} - ${dateStrForId}`;

        batch.set(doc(db, "records", docId), rec);
        ops++;
        if (ops >= BATCH_LIMIT) {
          await batch.commit();
          batch = writeBatch(db);
          ops = 0;
        }
      }

      if (ops > 0) await batch.commit();

      showNotification("Apropriações enviadas com sucesso!", "success");
      const galpaoSel = document.getElementById("galpaoSelect");
      if (galpaoSel) galpaoSel.selectedIndex = 0;
      const teamSel = document.getElementById("teamSelect");
      if (teamSel) teamSel.selectedIndex = 0;
      const sc = document.getElementById("shiftsContainer");
      if (sc) sc.innerHTML = "";

      // opcional: atualiza local meta-check para que o sistema não tente ler meta imediatamente
      localStorage.setItem(META_LAST_CHECK_KEY, String(Date.now()));

      // recarrega (se quiser) registros
      if (typeof loadRecords === 'function') loadRecords(true);
    } catch (e) {
      console.error(e);
      showNotification("Erro ao enviar apropriações.", "error");
    }
  }

  // --- Records (Lazy load + infinite scroll) ---
  let lastVisibleRecord = null;
  let isFetchingRecords = false;
  let recordsCache = [];
  let recordsInitialized = false;
  let noMoreRecords = false;
  const LOAD_BATCH_SIZE = 5;

  function appendRecordsToTable(newDocs) {
    const tbody = document.querySelector("#recordsTable tbody");
    if (!tbody) return;
    const fragment = document.createDocumentFragment();
    for (const r of newDocs) {
      const date = r.date?.toDate?.() || new Date();
      const dateStr = date.toLocaleString("pt-BR", {
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
      const galp = (r.galpao || "").replace(/</g, '&lt;').replace(/>/g, '&gt;');
      const team = (r.teamName || r.teamId || "").replace(/</g, '&lt;').replace(/>/g, '&gt;');
      const user = (r.userName || "").replace(/</g, '&lt;').replace(/>/g, '&gt;');
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${dateStr}</td><td>${galp}</td><td>${team}</td><td>${user}</td>`;
      fragment.appendChild(tr);
    }
    tbody.appendChild(fragment);
  }

  function clearRecordsTable() {
    const tbody = document.querySelector("#recordsTable tbody");
    if (tbody) tbody.innerHTML = '';
    recordsCache = [];
    lastVisibleRecord = null;
    noMoreRecords = false;
  }

  async function loadRecords(reset = false) {
    if (isFetchingRecords) return;
    if (noMoreRecords && !reset) return;
    isFetchingRecords = true;

    const loadBtn = document.getElementById('loadRecordsBtn');
    const statusSpan = document.getElementById('recordsStatus');
    if (loadBtn) { loadBtn.disabled = true; loadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Carregando...'; }
    if (statusSpan) statusSpan.textContent = '';

    try {
      if (reset) { clearRecordsTable(); recordsInitialized = true; }

      let q = query(collection(db, "records"),
        where("createdBy", "==", currentUser.uid),
        orderBy("date", "desc"),
        limit(LOAD_BATCH_SIZE));

      if (!reset && lastVisibleRecord) {
        q = query(q, startAfter(lastVisibleRecord));
      }

      const snap = await getDocs(q);

      if (!snap.empty) {
        lastVisibleRecord = snap.docs[snap.docs.length - 1];
        const newDocs = [];
        snap.forEach(docSnap => newDocs.push(docSnap.data()));
        appendRecordsToTable(newDocs);
        recordsCache = recordsCache.concat(newDocs);

        if (snap.size < LOAD_BATCH_SIZE) {
          noMoreRecords = true;
          if (statusSpan) statusSpan.textContent = 'Todos os registros foram carregados.';
        }
      } else {
        noMoreRecords = true;
        if (reset && statusSpan) statusSpan.textContent = 'Nenhum registro encontrado.';
      }
    } catch (e) {
      console.error('Erro ao carregar records', e);
      showNotification('Erro ao carregar registros recentes.', 'error');
    } finally {
      isFetchingRecords = false;
      if (loadBtn) {
        loadBtn.disabled = noMoreRecords;
        if (!noMoreRecords) loadBtn.style.display = 'none';
        else loadBtn.innerHTML = '<i class="fas fa-check"></i> Carregado';
      }
    }
  }

  // scroll listener with fallback
  const tableWrapper = document.getElementById("recordsTableWrapper") || document.querySelector("#recordsTable")?.parentElement;
  if (tableWrapper) {
    let scrollTimeout;
    tableWrapper.addEventListener("scroll", () => {
      if (!recordsInitialized || noMoreRecords) return;
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => {
        if (tableWrapper.scrollTop + tableWrapper.clientHeight >= tableWrapper.scrollHeight - 50) {
          loadRecords(false);
        }
      }, 120);
    });
  }

  const loadRecordsBtn = document.getElementById('loadRecordsBtn');
  if (loadRecordsBtn) {
    loadRecordsBtn.addEventListener('click', async () => {
      if (recordsInitialized) return;
      await loadRecords(true);
    });
  }

  // --- small UI utilities (menu, notifications) ---
  const toggleMenuBtn = document.getElementById("toggleMenu");
  const menuList = document.getElementById("menuList");
  if (toggleMenuBtn) toggleMenuBtn.addEventListener("click", () => menuList.classList.toggle("active"));

  const icons = {
    success: '<i class="fas fa-check-circle" style="color:#28a745;"></i>',
    error: '<i class="fas fa-times-circle" style="color:#dc3545;"></i>',
    warning: '<i class="fas fa-exclamation-triangle" style="color:#ffc107;"></i>',
    info: '<i class="fas fa-info-circle" style="color:#2196f3;"></i>',
  };

  function showNotification(message, type = "info") {
    const modal = document.getElementById("notificationModal");
    const msg = document.getElementById("notificationMessage");
    const okBtn = document.getElementById("notificationOkBtn");
    if (!modal || !msg || !okBtn) { alert(message); return; }

    msg.innerHTML = icons[type] + '<span>' + message + '</span>';
    modal.style.display = "flex";
    okBtn.focus();
    okBtn.onclick = () => { modal.style.display = "none"; };
  }

  const modal = document.getElementById("notificationModal");
  if (modal) modal.addEventListener("click", (e) => { if (e.target === modal) modal.style.display = "none"; });
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") { const mod = document.getElementById("notificationModal"); if (mod && mod.style.display === "flex") mod.style.display = "none"; } });

  // --- manage team (edit/delete) ---
  const teamSelectManage = document.getElementById("teamSelectManage");
  const editTeamBtn = document.getElementById("editTeamBtn");
  if (editTeamBtn) {
  editTeamBtn.addEventListener("click", async () => {
    const teamId = teamSelectManage.value;
    if (!teamId) { showNotification("Selecione uma equipe para editar.", "warning"); return; }

    let teamData = teamsCache.get(teamId);
    if (!teamData) {
      try {
        // força recarregar cache do servidor se não tiver local
        await loadTeamsWithSWR(true);
        teamData = teamsCache.get(teamId);
        if (!teamData) { showNotification("Equipe selecionada não encontrada.", "warning"); return; }
      } catch (e) {
        console.error("Erro ao recarregar equipes:", e);
        showNotification("Erro ao acessar os dados da equipe.", "error");
        return;
      }
    }

    // popula o form com os dados da equipe selecionada
    const teamNameEl = document.getElementById("teamName");
    if (teamNameEl) teamNameEl.value = teamData.name || "";

    const radio = document.querySelector(`input[name="teamShift"][value="${teamData.shift}"]`);
    if (radio) radio.checked = true;

    // limpa e recria linhas de membros
    membersContainer.innerHTML = "";
    (teamData.members || []).forEach(m => membersContainer.appendChild(createMemberRow(m)));

    // marca que estamos em modo edição
    editingTeamId = teamId;

    // ajusta texto do botão salvar para "Atualizar"
    if (saveTeamBtn) saveTeamBtn.innerHTML = '<i class="fas fa-rotate"></i> Atualizar Equipe';
    // mostra área em modo edição
showCreateArea('edit');

    // mostra a mesma área de criação/edição (sem criar outra)
    const createArea = document.getElementById('createTeamArea');
    const createBtn = document.getElementById('createTeamBtn');
    if (createArea) {
      createArea.classList.add('show');
      createArea.style.display = 'block';
    }
    if (createBtn) createBtn.style.display = 'none';

    // mostra o botão de cancelar (o que criamos para criação)
    const cancelCreateBtn = document.getElementById('cancelCreateTeamBtn');
    if (cancelCreateBtn) cancelCreateBtn.style.display = 'inline-block';

    // focus no nome para facilitar edição
    setTimeout(() => { if (teamNameEl) teamNameEl.focus(); }, 40);
  });
}

  const deleteTeamBtn = document.getElementById("deleteTeamBtn");
  const confirmModal = document.getElementById("confirmModal");
  const confirmMessage = document.getElementById("confirmMessage");
  const confirmYesBtn = document.getElementById("confirmYesBtn");
  const confirmNoBtn = document.getElementById("confirmNoBtn");

  if (deleteTeamBtn) {
    deleteTeamBtn.addEventListener("click", () => {
      const teamId = teamSelectManage.value;
      const teamName = teamSelectManage.options[teamSelectManage.selectedIndex]?.text || '';
      if (!teamId) { showNotification("Selecione uma equipe para excluir.", "warning"); return; }
      confirmMessage.textContent = `Deseja apagar a equipe "${teamName}"? Essa alteração não pode ser revertida.`;
      if (confirmModal) confirmModal.style.display = "flex";
    });
  }

  if (confirmNoBtn) confirmNoBtn.addEventListener("click", () => { if (confirmModal) confirmModal.style.display = "none"; });

  async function deleteRecordsByTeamInBatches(teamId) {
    const BATCH_SIZE = 400;
    const recordsRef = collection(db, "records");
    while (true) {
      const q = query(recordsRef, where("teamId", "==", teamId), limit(BATCH_SIZE));
      const snap = await getDocs(q);
      if (snap.empty) break;
      const wb = writeBatch(db);
      snap.docs.forEach(docSnap => wb.delete(doc(db, "records", docSnap.id)));
      await wb.commit();
      if (snap.size < BATCH_SIZE) break;
    }
  }

  if (confirmYesBtn) {
    confirmYesBtn.addEventListener("click", async () => {
      const teamId = teamSelectManage.value;
      if (!teamId) { showNotification("Selecione uma equipe para excluir.", "warning"); return; }
      try {
        await setDoc(doc(db, "teams", teamId), {
          deleted: true,
          deletedAt: Timestamp.now(),
          deletedBy: currentUser.uid
        }, { merge: true });

        teamsCache.delete(teamId);
        serializeTeamsCache();
        rebuildTeamSelectsFromCache();

        // update local last-check to avoid immediate meta recheck
        localStorage.setItem(META_LAST_CHECK_KEY, String(Date.now()));

        if (confirmModal) confirmModal.style.display = "none";
        clearTeamForm();
        showNotification("Equipe marcada como apagada com sucesso!", "success");
      } catch (e) {
        console.error(e);
        if (confirmModal) confirmModal.style.display = "none";
        showNotification("Erro ao marcar equipe como apagada.", "error");
      }
    });
  }

  // --- dark mode init ---
  (function(){
    if (localStorage.getItem('dark') === '1') document.documentElement.classList.add('dark');
  })();
  window.addEventListener('storage', e => {
    if (e.key === 'dark') document.documentElement.classList.toggle('dark', e.newValue === '1');
  });

  // --- event triggers: visibility/online with debounce -> SWR reload ---
  let swrDebounce;
  const triggerLoadTeamsWithSWR = (delay = 400) => {
    clearTimeout(swrDebounce);
    swrDebounce = setTimeout(() => loadTeamsWithSWR(), delay);
  };
  document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') triggerLoadTeamsWithSWR(); });
  window.addEventListener('online', () => triggerLoadTeamsWithSWR(100));

  // --- Optional: create team lazy init button handler (if you add a button with id createTeamBtn in HTML) ---
  // cancelar (tanto criação quanto edição) -> esconde a área e limpa estado
const cancelCreateBtn = document.getElementById('cancelCreateTeamBtn');
if (cancelCreateBtn) {
  cancelCreateBtn.addEventListener('click', () => {
    // limpar form visível
    const teamNameInput = document.getElementById('teamName');
    if (teamNameInput) teamNameInput.value = '';
    const radioDiurno = document.querySelector('input[name="teamShift"][value="Diurno"]');
    if (radioDiurno) radioDiurno.checked = true;
    if (membersContainer) membersContainer.innerHTML = '';

    // reset do estado de edição
    editingTeamId = null;

    // esconder área e restaurar botão criar
    const createArea = document.getElementById('createTeamArea');
    const createBtn = document.getElementById('createTeamBtn');
    if (createArea) { createArea.classList.remove('show'); createArea.style.display = 'none'; }
    if (createBtn) { createBtn.style.display = ''; createBtn.disabled = false; }

    // reset texto do salvar
    if (saveTeamBtn) saveTeamBtn.textContent = 'Salvar Equipe';
    // opcional: também esconder o cancelCreateBtn (já será escondido quando area for escondida)
    cancelCreateBtn.style.display = 'none';
  });
}

  /* ------------- Criar Equipe: comportamento do botão (SEM leituras) ------------- */
(function setupCreateTeamButton() {
  const createBtn = document.getElementById('createTeamBtn');
  const createArea = document.getElementById('createTeamArea');
  const cancelCreateBtn = document.getElementById('cancelCreateTeamBtn');
  const teamNameInput = document.getElementById('teamName');

  if (!createBtn || !createArea) return;

  createBtn.addEventListener('click', () => {
    createBtn.disabled = true;
    const originalHtml = createBtn.innerHTML;
    createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando...';

    setTimeout(() => {
      createArea.classList.add('show');
      createArea.style.display = 'block';
      createBtn.style.display = 'none';
      createBtn.disabled = false;
      createBtn.innerHTML = originalHtml;

      if (teamNameInput) teamNameInput.focus();

      if (cancelCreateBtn) {
        cancelCreateBtn.style.display = 'inline-block';
        cancelCreateBtn.innerHTML = '<i class="fa-solid fa-xmark"></i> Cancelar Criação';
      }
    }, 260);
  });

  if (cancelCreateBtn) {
    cancelCreateBtn.addEventListener('click', () => {
      // limpar form visível
      if (teamNameInput) teamNameInput.value = '';
      const radioDiurno = document.querySelector('input[name="teamShift"][value="Diurno"]');
      if (radioDiurno) radioDiurno.checked = true;
      if (membersContainer) membersContainer.innerHTML = '';

      // reset do estado de edição
      editingTeamId = null;

      // esconder área e restaurar botão Criar
      createArea.classList.remove('show');
      createArea.style.display = 'none';
      const createBtnEl = document.getElementById('createTeamBtn');
      if (createBtnEl) { createBtnEl.style.display = ''; createBtnEl.disabled = false; }

      // esconder o cancel
      cancelCreateBtn.style.display = 'none';

      // reset texto do salvar
      if (saveTeamBtn) saveTeamBtn.textContent = 'Salvar Equipe';
    });
  }
})();

// helper para atualizar o botão de cancelar com ícone (usa innerHTML)
function setCancelButtonMode(mode) {
  // mode = 'create' | 'edit' | null
  const cancelBtn = document.getElementById('cancelCreateTeamBtn');
  if (!cancelBtn) return;

  if (mode === 'create') {
    cancelBtn.style.display = 'inline-block';
    cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancelar Criação';
    cancelBtn.setAttribute('aria-label', 'Cancelar Criação');
  } else if (mode === 'edit') {
    cancelBtn.style.display = 'inline-block';
    cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancelar Edição';
    cancelBtn.setAttribute('aria-label', 'Cancelar Edição');
  } else {
    cancelBtn.style.display = 'none';
    // não mexer no innerHTML aqui
  }
}

// mode: 'create' | 'edit' | null (null = fechar)
function showCreateArea(mode) {
  const createArea = document.getElementById('createTeamArea');
  const createBtn = document.getElementById('createTeamBtn');
  const saveBtn = document.getElementById('saveTeamBtn');

  if (mode === 'create') {
    editingTeamId = null;
    if (createArea) { createArea.style.display = 'block'; createArea.classList.add('show'); }
    if (createBtn) createBtn.style.display = 'none';
    setCancelButtonMode('create');
    if (saveBtn) saveBtn.textContent = 'Salvar Equipe';
    setTimeout(() => { const i = document.getElementById('teamName'); if (i) i.focus(); }, 30);
  } else if (mode === 'edit') {
    if (createArea) { createArea.style.display = 'block'; createArea.classList.add('show'); }
    if (createBtn) createBtn.style.display = 'none';
    setCancelButtonMode('edit');
    if (saveBtn) saveBtn.textContent = 'Atualizar Equipe';
    setTimeout(() => { const i = document.getElementById('teamName'); if (i) i.focus(); }, 30);
  } else {
    if (createArea) { createArea.style.display = 'none'; createArea.classList.remove('show'); }
    if (createBtn) createBtn.style.display = '';
    setCancelButtonMode(null);
    editingTeamId = null;
    if (saveBtn) saveBtn.textContent = 'Salvar Equipe';
  }
}

</script>

</body>
</html>
