<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Diário de Obra</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="icon" type="image/png" href="../favicon/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="../favicon/favicon.svg" />
<link rel="shortcut icon" href="../favicon/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="../favicon/apple-touch-icon.png" />
<link rel="manifest" href="../favicon/site.webmanifest" />
<link rel="stylesheet" href="../theme.css">
  <style>
     :root{
      --bg: #f5f7fa;
      --card: #ffffff;
      --text: #2c3e50;
      --accent: #2c3e50;
      --soft: #ccc;
      --text2: #34495e;
      --text-muted: #34495e;
      --accent-hover: #34495e;
      --hover-bg: #f7f9fb;
    }
  * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }

    body {
      display: flex;
      min-height: 100vh;
      background-color: var(--bg);
    }
    .sidebar {
      width: 220px;
      background: #2c3e50;
      color: #fff;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .dark .sidebar {
  background: var(--card);       /* #090b16 */
  color: var(--text);            /* #e0e0e0 */
  border-right: 1px solid var(--soft); /* #3c3f68 como linha */  
} 

.dark .sidebar a:hover,
.dark .sidebar a.active {
  background: var(--soft);       /* #3c3f68 */
}
    .hamburger {
      display: none;
      background: none;
      border: none;
      color: #fff;
      font-size: 24px;
      position: absolute;
      left: 0;
      cursor: pointer;
    }
    .logo {
      font-size: 24px;
      user-select: none;
    }
    nav ul {
      list-style: none;
      margin-top: 20px;
    }
    nav ul li {
      margin: 15px 0;
    }
    nav ul li a {
      text-decoration: none;
      color: #fff;
      display: flex;
      align-items: center;
      padding: 10px;
      border-radius: 4px;
      transition: background 0.2s;
    }
    nav ul li a i {
      margin-right: 10px;
    }
    nav ul li a.active,
    nav ul li a:hover {
      background: #34495e;
    }
    .main-content {
      flex: 1;
      padding: 30px;
    }
    header h2 {
      margin-bottom: 20px;
      color: var(--accent);
    }
    .dark header h2{
      background: rgba(92,124,250, .1);
      display: inline-block;
      padding: 6px 10px;
  border-radius: 4px;
    }
    .main-content {
      flex: 1;
      padding: 30px;
    }

    @media (max-width: 768px) {
  body {
    flex-direction: column;
  }
  .sidebar {
    width: 100%;
    padding: 15px;
    flex-direction: column; /* <--- mudou de row para column */
    align-items: center;
    justify-content: flex-start;
  }

  .sidebar-header {
    width: 100%;
    justify-content: center;
    position: relative;
  }

  .dark .sidebar {
      border-right: none !important;
      border-bottom: 1px solid var(--soft);
    }

  .hamburger {
    display: block;
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
  }

  .logo {
    font-size: 20px;
    text-align: center;
    width: 100%;
  }

  nav ul {
    width: 100%;
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transform-origin: top center;
    transform: translateY(-10px);
    transition: max-height 0.4s ease, opacity 0.4s ease, transform 0.4s ease;
    margin-top: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  nav ul.active {
    max-height: 600px;
    opacity: 1;
    transform: translateY(0);
  }

  .main-content {
    padding: 15px;
  }
    }

@media (max-width: 480px) {
  header h2 {
    font-size: 1.2rem;
  }
}

  /* Ajustes gerais */
label {
  font-weight: 600;
  color: var(--text2);
  display: block;
  margin-bottom: 1rem;
  text-transform: uppercase;
  font-size: 1.2rem;
}

label i{
  margin-right: 5px;
}

select {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid var(--soft);
  border-radius: 4px;
  margin-bottom: 16px;
  background-color: var(--bg);
  color: var(--text);
}

/* Botão PDF */
.pdf-btn {
  background: var(--accent);
  color: #fff;
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  font-size: 1rem;
  cursor: pointer;
  transition: background 0.3s, transform 0.3s;
  display: inline-flex;
  align-items: center;
  margin-bottom: 16px;
  margin-top: 1rem;
}

.pdf-btn i {
  margin-right: 8px;
  font-size: 1.2rem;
}

.pdf-btn:hover {
  background: var(--accent-hover);
  transform: translateY(-2px);
}

/* Notificação */
.notification {
  background: #f9f3c4;
  color: #856404;
  padding: 12px;
  margin-bottom: 20px;
  border-left: 6px solid #ffeeba;
  border-radius: 4px;
}

/* Preview geral */
.preview {
  background: var(--card);
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  margin-bottom: 24px;
}

.preview h3 {
  margin-top: 0;
  color: var(--text);
  display: flex;
  align-items: center;
  font-size: 1.25rem;
  margin-bottom: 10px;
}

.preview h3 i {
  margin-right: 10px;
  color: #2980b9;
}

/* Entradas de preview */
.preview-entry {
  padding: 15px;
  margin-bottom: 12px;
  border-radius: 6px;
  background: var(--bg);
  border: 1px solid #ececec;
  transition: background 0.3s;
}

.preview-entry:hover {
  background: var(--hover-bg);
}

.preview-entry .info {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}

.preview-entry .info div {
  display: flex;
  align-items: center;
  font-size: 0.95rem;
  color: var(--text);
}

.preview-entry .info div i {
  margin-right: 6px;
  color: #2980b9;
}

/* ===== RESPONSIVIDADE ===== */
@media (max-width: 768px) {
  /* Agrupa label+select em colunas */
  label, select {
    width: 100%;
  }

  /* Botão PDF ocupa toda largura */
  .pdf-btn {
    width: 100%;
    justify-content: center;
  }

  /* Preview com padding reduzido */
  .preview {
    padding: 16px;
  }

  .preview-entry {
    padding: 12px;
  }

  .preview-entry .info {
    flex-direction: column;
    gap: 8px;
  }
}

@media (max-width: 480px) {
  /* Fontes menores */
  .pdf-btn {
    font-size: 0.9rem;
    padding: 8px 16px;
  }

  .preview h3 {
    font-size: 1.1rem;
  }

  .preview-entry .info div {
    font-size: 0.9rem;
  }
}

#notificationMessage {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
  margin-bottom: 20px;
  font-size: 16px;
  color: var(--text);
  text-align: center;
}

#notificationMessage i {
  font-size: 32px;
  color: #2196f3;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background-color: #e0f7fa;
  box-sizing: border-box;
}

.notification-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.4);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.notification-content {
  background: var(--bg);
  padding: 25px 35px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  max-width: 400px;
  width: 90%; /* importante para responsividade */
  text-align: center;
  animation: fadeInUp 0.35s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  border-radius: 12px;
  border: 1px solid #ddd;
  box-sizing: border-box;
}

.notification-content p {
  margin-bottom: 20px;
  color: #222;
  font-size: 16px;
  line-height: 1.5;
  word-wrap: break-word; /* evita estouro de texto */
}

.notification-content button {
  background-color: var(--accent);
  transition: background-color 0.3s ease;
  color: white;
  padding: 8px 20px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  min-width: 80px;
}

.notification-content button:hover {
  background-color: #34495e;
}

.notification-content button:focus {
  outline-offset: 2px;
}

#notificationMessage i[style*="color:#28a745"] {
  background-color: #d4edda;
}

#notificationMessage i[style*="color:#dc3545"] {
  background-color: #f8d7da;
}

#notificationMessage i[style*="color:#ffc107"] {
  background-color: #fff8e1;
}

.dark #notificationMessage i {
  /* fundo neutro para ícones no dark mode */
  background-color: var(--badge-bg);
  color: var(--badge-text); /* se quiseres ícone claro por cima do fundo escuro */
}

/* Mantém os 'tints' por tipo (baseado nas cores inline atuais) — ajusta se preciso */
.dark #notificationMessage i[style*="color:#28a745"] { /* success */
  background-color: rgba(40,167,69,0.12);
}
.dark #notificationMessage i[style*="color:#dc3545"] { /* error */
  background-color: rgba(220,53,69,0.12);
}
.dark #notificationMessage i[style*="color:#ffc107"] { /* warning */
  background-color: rgba(255,193,7,0.08);
}
.dark #notificationMessage i[style*="color:#2196f3"] { /* info */
  background-color: rgba(33,150,243,0.10);
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Responsividade */

@media (max-width: 480px) {
  .notification-content {
    max-width: 95%;
    padding: 20px 20px;
  }

  .notification-content button {
    width: 30%;
    padding: 10px 0;
    font-size: 16px;
    min-width: unset;
  }
}

/* deixa input date com mesmo visual do select */
.select-like {
  padding: 8px 12px;
  border: 1px solid var(--soft);
  border-radius: 4px;
  background-color: var(--bg);
  color: var(--text);
  min-width: 220px;
  height: 38px;
  box-sizing: border-box;
  font-size: 0.95rem;
}

/* remove aparência nativa do date nos browsers (melhora visual) */
input[type="date"].select-like {
  appearance: none;
  -webkit-appearance: none;
}

/* ícone de calendário (alguns navegadores mostram seta — isso normal) */

/* botão limpar ao lado do date (pequeno) */
.clear-date-btn {
  background: var(--soft);
  color: #fff;
  border: none;
  padding: 6px 15px;
  border-radius: 6px;
  cursor: pointer;
  height: 38px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 6px rgba(0,0,0,0.04);
  transition: background .15s ease, transform .08s ease;
}

.clear-date-btn i { font-size: 0.95rem; }

/* hover */
.clear-date-btn:hover { background: #aeb6b6; transform: translateY(-1px); }

/* garante responsividade: empilha em telas pequenas */
@media (max-width: 640px) {
  .header > div[style] { width: 100%; }
  .select-like { min-width: 140px; }
}

/* Estilo para o campo de atividade */

#activityInput {
  width: 100%;
  padding: 10px 14px;
  border: 1px solid var(--soft);
  border-radius: 8px;
  font-size: 15px;
  outline: none;
  transition: all 0.3s ease;
  background-color: var(--card);
  color: var(--text);
  box-sizing: border-box;
  resize: none;
  height: 40px;
}

/* Placeholder mais suave */
#activityInput::placeholder {
  color: var(--text-muted);
}

/* Foco com efeito suave */
#activityInput:focus {
  border-color: var(--accent-hover);
  background-color: var(--hover-bg);
  box-shadow: 0 0 5px rgba(74, 144, 226, 0.4);
  color: var(--text);
}

/* Campo inválido (ex.: se quiser validar que não pode ficar vazio) */
#activityInput:invalid {
  border-color: #e74c3c;
  background-color: var(--card);
}

/* Responsividade */
@media (max-width: 600px) {
  #activityInput {
    font-size: 14px;
    padding: 8px 12px;
  }
}

.resp-mat-container {
  display: flex;
  align-items: flex-start;  /* mantém topo alinhado */
  gap: 12px;                /* controla a distância entre os dois blocos */
}

/* cada bloco (label + input) ocupa metade */
.resp-mat-container > div {
  flex: 1;                  /* divide igualmente */
  min-width: 0;             /* evita quebra estranha */
}

#responsavelInput, #matriculaInput {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--soft);
  border-radius: 8px;
  font-size: 15px;
  outline: none;
  transition: all 0.2s ease;
  background-color: var(--card);
  color: var(--text);
  box-sizing: border-box;
  height: 38px;
}

#responsavelInput:focus, #matriculaInput:focus {
  border-color: var(--accent-hover);
  box-shadow: 0 0 5px rgba(74,144,226,0.12);
}

/* garante que os labels vinculados aos inputs responsavel/matricula
   mantenham ícone e texto na mesma linha e alinhados verticalmente */
label[for="responsavelInput"],
label[for="matriculaInput"] {
  display: inline-flex;      /* mantém o label na linha e permite alinhamento flex */
  align-items: center;       /* alinha ícone e texto verticalmente */
  gap: 3px;                  /* espaço entre ícone e texto */
  white-space: nowrap;       /* evita quebra entre ícone e texto */
  margin-bottom: 6px;        /* reduz a margem se quiser (ajuste a gosto) */
}

/* pequeno ajuste no ícone quando usado nesses labels */
label[for="responsavelInput"] i,
label[for="matriculaInput"] i {
  display: inline-block;     /* garante comportamento inline previsível */
  line-height: 1;
  font-size: 0.95rem;        /* ajuste tamanho do ícone se necessário */
  vertical-align: middle;
}

@media (max-width: 640px) {
  /* empilha inputs em telas pequenas */
  .header > div[style] { width: 100%; }
}

</style>

</head>

<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <button id="toggleMenu" class="hamburger">
        <i class="fas fa-bars"></i>
      </button>
      <h1 class="logo">Estrutura</h1>
    </div>
    <nav>
      <ul id="menuList">
  <li>
    <a href="../dashboard.html">
      <i class="fas fa-file-signature"></i> Apropriações
    </a>
  </li>
  <li>
    <a href="../equipes/equipe.html">
      <i class="fas fa-users-cog"></i> Equipes
    </a>
  </li>
  <li>
    <a href="../apontamentos/apontamentos.html">
      <i class="fas fa-clipboard-list"></i> Apontamentos
    </a>
  </li>
  <li>
    <a href="./diario.html" class="active">
      <i class="fas fa-book"></i> Diário de obra
    </a>
  </li>
  <li>
    <a href="../efetivo/efetivo.html">
      <i class="fas fa-user-friends"></i> Efetivo
    </a>
  </li>
  <li>
    <a href="../anotar/anotar.html">
      <i class="fas fa-sticky-note" aria-hidden="true"></i> Anotações
    </a>
  </li>
  <li>
    <a href="#">
      <i class="fas fa-calendar-check"></i> Abono DSR
    </a>
  </li>
  <li>
  <a href="https://detroitbrasil.qforms.com.br/QuestionarioWeb/ResponderQuestionarioLink?chave=ADC929D335B064357179BDBAE1686855"
     target="_blank"
     rel="noopener noreferrer">
    <i class="fa-solid fa-shield-halved"></i> Observa+
  </a>
</li>
  <li>
    <a href="../configurações/configuracao.html">
      <i class="fas fa-cog"></i> Configurações
    </a>
  </li>
</ul>
    </nav>
  </div>

  <div class="main-content">
    <div class="header">
      <div>
        <label for="teamSelect"><i class="fas fa-users"></i>Equipe:</label>
        <select id="teamSelect">
          <option value="">-- Escolha uma equipe --</option>
        </select>
      </div>

      <div style="display:flex;flex-direction:column;margin-bottom: 1rem;">
        <label for="dateSelect"><i class="fas fa-calendar-day"></i>Data:</label>
        <div class="date-group" style="display:flex;gap:8px;align-items:center;">
          <input id="dateSelect" type="date" class="select-like" />
          <button id="clearDateBtn" class="clear-date-btn" title="Limpar data"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div style="min-width:300px;">
        <label for="activityInput"><i class="fas fa-tasks"></i>Atividade:</label>
        <textarea id="activityInput" placeholder="Descreva a atividade (Solda/Montagem)..." rows="2"></textarea>
        <div style="display:flex;flex-direction:column;gap:6px;min-width:260px;">
    <div style="display:flex;gap:8px; margin-top: 1rem;">
      <div style="flex:1;">
        <label for="responsavelInput"><i class="fas fa-user-check"></i>Responsável:</label>
        <input id="responsavelInput" type="text" placeholder="Nome do responsável" />
      </div>
      <div style="width:140px;">
        <label for="matriculaInput"><i class="fas fa-id-badge"></i>Matrícula:</label>
        <input id="matriculaInput" type="text" placeholder="Matricula" />
      </div>
    </div>
  </div>
      </div>
      <button id="downloadBtn" class="pdf-btn" disabled><i class="fa-solid fa-download"></i> Baixar PDF</button>
      </div>


    <div id="notification" class="notification" style="display:none;"><i class="fas fa-exclamation-circle"></i> Nenhuma equipe selecionada. Por favor, selecione uma para baixar o diário de obra.</div>

    <div class="preview">
      <h3><i class="fas fa-eye"></i> Pré-visualização do Diário</h3>
      <div id="previewContent" style="color:var(--text-muted);">Selecione uma equipe para ver os registros.</div>
    </div>
  </div>

  <div id="notificationModal" class="notification-modal" style="display:none;">
  <div class="notification-content">
    <p id="notificationMessage">
      <i class="fas fa-info-circle"></i>
      <!-- Texto da notificação será inserido aqui -->
    </p>
    <button id="notificationOkBtn">OK</button>
  </div>
</div>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
  // ===== FIREBASE =====
  const firebaseConfig = {
    apiKey: "AIzaSyDtnzixicBYAQkuoeB5tgCGpDLt1lByMZo",
    authDomain: "apropriacao-estrutura.firebaseapp.com",
    projectId: "apropriacao-estrutura",
    storageBucket: "apropriacao-estrutura.appspot.com",
    messagingSenderId: "155266586257",
    appId: "1:155266586257:web:6d70edc967cdbfc56e5130",
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ===== ESTADO =====
  let currentTeamId = '';
  let currentRecords = [];

  // ===== ELEMENTOS =====
  const teamSelect = document.getElementById('teamSelect');
  const downloadBtn = document.getElementById('downloadBtn');
  const notification = document.getElementById('notification');
  const previewContent = document.getElementById('previewContent');
  const dateSelect = document.getElementById('dateSelect');
  const clearDateBtn = document.getElementById('clearDateBtn');
  const activityInput = document.getElementById('activityInput');
  const responsavelInput = document.getElementById('responsavelInput');
const matriculaInput = document.getElementById('matriculaInput');


  // ===== AUTENTICAÇÃO =====
  auth.onAuthStateChanged(user => {
    if (!user) return window.location.href = './index.html';
    loadTeams(user.uid);
  });

  // ===== CARREGA EQUIPES (select) =====
  async function loadTeams(uid) {
    const snapshot = await db.collection('teams')
      .where('ownerUid', '==', uid)
      .get();
    snapshot.forEach(doc => {
      const data = doc.data();
      const option = document.createElement('option');
      option.value = doc.id;
      option.textContent = data.name || doc.id;
      teamSelect.appendChild(option);
    });
  }

  // ===== EVENTOS =====
  teamSelect.addEventListener('change', () => {
    currentTeamId = teamSelect.value;
    downloadBtn.disabled = !currentTeamId;
    notification.style.display = currentTeamId ? 'none' : 'block';
    fetchRecords();
  });

  dateSelect.addEventListener('change', fetchRecords);

  if (clearDateBtn) {
    clearDateBtn.addEventListener('click', () => {
      dateSelect.value = '';
      fetchRecords();
    });
  }

  if (activityInput) {
  activityInput.addEventListener('input', renderPreview);
}

if (responsavelInput) {
  responsavelInput.addEventListener('input', renderPreview);
}
if (matriculaInput) {
  matriculaInput.addEventListener('input', renderPreview);
}


  // ===== BUSCA REGISTROS (com suporte a dateOnly ou range) =====
  async function fetchRecords() {
    if (!auth.currentUser) return;
    if (!currentTeamId) {
      currentRecords = [];
      renderPreview();
      return;
    }

    let query = db.collection('records')
      .where('teamId', '==', currentTeamId)
      .where('createdBy', '==', auth.currentUser.uid);

    const selectedDate = dateSelect.value; // formato YYYY-MM-DD ou ''

    if (selectedDate) {
      // tenta dateOnly primeiro
      const snapshotDateOnly = await db.collection('records')
        .where('teamId', '==', currentTeamId)
        .where('createdBy', '==', auth.currentUser.uid)
        .where('dateOnly', '==', selectedDate)
        .limit(1)
        .get();

      if (!snapshotDateOnly.empty) {
        query = db.collection('records')
          .where('teamId', '==', currentTeamId)
          .where('createdBy', '==', auth.currentUser.uid)
          .where('dateOnly', '==', selectedDate)
          .orderBy('date', 'desc')
          .limit(200);
      } else {
        // range do dia
        const d = new Date(selectedDate + 'T00:00:00');
        const start = new Date(d); start.setHours(0,0,0,0);
        const end = new Date(d); end.setHours(23,59,59,999);
        const startTs = firebase.firestore.Timestamp.fromDate(start);
        const endTs = firebase.firestore.Timestamp.fromDate(end);

        query = db.collection('records')
          .where('teamId', '==', currentTeamId)
          .where('createdBy', '==', auth.currentUser.uid)
          .where('date', '>=', startTs)
          .where('date', '<=', endTs)
          .orderBy('date', 'desc')
          .limit(200);
      }
    } else {
      // sem data: últimos registros
      query = db.collection('records')
        .where('teamId', '==', currentTeamId)
        .where('createdBy', '==', auth.currentUser.uid)
        .orderBy('date', 'desc')
        .limit(200);
    }

    const snapshot = await query.get();
    currentRecords = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    renderPreview();
  }

  // ===== HELPERS PREVIEW =====
  function escapeHtml(str = '') {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }
  function nl2br(str = '') {
    return escapeHtml(str).replace(/\n/g, '<br>');
  }
  function getObservation(r) {
    return (r.obs || r.observacoes || r.observations || r.comentario || '').toString().trim();
  }

  // ===== RENDER PREVIEW (inclui Atividade) =====
function renderPreview() {
  const activityVal = (activityInput && activityInput.value) ? escapeHtml(activityInput.value.trim()) : '';
  const responsavelVal = (responsavelInput && responsavelInput.value) ? escapeHtml(responsavelInput.value.trim()) : '';
  const matriculaVal = (matriculaInput && matriculaInput.value) ? escapeHtml(matriculaInput.value.trim()) : '';
  const activityHtml = activityVal ? `<div style="padding:10px;border-radius:6px;background: var(--bg);margin-bottom:0.8rem; border: 1px solid #ececec;"><strong style="color: var(--text); background: color-mix(in srgb, var(--soft) 50%, transparent); padding: 5px; border-radius:6px;">Atividade:</strong> ${nl2br(activityVal)}</div>` : '';

  const respMatHtml = (responsavelVal || matriculaVal) ? `<div style="padding:8px;border-radius:6px;background: var(--bg); margin-bottom:0.6rem; border:1px solid #ececec; display:flex; gap:12px; align-items:center;"><div style="flex:1;"><strong>Responsável:</strong> ${responsavelVal || '-'}</div><div style="width:120px;"><strong>Matrícula:</strong> ${matriculaVal || '-'}</div></div>` : '';

  if (!currentRecords.length) {
    previewContent.innerHTML = activityHtml + '<i class="fas fa-info-circle"></i> Nenhum registro encontrado.';
    return;
  }

  const recordsHtml = currentRecords.map(r => {
    const date = r.date && r.date.seconds ? new Date(r.date.seconds * 1000).toLocaleString() : (r.date || '-');
    const obs = getObservation(r);
    return `
      <div class="preview-entry">
        <div class="info">
          <div><i class="fas fa-calendar-day"></i> ${escapeHtml(date)}</div>
          <div><i class="fas fa-user"></i> ${escapeHtml(r.name || '-')}</div>
          <div><i class="fas fa-id-badge"></i> ${escapeHtml(r.memberMatricula || '-')}</div>
          <div><i class="fas fa-map-marker-alt"></i> ${escapeHtml(r.local || '-')}</div>
          <div><i class="fas fa-warehouse"></i> ${escapeHtml(r.galpao || '-')}</div>
          <div><i class="fas fa-stream"></i> ${escapeHtml(r.details || '-')}</div>
          <div><i class="fas fa-layer-group"></i> ${escapeHtml(r.blockShift || '-')}</div>
          <div><i class="fas fa-ship"></i> ${escapeHtml(r.vesselShift || '-')}</div>
          ${obs ? `<div style="margin-top:6px"><i class="fas fa-clipboard"></i> ${nl2br(obs)}</div>` : ''}
        </div>
      </div>
    `;
  }).join('');

  previewContent.innerHTML = activityHtml + respMatHtml + recordsHtml;
}

  // ===== TEMPLATE PARA O PDF =====
  const templateUrl = './diario.jpg'; // coloque a imagem neste caminho ou ajuste

  async function loadImageAsDataURL(url) {
    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const blob = await res.blob();
      return await new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(blob);
      });
    } catch (err) {
      console.warn('loadImageAsDataURL falhou:', err);
      return null;
    }
  }

  // ===== GERAÇÃO DO PDF (ALINHADO AO TEMPLATE) =====
  async function generatePdfFromDaily(daily, { debugMode = false } = {}) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'pt', format: 'a4' });
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();

    // carrega imagem do template
    const imgData = await loadImageAsDataURL(templateUrl);

    // ------ parâmetros calibrados (ajuste se necessário) ------
    const marginLeft = 44;
    const headerY = 76;
    const galpaoX = 180;               // posição 'Galpão' (x)
    const dateX = pageW - 180;         // posição 'Data' (x)
    const dateY = headerY - 11;        // posição 'Data' (y)
    const yTableStart = 134;           // início da tabela de matrícula/nome
    const rowHeight = 12;              // altura fixa entre linhas (mantém alinhamento)
    const rowsPerColumn = 28;          // linhas por coluna antes de ir pra direita/página nova
    const leftMatX = 60;
    const leftNameX = leftMatX + 44;
    const rightMatX = Math.round(pageW / 2) + 8;
    const rightNameX = rightMatX + 58;
    const nameColWidth = Math.round((pageW / 2) - (leftNameX - marginLeft) - 40);
    const yObsStart = 400;
    const obsLineHeight = 8;

    function drawTemplate() {
      if (imgData) {
        try { doc.addImage(imgData, 'JPEG', 0, 0, pageW, pageH); }
        catch (e) { doc.setFillColor(255,255,255); doc.rect(0,0,pageW,pageH,'F'); }
      } else {
        doc.setFillColor(255,255,255); doc.rect(0,0,pageW,pageH,'F');
      }
    }

    function getSingleLineName(text, maxWidth){
      const arr = doc.splitTextToSize(String(text || ''), maxWidth);
      if (!arr.length) return '-';
      let first = arr[0];
      if (arr.length > 1) {
        while (doc.getTextWidth(first + '…') > maxWidth && first.length > 0) first = first.slice(0, -1);
        first = first + '…';
      }
      return first;
    }

    // formatação inicial
    doc.setFont('Helvetica', 'normal');
    doc.setFontSize(10);
    doc.setTextColor(0,0,0);

    // primeira página com template
    drawTemplate();

    let displayDate = (daily.dateOnly || '');
  if (/^\d{4}-\d{2}-\d{2}$/.test(displayDate)) {
    const [y, m, d] = displayDate.split('-');
    displayDate = `${d}/${m}/${y}`;
  } else if (!displayDate && daily.date && typeof daily.date === 'object' && (daily.date.seconds || daily.date._seconds)) {
    const seconds = daily.date.seconds || daily.date._seconds;
    const dt = new Date(seconds * 1000);
    displayDate = dt.toLocaleDateString('pt-BR');
  } else if (displayDate && displayDate.includes('-') && displayDate.split('-')[0].length === 4) {
    const parts = displayDate.split('-').map(p => p.padStart(2,'0'));
    if (parts.length >= 3) displayDate = `${parts[2]}/${parts[1]}/${parts[0]}`;
  }
  if (!displayDate) displayDate = '-';

  // escreve Galpão (usa headerY) e Data (usa dateY)
  doc.setFontSize(11);
  doc.text(String(daily.galpao || '-'), galpaoX, headerY);
  doc.text(String(displayDate), dateX, dateY);
  doc.setFontSize(10);

  // ===== ATIVIDADE (posicione ajustando activityX e activityY) =====
const activityX = marginLeft + 385;     // <<< ajuste horizontal aqui
const activityY = headerY + 0;   // <<< ajuste vertical aqui (ex.: 18, 28, 40, ...)

const respX = marginLeft + 60;        // posição horizontal do responsável (ajuste)
const respY = headerY + 12;
const gapBetweenCols = 12;             // espaço entre coluna responsavel e matricula
const respMaxWidth = 200;              // <<< largura máxima (px) do RESPONSÁVEL — ajuste
const matMaxWidth = 120;               // <<< largura máxima (px) da MATRÍCULA — ajuste
const matX = respX + respMaxWidth + gapBetweenCols; // posicionado à direita do resp
const gap = 10;                // distância entre final do nome e início da matrícula
const rightMargin = 44;        // margem direita (mesma que marginLeft)

let tableStartY = yTableStart;    // começa onde sempre começava...

if (daily.activity) {
  const maxWidth = pageW - marginLeft * 2;   // largura útil
  const lineHeight = 12;                     // altura de linha (ajuste se quiser)
  const lines = doc.splitTextToSize(String(daily.activity), maxWidth);

  // desenha a atividade
  for (let i = 0; i < lines.length; i++) {
    doc.text(lines[i], activityX, activityY + i * lineHeight);
  }

  const respText = String(daily.responsavel || '');
const matText = String(daily.matricula || '');

function truncateOneLine(text, maxW) {
  const s = String(text || '');
  if (doc.getTextWidth(s) <= maxW) return s;
  let out = s;
  while (out.length > 0 && doc.getTextWidth(out + '…') > maxW) out = out.slice(0, -1);
  return out.length ? out + '…' : '…';
}

// largura do nome (na fonte atual)
let respWidth = doc.getTextWidth(respText);

// largura disponível total até margem direita onde matrícula não pode ultrapassar
const maxMatAnchorX = pageW - rightMargin - matMaxWidth; // X máximo onde matrícula pode começar

// posição proposta da matrícula logo após o nome
let desiredMatX = Math.ceil(respX + respWidth + gap);

// clamp: matrícula não pode começar depois do max disponível
let matX = Math.min(desiredMatX, maxMatAnchorX);

// se matX foi reduzido pelo clamp, precisamos garantir que o nome caiba até matX - gap
const respAllowedWidth = Math.max(8, matX - gap - respX);

// se o nome original é maior que o permitido, trunca
let respToDraw = respText;
if (doc.getTextWidth(respText) > respAllowedWidth) {
  respToDraw = truncateOneLine(respText, respAllowedWidth);
  respWidth = doc.getTextWidth(respToDraw); // atualiza largura do que será desenhado
  // recomputa posição da matrícula logo após o nome truncado (protege contra off-by-one)
  desiredMatX = Math.ceil(respX + respWidth + gap);
  matX = Math.min(desiredMatX, maxMatAnchorX);
}

// finalmente trunca a matrícula também caso ela exceda matMaxWidth
const matToDraw = truncateOneLine(matText || '-', matMaxWidth);

// desenha (uma linha cada)
doc.text(respToDraw || '-', respX, respY);
doc.text(matToDraw || '-', matX, respY);

// atualiza altura ocupada para empurrar tabela se necessário
const respMatHeight = lineHeight; // estamos em uma linha só
tableStartY = Math.max(tableStartY, respY + respMatHeight + 8);
}

    // Preenche tabela em duas colunas (uma linha por registro para manter grade)
    let col = 0, rowIndex = 0, y = tableStartY;
    for (let i = 0; i < (daily.members || []).length; i++) {
      const m = daily.members[i];
      const targetMatX = (col === 0) ? leftMatX : rightMatX;
      const targetNameX = (col === 0) ? leftNameX : rightNameX;

      if (rowIndex >= rowsPerColumn) {
        if (col === 0) { col = 1; rowIndex = 0; y = yTableStart; }
        else {
          doc.addPage();
          drawTemplate();
          doc.setFontSize(11);
          doc.text(String(daily.galpao || '-'), galpaoX, headerY);
          doc.text(String(daily.dateOnly || '-'), dateX, headerY);
          doc.setFontSize(10);
          col = 0; rowIndex = 0; y = yTableStart;
        }
      }

      const matText = String(m.matricula || m.memberMatricula || '-');
      const nameText = getSingleLineName(m.name || '-', nameColWidth);

      doc.setFontSize(10);
      doc.text(matText, targetMatX, y + 3);
      doc.text(nameText, targetNameX, y + 3);

      y += rowHeight;
      rowIndex++;
    }

    // OBSERVAÇÕES DIÁRIAS: cada observação numerada em sua própria entrada
    let currentYObs = yObsStart;
    doc.setFontSize(10);

    const observations = [];
    for (let i = 0; i < (daily.members || []).length; i++) {
      const m = daily.members[i];
      const parts = [];
      if (m.name) parts.push(m.name);
      if (m.matricula) parts.push(`Mat: ${m.matricula}`);
      if (m.local) parts.push(m.local);
      const details = [];
      if (m.blockShift) details.push(`Bloco: ${m.blockShift}`);
      if (m.vesselShift) details.push(`Embarcação: ${m.vesselShift}`);
      if (m.details) details.push(m.details);
      if (m.obs) details.push(m.obs);
      if (details.length) parts.push(details.join(' — '));
      const txt = parts.join(' / ').trim();
      if (txt) observations.push(txt);
    }

    for (let idx = 0; idx < observations.length; idx++) {
      const raw = observations[idx];
      const wrapped = doc.splitTextToSize(raw, pageW - marginLeft * 2 - 12);
      const prefix = (idx + 1) + '. ';
      const prefixWidth = doc.getTextWidth(prefix);

      if (currentYObs + wrapped.length * obsLineHeight > pageH - 40) {
        doc.addPage();
        drawTemplate();
        doc.setFontSize(11);
        doc.text(String(daily.galpao || '-'), galpaoX, headerY);
        doc.text(String(daily.dateOnly || '-'), dateX, headerY);
        doc.setFontSize(10);
        currentYObs = yObsStart;
      }

      const firstLine = wrapped[0] || '';
      doc.text(prefix + firstLine, marginLeft, currentYObs);
      currentYObs += obsLineHeight;

      for (let j = 1; j < wrapped.length; j++) {
        doc.text(wrapped[j], marginLeft + prefixWidth, currentYObs);
        currentYObs += obsLineHeight;
      }
      currentYObs += 4;
    }

    const safeTeam = (daily.teamId || 'team').replace(/[^a-z0-9_-]/ig,'');
    const safeDate = (daily.dateOnly || 'date').replace(/[^0-9_-]/g,'');
    const fileName = `diario_${safeTeam}_${safeDate}.pdf`;
    doc.save(fileName);
  }

  // ===== MONTA DAILY E CHAMA GERAÇÃO =====
  async function downloadDailyPdf(teamId, dateOnly, options = { debugMode: false }) {
    if (!teamId || !dateOnly) {
      showNotification('Selecione equipe e data antes de baixar.', 'warning');
      return;
    }

    // garante que as informações estejam atualizadas
    await fetchRecords();

    const members = (currentRecords || []).map(r => ({
      name: r.name || '',
      matricula: r.memberMatricula || r.matricula || '',
      local: r.local || '',
      galpao: r.galpao || '',
      details: r.details || '',
      blockShift: r.blockShift || r.block || '',
      vesselShift: r.vesselShift || r.vessel || '',
      obs: (r.obs || r.observacoes || r.comentario || '') || ''
    }));

    if (!members.length) {
      showNotification('Nenhum registro encontrado para essa equipe/data.', 'info');
      return;
    }

    const activityVal = (activityInput && activityInput.value) ? activityInput.value.trim() : '';
    const responsavelVal = (responsavelInput && responsavelInput.value) ? responsavelInput.value.trim() : '';
const matriculaVal = (matriculaInput && matriculaInput.value) ? matriculaInput.value.trim() : '';

const daily = {
  teamId,
  teamName: (document.getElementById('teamSelect').selectedOptions[0] || {}).text || '',
  dateOnly,
  galpao: (members[0] && members[0].galpao) || '',
  activity: activityVal,   // <-- acrescentado
  responsavel: responsavelVal,
  matricula: matriculaVal,
  members
};

    await generatePdfFromDaily(daily, { debugMode: options.debugMode });
  }

  // ===== BOTÃO DOWNLOAD =====
  const downloadButton = document.getElementById('downloadBtn');
  downloadButton.addEventListener('click', async () => {
    const teamId = (document.getElementById('teamSelect') || {}).value;
    const dateOnly = (document.getElementById('dateSelect') || {}).value;

    if (!teamId) { showNotification('Por favor selecione uma equipe antes de baixar o PDF.', 'warning'); return; }
    if (!dateOnly) { showNotification('Por favor selecione uma data antes de baixar o PDF.', 'warning'); return; }

    await fetchRecords();
    await downloadDailyPdf(teamId, dateOnly, { debugMode: false });
  });

  // ===== HAMBURGER / DARK MODE (compat) =====
  try {
    const toggleMenuBtn = document.getElementById("toggleMenu");
    const menuList = document.getElementById("menuList");
    if (toggleMenuBtn && menuList) {
      toggleMenuBtn.addEventListener("click", () => menuList.classList.toggle("active"));
    }
  } catch(e){/* não crítico */}

  (function(){
    if (localStorage.getItem('dark') === '1') document.documentElement.classList.add('dark');
  })();
  window.addEventListener('storage', e => {
    if (e.key === 'dark') document.documentElement.classList.toggle('dark', e.newValue === '1');
  });

  // ===== NOTIFICAÇÕES (modal) =====
  const icons = {
    success: '<i class="fas fa-check-circle" style="color:#28a745;"></i>',
    error: '<i class="fas fa-times-circle" style="color:#dc3545;"></i>',
    warning: '<i class="fas fa-exclamation-triangle" style="color:#ffc107;"></i>',
    info: '<i class="fas fa-info-circle" style="color:#2196f3;"></i>',
  };

  function showNotification(message, type = "info") {
    const modal = document.getElementById("notificationModal");
    const msg = document.getElementById("notificationMessage");
    const okBtn = document.getElementById("notificationOkBtn");
    if (!modal || !msg || !okBtn) { alert(message); return; }

    msg.innerHTML = icons[type] + '<span style="margin-left:8px">' + message + '</span>';
    modal.style.display = "flex";
    okBtn.focus();
    okBtn.onclick = () => modal.style.display = "none";
  }

  const modal = document.getElementById("notificationModal");
  if (modal) {
    modal.addEventListener("click", (e) => { if (e.target === modal) modal.style.display = "none"; });
    document.addEventListener("keydown", (e) => { if (e.key === "Escape" && modal.style.display === "flex") modal.style.display = "none"; });
  }
</script>

</body>

</html>
